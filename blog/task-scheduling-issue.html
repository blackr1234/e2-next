<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" as="image" href="/e2-next/nextjs.svg"/><link rel="stylesheet" href="/e2-next/_next/static/css/8b3b49f5a80261a3.css" data-precedence="next"/><link rel="stylesheet" href="/e2-next/_next/static/css/d3df112486f97f47.css" data-precedence="next"/><link rel="stylesheet" href="/e2-next/_next/static/css/47422044c9b2dd2c.css" data-precedence="next"/><link rel="stylesheet" href="/e2-next/_next/static/css/7bfe9ed714480baa.css" data-precedence="next"/><link rel="stylesheet" href="/e2-next/_next/static/css/caf337e7effc00c7.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/e2-next/_next/static/chunks/webpack-be2cb7090e4daa20.js"/><script src="/e2-next/_next/static/chunks/4bd1b696-0937feffdffed3be.js" async=""></script><script src="/e2-next/_next/static/chunks/1517-a3b83c9dd920ca02.js" async=""></script><script src="/e2-next/_next/static/chunks/main-app-05c45cc8f30d6cea.js" async=""></script><script src="/e2-next/_next/static/chunks/7833-c0135c68ec6a11ed.js" async=""></script><script src="/e2-next/_next/static/chunks/app/layout-3655101740c91656.js" async=""></script><script src="/e2-next/_next/static/chunks/app/page-63c121085425a904.js" async=""></script><script src="/e2-next/_next/static/chunks/13b76428-e7d338032a603c0d.js" async=""></script><script src="/e2-next/_next/static/chunks/5496-1fb0b443dfc588c1.js" async=""></script><script src="/e2-next/_next/static/chunks/app/blog/(blogPosts)/layout-b960ed9b018b1aae.js" async=""></script><title>Blog posts</title><meta name="description" content="Powered by Next.js and React"/><link rel="icon" href="/e2-next/favicon.ico" type="image/x-icon" sizes="48x48"/><link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&amp;display=swap" rel="stylesheet"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"/><script src="/e2-next/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body><div class="vstack gap-5"><div class="text-center vstack gap-5"><div class="Ribbon_ribbon-left__fObbI"><img class="Ribbon_image__2_FYh" src="/e2-next/nextjs.svg"/></div><a role="button" tabindex="0" href="https://blackr1234.github.io/e2/" class="ButtonToOtherSites_button__K4zwN btn btn-secondary btn-sm">➜ Old React website</a><div><code class="SiteHeader_name__pxX08">Chung Cheuk Hang Michael</code><code class="SiteHeader_title__MUwhy">Java Web Developer</code></div><nav style="margin-top:-1.5rem;margin-bottom:-1rem" class="justify-content-center navbar navbar-expand-md navbar-dark"><button type="button" aria-label="Toggle navigation" class="navbar-toggler collapsed"><span class="navbar-toggler-icon"></span></button><div class="justify-content-center navbar-collapse collapse"><div class="justify-content-center navbar-nav nav-underline"><div class="nav-item"><a href="/e2-next/" draggable="false" data-rr-ui-event-key="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/e2-next/work" draggable="false" data-rr-ui-event-key="/work" class="nav-link">Work</a></div><div class="nav-item"><a href="/e2-next/hobbyProjects" draggable="false" data-rr-ui-event-key="/hobbyProjects" class="nav-link">Hobby projects</a></div><div class="nav-item"><a href="/e2-next/personality" draggable="false" data-rr-ui-event-key="/personality" class="nav-link">Personality</a></div><div class="nav-item"><a href="/e2-next/blog" draggable="false" data-rr-ui-event-key="/blog" class="nav-link">Blog</a></div></div></div></nav></div><div class="vstack gap-5"><div style="display:flex;justify-content:space-between"><a role="button" tabindex="0" href="/e2-next/blog/java-collections-generic-type-covariance" class="layout_next-button__HNNsZ btn btn-primary btn-sm"><i class="fa-solid fa-arrow-left"></i><span class="layout_responsive-button-text__Z1usr" style="margin-left:0.75rem"><strong>Java collections 進階 - generic type 同 covariance</strong></span></a><a role="button" tabindex="0" href="/e2-next/blog/js-advanced-syntax" class="layout_prev-button__uHSER btn btn-primary btn-sm"><span class="layout_responsive-button-text__Z1usr" style="margin-right:0.75rem"><strong>進階 JavaScript</strong></span><i class="fa-solid fa-arrow-right"></i></a></div><div class="justify-content-center row"><h1 class="text-center" style="margin-bottom:1rem"><strong>低級 task scheduling 錯誤</strong></h1></div><div class="justify-content-center row"><img loading="lazy" src="/e2-next/blog/2021-06/task-scheduling-issue/thumbnail.svg?v=202502" class="object-fit-contain layout_image__iOEk8"/></div><div class="row"><div style="word-wrap:break-word"><a href="#1-背景" style="text-decoration:none"><h1 id="1-背景" class="mdx-components_heading__HrNl3 mdx-components_heading-new-section__YU39B" style="z-index:1000000"><i class="fa-solid fa-link mdx-components_heading-link__r6M6c"></i>1 背景</h1></a>
<a href="#11-項目" style="text-decoration:none"><h2 id="11-項目" class="mdx-components_heading__HrNl3 mdx-components_heading-sub-section__AJ2JK" style="z-index:1010000"><i class="fa-solid fa-link mdx-components_heading-link__r6M6c"></i>1.1 項目</h2></a>
<div class="mdx-components_paragraph__AUxxF">話說我寫呢篇文章果陣做緊既公司畀某昆蟲公司收購左之後，就要做大量 revamp 工作，亦包括滿足新既業務需求。眾多個系統當中，有一個負責定時定候 call Amazon、ebay 等等既平台既 back-end application，今年加入左 pull Amazon MWS data 既 task scheduling，主要為每一個商戶客既每一個店舖 pull Amazon MWS data。</div>
<div class="mdx-components_paragraph__AUxxF">呢個項目要 call <code class="undefined mdx-components_inline-code__y_QeQ">10</code> 個 Amazon MWS 既 API。</div>
<hr class="mdx-components_hr__o_oFr"/>
<a href="#12-資料庫設計" style="text-decoration:none"><h2 id="12-資料庫設計" class="mdx-components_heading__HrNl3 mdx-components_heading-sub-section__AJ2JK" style="z-index:1020000"><i class="fa-solid fa-link mdx-components_heading-link__r6M6c"></i>1.2 資料庫設計</h2></a>
<div class="mdx-components_paragraph__AUxxF">DB 設計上做左 partition，分庫分表（for horizontal scaling）：</div>
<ul>
<li class="mdx-components_list-item__fJ1NL">Sharing rule：所有 DB tables 根據 user ID 既 value 做 sharding——某兩個位既數字會用黎對應 partition index</li>
<li class="mdx-components_list-item__fJ1NL">一共分成 <code class="undefined mdx-components_inline-code__y_QeQ">100</code> 個 partitions</li>
<li class="mdx-components_list-item__fJ1NL">所有 table 資料都由 <code class="undefined mdx-components_inline-code__y_QeQ">10</code> 個 physical DB、每個 physical DB 各自有 <code class="undefined mdx-components_inline-code__y_QeQ">10</code> 個 physical tables 組成（<code class="undefined mdx-components_inline-code__y_QeQ">10</code> DB 乘 <code class="undefined mdx-components_inline-code__y_QeQ">10</code> tables = <code class="undefined mdx-components_inline-code__y_QeQ">100</code> partitions）</li>
<li class="mdx-components_list-item__fJ1NL">例如：<code class="undefined mdx-components_inline-code__y_QeQ">db3</code> 有 <code class="undefined mdx-components_inline-code__y_QeQ">table1_30</code> 至 <code class="undefined mdx-components_inline-code__y_QeQ">table1_39</code> 以及 <code class="undefined mdx-components_inline-code__y_QeQ">table2_30</code> 至 <code class="undefined mdx-components_inline-code__y_QeQ">table2_39</code></li>
</ul>
<div class="mdx-components_paragraph__AUxxF">Schema 既設計：</div>
<ul>
<li class="mdx-components_list-item__fJ1NL">以 Amazon MWS API 黎分，有 <code class="undefined mdx-components_inline-code__y_QeQ">10</code> 個 logical tables，另外有其他 tables 負責 keep track 住 task scheduling</li>
</ul>
<hr class="mdx-components_hr__o_oFr"/>
<a href="#13-task-scheduling-機制" style="text-decoration:none"><h2 id="13-task-scheduling-機制" class="mdx-components_heading__HrNl3 mdx-components_heading-sub-section__AJ2JK" style="z-index:1030000"><i class="fa-solid fa-link mdx-components_heading-link__r6M6c"></i>1.3 Task scheduling 機制</h2></a>
<div class="mdx-components_paragraph__AUxxF">Task scheduling 既機制：</div>
<ul>
<li class="mdx-components_list-item__fJ1NL">Scheduler server 會根據平台上面 scheduled job 既時間配置，定時定候 send message 去 cluster 裡面其中一機器</li>
</ul>
<div class="mdx-components_paragraph__AUxxF">而 cluster 裡面既每一部機器既系統設計係咁：</div>
<ul>
<li class="mdx-components_list-item__fJ1NL">系統引入「三層分發」機制黎實現 distributed task scheduling</li>
<li class="mdx-components_list-item__fJ1NL">第一層：<code class="undefined mdx-components_inline-code__y_QeQ">split</code>
<ul>
<li class="mdx-components_list-item__fJ1NL">Cluster 裡面只會有一部機器收到 scheduler server 既指令</li>
<li class="mdx-components_list-item__fJ1NL">佢之後會做 split partitions 動作，將 <code class="undefined mdx-components_inline-code__y_QeQ">100</code> 個 partition indexes 派畀 cluster 裡面既所有機器</li>
<li class="mdx-components_list-item__fJ1NL">每部機器得到既果堆 partition indexes 可以係隨機</li>
<li class="mdx-components_list-item__fJ1NL">平均黎講每部機器會收到 <code class="undefined mdx-components_inline-code__y_QeQ">10</code> 個 partitions</li>
<li class="mdx-components_list-item__fJ1NL">例如：<code class="undefined mdx-components_inline-code__y_QeQ">instance3</code> 收到 <code class="undefined mdx-components_inline-code__y_QeQ">30</code> 至 <code class="undefined mdx-components_inline-code__y_QeQ">39</code> 既 partition indexes</li>
</ul>
</li>
<li class="mdx-components_list-item__fJ1NL">第二層：<code class="undefined mdx-components_inline-code__y_QeQ">load</code>
<ul>
<li class="mdx-components_list-item__fJ1NL">當每部機器收到一堆 partition indexes，就會喺呢堆 partition indexes 指定既 physical DB 度 select task records</li>
<li class="mdx-components_list-item__fJ1NL">目前既設定 hardcode 左係只拎最新創建既 <code class="undefined mdx-components_inline-code__y_QeQ">5</code> 筆 task records</li>
<li class="mdx-components_list-item__fJ1NL">拎到 task records 之後就再派畀 cluster 裡面既所有機器</li>
</ul>
</li>
<li class="mdx-components_list-item__fJ1NL">第三層：<code class="undefined mdx-components_inline-code__y_QeQ">execute</code>
<ul>
<li class="mdx-components_list-item__fJ1NL">當每部機器收到 task record，就會加落 thread pool 度，等待處理</li>
</ul>
</li>
</ul>
<hr class="mdx-components_hr__o_oFr"/>
<a href="#14-production-場既配置" style="text-decoration:none"><h2 id="14-production-場既配置" class="mdx-components_heading__HrNl3 mdx-components_heading-sub-section__AJ2JK" style="z-index:1040000"><i class="fa-solid fa-link mdx-components_heading-link__r6M6c"></i>1.4 Production 場既配置</h2></a>
<div class="mdx-components_paragraph__AUxxF">Production 場既 cluster 部署左 <code class="undefined mdx-components_inline-code__y_QeQ">10</code> 部機器。</div>
<hr class="mdx-components_hr__o_oFr"/>
<a href="#15-任務配置" style="text-decoration:none"><h2 id="15-任務配置" class="mdx-components_heading__HrNl3 mdx-components_heading-sub-section__AJ2JK" style="z-index:1050000"><i class="fa-solid fa-link mdx-components_heading-link__r6M6c"></i>1.5 任務配置</h2></a>
<div class="mdx-components_paragraph__AUxxF">呢個項目有 <code class="undefined mdx-components_inline-code__y_QeQ">2</code> 個任務：</div>
<ul>
<li class="mdx-components_list-item__fJ1NL">創建 task<!-- -->
<ul>
<li class="mdx-components_list-item__fJ1NL">每 <code class="undefined mdx-components_inline-code__y_QeQ">1</code> 分鐘執行一次</li>
<li class="mdx-components_list-item__fJ1NL">如果店舖既某個 Amazon MWS API 唔存在執行中既任務（例如已經執行完成），就會創建新 task，即係永無休止咁 pull data</li>
<li class="mdx-components_list-item__fJ1NL">每個 Amazon MWS API 都會有一個 task</li>
<li class="mdx-components_list-item__fJ1NL">每個 API 都係每隔 <code class="undefined mdx-components_inline-code__y_QeQ">10</code> 分鐘 call 一次</li>
<li class="mdx-components_list-item__fJ1NL">啲 API 分散喺唔同既分鐘（唔同既個位數），唔會同一分鐘做曬 <code class="undefined mdx-components_inline-code__y_QeQ">10</code> 個 API</li>
<li class="mdx-components_list-item__fJ1NL">例如：<!-- -->
<ul>
<li class="mdx-components_list-item__fJ1NL"><code class="undefined mdx-components_inline-code__y_QeQ">api-3</code> 既執行時間係 <code class="undefined mdx-components_inline-code__y_QeQ">HH:03</code>、<code class="undefined mdx-components_inline-code__y_QeQ">HH:13</code>、<code class="undefined mdx-components_inline-code__y_QeQ">HH:23</code>、<code class="undefined mdx-components_inline-code__y_QeQ">HH:33</code>、<code class="undefined mdx-components_inline-code__y_QeQ">HH:43</code>、<code class="undefined mdx-components_inline-code__y_QeQ">HH:53</code></li>
<li class="mdx-components_list-item__fJ1NL"><code class="undefined mdx-components_inline-code__y_QeQ">api-5</code> 既執行時間係 <code class="undefined mdx-components_inline-code__y_QeQ">HH:05</code>、<code class="undefined mdx-components_inline-code__y_QeQ">HH:15</code>、<code class="undefined mdx-components_inline-code__y_QeQ">HH:25</code>、<code class="undefined mdx-components_inline-code__y_QeQ">HH:35</code>、<code class="undefined mdx-components_inline-code__y_QeQ">HH:45</code>、<code class="undefined mdx-components_inline-code__y_QeQ">HH:55</code></li>
<li class="mdx-components_list-item__fJ1NL">如此類推</li>
</ul>
</li>
</ul>
</li>
<li class="mdx-components_list-item__fJ1NL">處理 task<!-- -->
<ul>
<li class="mdx-components_list-item__fJ1NL">每 <code class="undefined mdx-components_inline-code__y_QeQ">1</code> 分鐘執行一次</li>
<li class="mdx-components_list-item__fJ1NL">只要 task 到左預定執行時間，就會處理</li>
<li class="mdx-components_list-item__fJ1NL">目前既設定 hardcode 左係只拎最新創建既 <code class="undefined mdx-components_inline-code__y_QeQ">5</code> 筆 task records（每個 partition 都係咁）</li>
</ul>
</li>
</ul>
<div class="mdx-components_paragraph__AUxxF">Scheduler server 每分鐘都會 send messages 去負責 split 既機器度 trigger 呢 <code class="undefined mdx-components_inline-code__y_QeQ">2</code> 個 <em>producer &amp; consumer</em> 既任務。</div>
<hr class="mdx-components_hr__o_oFr"/>
<a href="#2-上線後出現既問題" style="text-decoration:none"><h1 id="2-上線後出現既問題" class="mdx-components_heading__HrNl3 mdx-components_heading-new-section__YU39B" style="z-index:2000000"><i class="fa-solid fa-link mdx-components_heading-link__r6M6c"></i>2 上線後出現既問題</h1></a>
<div class="mdx-components_paragraph__AUxxF">呢個 project 最近上左線，onboard 左一部分商戶既店舖 records，但就出現左一個都幾尷尬既問題。</div>
<div class="mdx-components_paragraph__AUxxF">項目群組裡面有人話發現唔同既 Amazon MWS API 既 logical tables 出現既結果不一，某啲店舖喺某啲 tables 有 Amazon data records，但喺某啲 tables 就冇。</div>
<div class="mdx-components_paragraph__AUxxF">查一查 logical DB，睇見啲 task records 既預定執行時間係幾日前，呢啲 task records 明明應該已經執行左但就唔知點解一直冇執行到。</div>
<div class="mdx-components_paragraph__AUxxF">另外，有部分 tasks 執行失敗。</div>
<hr class="mdx-components_hr__o_oFr"/>
<a href="#3-原因分析" style="text-decoration:none"><h1 id="3-原因分析" class="mdx-components_heading__HrNl3 mdx-components_heading-new-section__YU39B" style="z-index:3000000"><i class="fa-solid fa-link mdx-components_heading-link__r6M6c"></i>3 原因分析</h1></a>
<div class="mdx-components_paragraph__AUxxF">Logical DB 裡面見到一堆應該已經執行但一直冇執行既 records 係黎自某幾個 partitions，而呢幾個 partitions 都有一個共通點，就係店舖數量大過 <code class="undefined mdx-components_inline-code__y_QeQ">5</code>。</div>
<div class="mdx-components_paragraph__AUxxF">呢個其實係一個數學既問題。</div>
<div class="mdx-components_paragraph__AUxxF">首先，我地先假設 pull data 既 task 都可以喺 <code class="undefined mdx-components_inline-code__y_QeQ">1</code> 分鐘之內成功完成。跟住，我地要計下有問題既 partition 創建新 task 既速率。假如有問題既 <code class="undefined mdx-components_inline-code__y_QeQ">partition-3</code> 有 <code class="undefined mdx-components_inline-code__y_QeQ">6</code> 個店舖，而因為我地 call 每一款 Amazon API 都係每 <code class="undefined mdx-components_inline-code__y_QeQ">10</code> 分鐘 call 一次，我地有 <code class="undefined mdx-components_inline-code__y_QeQ">10</code> 個 API 要 call，咁即係每個 <code class="undefined mdx-components_inline-code__y_QeQ">10</code> 分鐘裡面都要執行 <code class="undefined mdx-components_inline-code__y_QeQ">60</code> 個 task records，而每到左下一分鐘都有 <code class="undefined mdx-components_inline-code__y_QeQ">6</code> 個 data tasks 到左預定執行時間而要被處理。</div>
<div class="mdx-components_paragraph__AUxxF">正因為每分鐘，系統只會喺每個 partition 拎最新創建既 <code class="undefined mdx-components_inline-code__y_QeQ">5</code> 筆 task records，一黎呢個速率慢過有問題既 partitions 創建新 task 既速率，二黎因為只會拎最新創建既 task records，所以有啲舊既 task records（唔知點解會有）就一直沉底，永遠都唔輪到佢地被執行。</div>
<div class="mdx-components_paragraph__AUxxF">理論上，假設所有店舖數據都可以平均咁分散喺各個 partition，咁呢個系統目前只係可以處理到 <code class="undefined mdx-components_inline-code__y_QeQ">500</code> 個店舖（如果以用戶數量黎計就更少）。</div></div></div></div><hr/><div class="vstack gap-3"><div class="text-center container"><div class="justify-content-center g-3 row row-cols-md-3 row-cols-sm-2 row-cols-1"><div class="col"><a href="tel:+85263301333" target="_blank" rel="external nofollow noopener noreferrer" class="SiteFooter_contact-item__H5kf5 card"><div class="card-body"><div class="card-title h5"><i class="fa-solid fa-phone" style="color:#009688"></i></div><p class="text-muted card-text">6330 1333</p></div></a></div><div class="col"><a href="mailto:michaelboyboy@gmail.com" target="_blank" rel="external nofollow noopener noreferrer" class="SiteFooter_contact-item__H5kf5 card"><div class="card-body"><div class="card-title h5"><i class="fa-solid fa-envelope" style="color:#f44336"></i></div><p class="text-muted card-text">michaelboyboy@gmail.com</p></div></a></div><div class="col"><a href="https://www.linkedin.com/in/mickchung" target="_blank" rel="external nofollow noopener noreferrer" class="SiteFooter_contact-item__H5kf5 card"><div class="card-body"><div class="card-title h5"><i class="fa-brands fa-linkedin" style="color:#2196f3"></i></div><p class="text-muted card-text">www.linkedin.com/in/mickchung</p></div></a></div></div></div><div class="SiteFooter_misc__7DgAh"><div>Copyright © <!-- -->2025<!-- --> Chung Cheuk Hang Michael. All rights reserved.</div><div>Developed with <strong>React</strong>, <strong>Bootstrap</strong> and <strong>Next.js</strong>.</div></div></div></div><script src="/e2-next/_next/static/chunks/webpack-be2cb7090e4daa20.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[8287,[\"7833\",\"static/chunks/7833-c0135c68ec6a11ed.js\",\"7177\",\"static/chunks/app/layout-3655101740c91656.js\"],\"default\"]\n3:I[3339,[\"8974\",\"static/chunks/app/page-63c121085425a904.js\"],\"default\"]\n4:I[2963,[\"7833\",\"static/chunks/7833-c0135c68ec6a11ed.js\",\"7177\",\"static/chunks/app/layout-3655101740c91656.js\"],\"default\"]\n5:I[7680,[\"7833\",\"static/chunks/7833-c0135c68ec6a11ed.js\",\"7177\",\"static/chunks/app/layout-3655101740c91656.js\"],\"default\"]\n6:I[5244,[],\"\"]\n7:I[3866,[],\"\"]\n8:I[6486,[\"7833\",\"static/chunks/7833-c0135c68ec6a11ed.js\",\"7177\",\"static/chunks/app/layout-3655101740c91656.js\"],\"default\"]\n9:I[4547,[],\"ClientSegmentRoot\"]\na:I[5211,[\"586\",\"static/chunks/13b76428-e7d338032a603c0d.js\",\"5496\",\"static/chunks/5496-1fb0b443dfc588c1.js\",\"8329\",\"static/chunks/app/blog/(blogPosts)/layout-b960ed9b018b1aae.js\"],\"default\"]\nc:I[6213,[],\"OutletBoundary\"]\ne:I[6213,[],\"MetadataBoundary\"]\n10:I[6213,[],\"ViewportBoundary\"]\n12:I[4835,[],\"\"]\n:HL[\"/e2-next/_next/static/css/8b3b49f5a80261a3.css\",\"style\"]\n:HL[\"/e2-next/_next/static/css/d3df112486f97f47.css\",\"style\"]\n:HL[\"/e2-next/_next/static/css/47422044c9b2dd2c.css\",\"style\"]\n:HL[\"/e2-next/_next/static/css/7bfe9ed714480baa.css\",\"style\"]\n:HL[\"/e2-next/_next/static/css/caf337e7effc00c7.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"81AwHecmUu3Lqfyl6Uekk\",\"p\":\"/e2-next\",\"c\":[\"\",\"blog\",\"task-scheduling-issue\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"blog\",{\"children\":[\"(blogPosts)\",{\"children\":[\"(2021-06)\",{\"children\":[\"task-scheduling-issue\",{\"children\":[\"__PAGE__\",{}]}]}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/e2-next/_next/static/css/8b3b49f5a80261a3.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}],[\"$\",\"link\",\"1\",{\"rel\":\"stylesheet\",\"href\":\"/e2-next/_next/static/css/d3df112486f97f47.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}],[\"$\",\"link\",\"2\",{\"rel\":\"stylesheet\",\"href\":\"/e2-next/_next/static/css/47422044c9b2dd2c.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[[\"$\",\"head\",null,{\"children\":[[\"$\",\"link\",null,{\"href\":\"https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900\u0026display=swap\",\"rel\":\"stylesheet\"}],[\"$\",\"link\",null,{\"rel\":\"stylesheet\",\"href\":\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css\"}]]}],[\"$\",\"body\",null,{\"children\":[\"$\",\"$L2\",null,{\"children\":[\"$\",\"$L3\",null,{\"gap\":5,\"children\":[[\"$\",\"$L3\",null,{\"gap\":5,\"className\":\"text-center\",\"children\":[[\"$\",\"div\",null,{\"className\":\"Ribbon_ribbon-left__fObbI\",\"children\":[\"$\",\"img\",null,{\"className\":\"Ribbon_image__2_FYh\",\"src\":\"/e2-next/nextjs.svg\"}]}],[\"$\",\"$L4\",null,{\"href\":\"https://blackr1234.github.io/e2/\",\"variant\":\"secondary\",\"size\":\"sm\",\"className\":\"ButtonToOtherSites_button__K4zwN\",\"children\":\"➜ Old React website\"}],[\"$\",\"div\",null,{\"children\":[[\"$\",\"code\",null,{\"className\":\"SiteHeader_name__pxX08\",\"children\":\"Chung Cheuk Hang Michael\"}],[\"$\",\"code\",null,{\"className\":\"SiteHeader_title__MUwhy\",\"children\":\"Java Web Developer\"}]]}],[\"$\",\"$L5\",null,{}]]}],[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[],[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}],[\"$\",\"hr\",null,{}],[\"$\",\"$L8\",null,{}]]}]}]}]]}]]}],{\"children\":[\"blog\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"(blogPosts)\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/e2-next/_next/static/css/7bfe9ed714480baa.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"$L9\",null,{\"Component\":\"$a\",\"slots\":{\"children\":[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"(blogPosts)\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]},\"params\":{},\"promise\":\"$@b\"}]]}],{\"children\":[\"(2021-06)\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"(blogPosts)\",\"children\",\"(2021-06)\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"task-scheduling-issue\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L6\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"(blogPosts)\",\"children\",\"(2021-06)\",\"children\",\"task-scheduling-issue\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L7\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"a\",null,{\"href\":\"#1-背景\",\"style\":{\"textDecoration\":\"none\"},\"children\":[\"$\",\"h1\",null,{\"id\":\"1-背景\",\"className\":\"mdx-components_heading__HrNl3 mdx-components_heading-new-section__YU39B\",\"style\":{\"zIndex\":1000000},\"children\":[[\"$\",\"i\",null,{\"className\":\"fa-solid fa-link mdx-components_heading-link__r6M6c\"}],\"1 背景\"]}]}],\"\\n\",[\"$\",\"a\",null,{\"href\":\"#11-項目\",\"style\":{\"textDecoration\":\"none\"},\"children\":[\"$\",\"h2\",null,{\"id\":\"11-項目\",\"className\":\"mdx-components_heading__HrNl3 mdx-components_heading-sub-section__AJ2JK\",\"style\":{\"zIndex\":1010000},\"children\":[[\"$\",\"i\",null,{\"className\":\"fa-solid fa-link mdx-components_heading-link__r6M6c\"}],\"1.1 項目\"]}]}],\"\\n\",[\"$\",\"div\",null,{\"className\":\"mdx-components_paragraph__AUxxF\",\"children\":\"話說我寫呢篇文章果陣做緊既公司畀某昆蟲公司收購左之後，就要做大量 revamp 工作，亦包括滿足新既業務需求。眾多個系統當中，有一個負責定時定候 call Amazon、ebay 等等既平台既 back-end application，今年加入左 pull Amazon MWS data 既 task scheduling，主要為每一個商戶客既每一個店舖 pull Amazon MWS data。\"}],\"\\n\",[\"$\",\"div\",null,{\"className\":\"mdx-components_paragraph__AUxxF\",\"children\":[\"呢個項目要 call \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"10\"}],\" 個 Amazon MWS 既 API。\"]}],\"\\n\",[\"$\",\"hr\",null,{\"className\":\"mdx-components_hr__o_oFr\"}],\"\\n\",[\"$\",\"a\",null,{\"href\":\"#12-資料庫設計\",\"style\":{\"textDecoration\":\"none\"},\"children\":[\"$\",\"h2\",null,{\"id\":\"12-資料庫設計\",\"className\":\"mdx-components_heading__HrNl3 mdx-components_heading-sub-section__AJ2JK\",\"style\":{\"zIndex\":1020000},\"children\":[[\"$\",\"i\",null,{\"className\":\"fa-solid fa-link mdx-components_heading-link__r6M6c\"}],\"1.2 資料庫設計\"]}]}],\"\\n\",[\"$\",\"div\",null,{\"className\":\"mdx-components_paragraph__AUxxF\",\"children\":\"DB 設計上做左 partition，分庫分表（for horizontal scaling）：\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":\"Sharing rule：所有 DB tables 根據 user ID 既 value 做 sharding——某兩個位既數字會用黎對應 partition index\"}],\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":[\"一共分成 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"100\"}],\" 個 partitions\"]}],\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":[\"所有 table 資料都由 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"10\"}],\" 個 physical DB、每個 physical DB 各自有 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"10\"}],\" 個 physical tables 組成（\",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"10\"}],\" DB 乘 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"10\"}],\" tables = \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"100\"}],\" partitions）\"]}],\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":[\"例如：\",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"db3\"}],\" 有 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"table1_30\"}],\" 至 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"table1_39\"}],\" 以及 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"table2_30\"}],\" 至 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"table2_39\"}]]}],\"\\n\"]}],\"\\n\",[\"$\",\"div\",null,{\"className\":\"mdx-components_paragraph__AUxxF\",\"children\":\"Schema 既設計：\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":[\"以 Amazon MWS API 黎分，有 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"10\"}],\" 個 logical tables，另外有其他 tables 負責 keep track 住 task scheduling\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"hr\",null,{\"className\":\"mdx-components_hr__o_oFr\"}],\"\\n\",[\"$\",\"a\",null,{\"href\":\"#13-task-scheduling-機制\",\"style\":{\"textDecoration\":\"none\"},\"children\":[\"$\",\"h2\",null,{\"id\":\"13-task-scheduling-機制\",\"className\":\"mdx-components_heading__HrNl3 mdx-components_heading-sub-section__AJ2JK\",\"style\":{\"zIndex\":1030000},\"children\":[[\"$\",\"i\",null,{\"className\":\"fa-solid fa-link mdx-components_heading-link__r6M6c\"}],\"1.3 Task scheduling 機制\"]}]}],\"\\n\",[\"$\",\"div\",null,{\"className\":\"mdx-components_paragraph__AUxxF\",\"children\":\"Task scheduling 既機制：\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":\"Scheduler server 會根據平台上面 scheduled job 既時間配置，定時定候 send message 去 cluster 裡面其中一機器\"}],\"\\n\"]}],\"\\n\",[\"$\",\"div\",null,{\"className\":\"mdx-components_paragraph__AUxxF\",\"children\":\"而 cluster 裡面既每一部機器既系統設計係咁：\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":\"系統引入「三層分發」機制黎實現 distributed task scheduling\"}],\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":[\"第一層：\",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"split\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":\"Cluster 裡面只會有一部機器收到 scheduler server 既指令\"}],\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":[\"佢之後會做 split partitions 動作，將 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"100\"}],\" 個 partition indexes 派畀 cluster 裡面既所有機器\"]}],\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":\"每部機器得到既果堆 partition indexes 可以係隨機\"}],\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":[\"平均黎講每部機器會收到 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"10\"}],\" 個 partitions\"]}],\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":[\"例如：\",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"instance3\"}],\" 收到 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"30\"}],\" 至 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"39\"}],\" 既 partition indexes\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":[\"第二層：\",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"load\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":\"當每部機器收到一堆 partition indexes，就會喺呢堆 partition indexes 指定既 physical DB 度 select task records\"}],\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":[\"目前既設定 hardcode 左係只拎最新創建既 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"5\"}],\" 筆 task records\"]}],\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":\"拎到 task records 之後就再派畀 cluster 裡面既所有機器\"}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":[\"第三層：\",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"execute\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":\"當每部機器收到 task record，就會加落 thread pool 度，等待處理\"}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"hr\",null,{\"className\":\"mdx-components_hr__o_oFr\"}],\"\\n\",[\"$\",\"a\",null,{\"href\":\"#14-production-場既配置\",\"style\":{\"textDecoration\":\"none\"},\"children\":[\"$\",\"h2\",null,{\"id\":\"14-production-場既配置\",\"className\":\"mdx-components_heading__HrNl3 mdx-components_heading-sub-section__AJ2JK\",\"style\":{\"zIndex\":1040000},\"children\":[[\"$\",\"i\",null,{\"className\":\"fa-solid fa-link mdx-components_heading-link__r6M6c\"}],\"1.4 Production 場既配置\"]}]}],\"\\n\",[\"$\",\"div\",null,{\"className\":\"mdx-components_paragraph__AUxxF\",\"children\":[\"Production 場既 cluster 部署左 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"10\"}],\" 部機器。\"]}],\"\\n\",[\"$\",\"hr\",null,{\"className\":\"mdx-components_hr__o_oFr\"}],\"\\n\",[\"$\",\"a\",null,{\"href\":\"#15-任務配置\",\"style\":{\"textDecoration\":\"none\"},\"children\":[\"$\",\"h2\",null,{\"id\":\"15-任務配置\",\"className\":\"mdx-components_heading__HrNl3 mdx-components_heading-sub-section__AJ2JK\",\"style\":{\"zIndex\":1050000},\"children\":[[\"$\",\"i\",null,{\"className\":\"fa-solid fa-link mdx-components_heading-link__r6M6c\"}],\"1.5 任務配置\"]}]}],\"\\n\",[\"$\",\"div\",null,{\"className\":\"mdx-components_paragraph__AUxxF\",\"children\":[\"呢個項目有 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"2\"}],\" 個任務：\"]}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":[\"創建 task\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":[\"每 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"1\"}],\" 分鐘執行一次\"]}],\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":\"如果店舖既某個 Amazon MWS API 唔存在執行中既任務（例如已經執行完成），就會創建新 task，即係永無休止咁 pull data\"}],\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":\"每個 Amazon MWS API 都會有一個 task\"}],\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":[\"每個 API 都係每隔 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"10\"}],\" 分鐘 call 一次\"]}],\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":[\"啲 API 分散喺唔同既分鐘（唔同既個位數），唔會同一分鐘做曬 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"10\"}],\" 個 API\"]}],\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":[\"例如：\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":[[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"api-3\"}],\" 既執行時間係 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"HH:03\"}],\"、\",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"HH:13\"}],\"、\",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"HH:23\"}],\"、\",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"HH:33\"}],\"、\",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"HH:43\"}],\"、\",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"HH:53\"}]]}],\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":[[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"api-5\"}],\" 既執行時間係 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"HH:05\"}],\"、\",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"HH:15\"}],\"、\",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"HH:25\"}],\"、\",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"HH:35\"}],\"、\",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"HH:45\"}],\"、\",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"HH:55\"}]]}],\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":\"如此類推\"}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":[\"處理 task\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":[\"每 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"1\"}],\" 分鐘執行一次\"]}],\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":\"只要 task 到左預定執行時間，就會處理\"}],\"\\n\",[\"$\",\"li\",null,{\"className\":\"mdx-components_list-item__fJ1NL\",\"children\":[\"目前既設定 hardcode 左係只拎最新創建既 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"5\"}],\" 筆 task records（每個 partition 都係咁）\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"div\",null,{\"className\":\"mdx-components_paragraph__AUxxF\",\"children\":[\"Scheduler server 每分鐘都會 send messages 去負責 split 既機器度 trigger 呢 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"2\"}],\" 個 \",[\"$\",\"em\",null,{\"children\":\"producer \u0026 consumer\"}],\" 既任務。\"]}],\"\\n\",[\"$\",\"hr\",null,{\"className\":\"mdx-components_hr__o_oFr\"}],\"\\n\",[\"$\",\"a\",null,{\"href\":\"#2-上線後出現既問題\",\"style\":{\"textDecoration\":\"none\"},\"children\":[\"$\",\"h1\",null,{\"id\":\"2-上線後出現既問題\",\"className\":\"mdx-components_heading__HrNl3 mdx-components_heading-new-section__YU39B\",\"style\":{\"zIndex\":2000000},\"children\":[[\"$\",\"i\",null,{\"className\":\"fa-solid fa-link mdx-components_heading-link__r6M6c\"}],\"2 上線後出現既問題\"]}]}],\"\\n\",[\"$\",\"div\",null,{\"className\":\"mdx-components_paragraph__AUxxF\",\"children\":\"呢個 project 最近上左線，onboard 左一部分商戶既店舖 records，但就出現左一個都幾尷尬既問題。\"}],\"\\n\",[\"$\",\"div\",null,{\"className\":\"mdx-components_paragraph__AUxxF\",\"children\":\"項目群組裡面有人話發現唔同既 Amazon MWS API 既 logical tables 出現既結果不一，某啲店舖喺某啲 tables 有 Amazon data records，但喺某啲 tables 就冇。\"}],\"\\n\",[\"$\",\"div\",null,{\"className\":\"mdx-components_paragraph__AUxxF\",\"children\":\"查一查 logical DB，睇見啲 task records 既預定執行時間係幾日前，呢啲 task records 明明應該已經執行左但就唔知點解一直冇執行到。\"}],\"\\n\",[\"$\",\"div\",null,{\"className\":\"mdx-components_paragraph__AUxxF\",\"children\":\"另外，有部分 tasks 執行失敗。\"}],\"\\n\",[\"$\",\"hr\",null,{\"className\":\"mdx-components_hr__o_oFr\"}],\"\\n\",[\"$\",\"a\",null,{\"href\":\"#3-原因分析\",\"style\":{\"textDecoration\":\"none\"},\"children\":[\"$\",\"h1\",null,{\"id\":\"3-原因分析\",\"className\":\"mdx-components_heading__HrNl3 mdx-components_heading-new-section__YU39B\",\"style\":{\"zIndex\":3000000},\"children\":[[\"$\",\"i\",null,{\"className\":\"fa-solid fa-link mdx-components_heading-link__r6M6c\"}],\"3 原因分析\"]}]}],\"\\n\",[\"$\",\"div\",null,{\"className\":\"mdx-components_paragraph__AUxxF\",\"children\":[\"Logical DB 裡面見到一堆應該已經執行但一直冇執行既 records 係黎自某幾個 partitions，而呢幾個 partitions 都有一個共通點，就係店舖數量大過 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"5\"}],\"。\"]}],\"\\n\",[\"$\",\"div\",null,{\"className\":\"mdx-components_paragraph__AUxxF\",\"children\":\"呢個其實係一個數學既問題。\"}],\"\\n\",[\"$\",\"div\",null,{\"className\":\"mdx-components_paragraph__AUxxF\",\"children\":[\"首先，我地先假設 pull data 既 task 都可以喺 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"1\"}],\" 分鐘之內成功完成。跟住，我地要計下有問題既 partition 創建新 task 既速率。假如有問題既 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"partition-3\"}],\" 有 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"6\"}],\" 個店舖，而因為我地 call 每一款 Amazon API 都係每 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"10\"}],\" 分鐘 call 一次，我地有 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"10\"}],\" 個 API 要 call，咁即係每個 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"10\"}],\" 分鐘裡面都要執行 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"60\"}],\" 個 task records，而每到左下一分鐘都有 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"6\"}],\" 個 data tasks 到左預定執行時間而要被處理。\"]}],\"\\n\",[\"$\",\"div\",null,{\"className\":\"mdx-components_paragraph__AUxxF\",\"children\":[\"正因為每分鐘，系統只會喺每個 partition 拎最新創建既 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"5\"}],\" 筆 task records，一黎呢個速率慢過有問題既 partitions 創建新 task 既速率，二黎因為只會拎最新創建既 task records，所以有啲舊既 task records（唔知點解會有）就一直沉底，永遠都唔輪到佢地被執行。\"]}],\"\\n\",[\"$\",\"div\",null,{\"className\":\"mdx-components_paragraph__AUxxF\",\"children\":[\"理論上，假設所有店舖數據都可以平均咁分散喺各個 partition，咁呢個系統目前只係可以處理到 \",[\"$\",\"code\",null,{\"className\":\"undefined mdx-components_inline-code__y_QeQ\",\"children\":\"500\"}],\" 個店舖（如果以用戶數量黎計就更少）。\"]}]],[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/e2-next/_next/static/css/caf337e7effc00c7.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"$Lc\",null,{\"children\":\"$Ld\"}]]}],{},null,false]},null,false]},null,false]},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$1\",\"cFKuyzUQOTXFn2lhniBKw\",{\"children\":[[\"$\",\"$Le\",null,{\"children\":\"$Lf\"}],[\"$\",\"$L10\",null,{\"children\":\"$L11\"}],null]}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$12\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"b:{}\n"])</script><script>self.__next_f.push([1,"11:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\nf:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"Blog posts\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"Powered by Next.js and React\"}],[\"$\",\"link\",\"3\",{\"rel\":\"icon\",\"href\":\"/e2-next/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"48x48\"}]]\n"])</script><script>self.__next_f.push([1,"d:null\n"])</script></body></html>