<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" as="image" href="blog/2021-10/spring-boot-elk-logging/kibana-create-data-view.png"/><link rel="preload" as="image" href="blog/2021-10/spring-boot-elk-logging/kibana-data-view-with-logs.png"/><link rel="stylesheet" href="/e2-next/_next/static/css/d3df112486f97f47.css" data-precedence="next"/><link rel="stylesheet" href="/e2-next/_next/static/css/c3624a693ae5a0c4.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/e2-next/_next/static/chunks/webpack-f088da4552bcc253.js"/><script src="/e2-next/_next/static/chunks/4bd1b696-120f4d9c40d223dd.js" async=""></script><script src="/e2-next/_next/static/chunks/1517-c8d232d43a11224c.js" async=""></script><script src="/e2-next/_next/static/chunks/main-app-05c45cc8f30d6cea.js" async=""></script><script src="/e2-next/_next/static/chunks/7829-b7b9eb1dbe0d40e4.js" async=""></script><script src="/e2-next/_next/static/chunks/2153-45fd9844831c6348.js" async=""></script><script src="/e2-next/_next/static/chunks/app/layout-ea91c2d128ec48c2.js" async=""></script><script src="/e2-next/_next/static/chunks/app/page-c8b940db14fac9a0.js" async=""></script><title>Michael Chung&#x27;s e-Portfolio</title><meta name="description" content="Powered by Next.js and React"/><link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&amp;display=swap" rel="stylesheet"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/><script src="/e2-next/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body><div class="vstack gap-5"><div class="text-center vstack gap-5"><div><code class="SiteHeader_name__cwQmL">Chung Cheuk Hang Michael</code><code class="SiteHeader_title__CCfvI">Java Web Developer</code></div><nav class="justify-content-center navbar navbar-expand-md navbar-dark"><button type="button" aria-label="Toggle navigation" class="navbar-toggler collapsed"><span class="navbar-toggler-icon"></span></button><div class="justify-content-center navbar-collapse collapse"><div class="justify-content-center navbar-nav nav-underline"><div class="nav-item"><a draggable="false" data-rr-ui-event-key="/" class="nav-link" href="/e2-next">Home</a></div><div class="nav-item"><a draggable="false" data-rr-ui-event-key="/work" class="nav-link" href="/e2-next/work">Work</a></div><div class="nav-item"><a draggable="false" data-rr-ui-event-key="/hobbyProjects" class="nav-link" href="/e2-next/hobbyProjects">Hobby projects</a></div><div class="nav-item"><a draggable="false" data-rr-ui-event-key="/personality" class="nav-link" href="/e2-next/personality">Personality</a></div><div class="nav-item"><a draggable="false" data-rr-ui-event-key="/blog" class="nav-link" href="/e2-next/blog">Blog</a></div></div></div></nav></div><h1>1 ELK 簡介</h1>
<p>ELK stack（Elasticsearch、Logstash、Kibana）係 Elastic 公司既 open-source log 管理工具，可以幫我地有效咁搵 log，當我地需要 debug 或者 troubleshoot 一啲 application 問題既時候就會非常有用。</p>
<table><thead><tr><th style="text-align:center">工具</th><th>作用</th></tr></thead><tbody><tr><td style="text-align:center">Logstash</td><td>收集唔同來源既 log 資料，再通過 API 將資料傳送到唔同既目的地（Elasticsearch）。</td></tr><tr><td style="text-align:center">Elasticsearch</td><td>儲存 log 資料，再自動做 indexing，所以有強大既資料搜尋功能（快如 Google search）。佢提供左儲存資料、管理資料、搜尋資料既 API。</td></tr><tr><td style="text-align:center">Kibana</td><td>提供網頁，畀我地用唔同既搜尋條件（時間段、keyword、metadata）搜尋 log，亦可以用圖表視覺化搜尋結果。佢通過 API 取得 log 資料（Elasticsearch），然後喺網頁上面顯示結果出黎。</td></tr></tbody></table>
<p>所以一個 log 既 flow 會係由 application 去 Logstash 再去 Elasticsearch 再去 Kibana，最終喺一個網頁上面顯示出黎。</p>
<h2>1.1 ELK 版本</h2>
<p>根據 <a href="https://endoflife.date/elasticsearch">endoflife.date</a>，我地最好用仲有 active support 既 version <code>8</code>。</p>
<hr/>
<h1>2 動手寫</h1>
<p>我地會用到 Spring Boot、Lombok、Slf4j 以及 Logback。</p>
<h2>2.1 Maven dependencies</h2>
<p>我地會用到 Lombok 既 <code>@Slf4j</code> annotation 去 generate construct logger object 既 code。</p>
<pre><code class="language-xml">&lt;parent&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
    &lt;version&gt;3.2.3&lt;/version&gt;
&lt;/parent&gt;

&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
        &lt;artifactId&gt;lombok&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;net.logstash.logback&lt;/groupId&gt;
        &lt;artifactId&gt;logstash-logback-encoder&lt;/artifactId&gt;
        &lt;version&gt;7.2&lt;/version&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
<hr/>
<h2>2.2 Application 配置</h2>
<p>我地可以有 <code>2</code> 個 Spring Boot profiles：</p>
<p><code>application.yml</code>（default profile，默認會用呢個）：</p>
<pre><code class="language-yaml">spring.application.name: mick-app

logging:
    config: classpath:logback/logback-prod.xml
</code></pre>
<p><code>application-dev.yml</code>（<code>dev</code> profile，指定先會用呢個）：</p>
<pre><code class="language-yaml">spring.application.name: mick-app

logging:
    config: classpath:logback/logback-dev.xml
</code></pre>
<p>註：如果要指定用 <code>dev</code> profile，啟動個 application 果陣要用 VM argument <code>-Dspring.profiles.active=dev</code>。</p>
<hr/>
<h2>2.3 Logback 配置</h2>
<p>喺我地既 Maven project 度建立 <code>2</code> 個配置檔：</p>
<ul>
<li><code>src/main/resources</code>
<ul>
<li><code>/logback</code>
<ul>
<li><code>logback-dev.xml</code></li>
<li><code>logback-prod.xml</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p><code>logback-dev.xml</code>（console + file）：</p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;configuration&gt;
	&lt;springProperty scope=&quot;context&quot; name=&quot;app_name&quot; source=&quot;spring.application.name&quot; /&gt;

	&lt;appender name=&quot;console&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;
		&lt;encoder&gt;
			&lt;pattern&gt;[${app_name:-}] %d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} (%file:%line\) - %msg%n&lt;/pattern&gt;
		&lt;/encoder&gt;
	&lt;/appender&gt;

	&lt;appender name=&quot;file&quot; class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;
		&lt;encoder class=&quot;net.logstash.logback.encoder.LogstashEncoder&quot;&gt;
			&lt;includeContext&gt;false&lt;/includeContext&gt;
			&lt;customFields&gt;{ &quot;host&quot;: &quot;${hostname:-}&quot;, &quot;app_name&quot;: &quot;${app_name:-}&quot; }&lt;/customFields&gt;
		&lt;/encoder&gt;

		&lt;file&gt;logs/app.log&lt;/file&gt;

		&lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;&gt;
			&lt;fileNamePattern&gt;logs/archived/app.log.%d{yyyy-MM-dd}&lt;/fileNamePattern&gt;
			&lt;maxHistory&gt;30&lt;/maxHistory&gt;
		&lt;/rollingPolicy&gt;
	&lt;/appender&gt;

	&lt;root level=&quot;INFO&quot;&gt;
		&lt;appender-ref ref=&quot;console&quot; /&gt;
		&lt;appender-ref ref=&quot;file&quot; /&gt;
	&lt;/root&gt;
&lt;/configuration&gt;
</code></pre>
<p><code>logback-prod.xml</code>（console + TCP socket）：</p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;configuration&gt;
	&lt;springProperty scope=&quot;context&quot; name=&quot;app_name&quot; source=&quot;spring.application.name&quot; /&gt;

	&lt;appender name=&quot;console&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;
		&lt;encoder&gt;
			&lt;pattern&gt;[${hostname:-} ${app_name:-}] %d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} (%file:%line\) - %msg%n&lt;/pattern&gt;
		&lt;/encoder&gt;
	&lt;/appender&gt;

	&lt;appender name=&quot;stash&quot; class=&quot;net.logstash.logback.appender.LogstashTcpSocketAppender&quot;&gt;
		&lt;encoder class=&quot;net.logstash.logback.encoder.LogstashEncoder&quot;&gt;
			&lt;includeContext&gt;false&lt;/includeContext&gt;
			&lt;customFields&gt;{ &quot;host&quot;: &quot;${hostname:-}&quot;, &quot;app_name&quot;: &quot;${app_name:-}&quot; }&lt;/customFields&gt;
		&lt;/encoder&gt;

		&lt;destination&gt;127.0.0.1:5000&lt;/destination&gt;
		&lt;keepAliveDuration&gt;5 minutes&lt;/keepAliveDuration&gt;
		&lt;reconnectionDelay&gt;10 second&lt;/reconnectionDelay&gt;
	&lt;/appender&gt;

	&lt;root level=&quot;INFO&quot;&gt;
		&lt;appender-ref ref=&quot;console&quot; /&gt;
		&lt;appender-ref ref=&quot;stash&quot; /&gt;
	&lt;/root&gt;
&lt;/configuration&gt;
</code></pre>
<hr/>
<h2>2.4 寫 Java code</h2>
<p>Project structure：</p>
<ul>
<li><code>src/main/java</code>
<ul>
<li><code>/code</code>
<ul>
<li><code>LogGenerator.java</code></li>
<li><code>MainApplication.java</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3>2.4.1 定時生成 log 既 component</h3>
<p><code>LogGenerator.java</code>：</p>
<pre><code class="language-java">@Slf4j
@EnableScheduling
@Component
public class LogGenerator {

    @Scheduled(cron = &quot;* * * * * *&quot;)
    public void generateLog() {
        log.info(&quot;Michael says {}&quot;, System.currentTimeMillis());
    }
}
</code></pre>
<hr/>
<h1>3 部署 ELK</h1>
<p>我地會用 Docker Compose 黎建立一個 Docker network 以及 ELK 既 containers，呢啲 containers 會連接到同一個 Docker network。</p>
<p>我地需要一個 working directory：</p>
<ul>
<li><code>elk-test</code>
<ul>
<li><code>/elk-config</code>
<ul>
<li><code>/elasticsearch</code>
<ul>
<li><code>elasticsearch.yml</code></li>
</ul>
</li>
<li><code>/kibana</code>
<ul>
<li><code>kibana.yml</code></li>
</ul>
</li>
<li><code>/logstash</code>
<ul>
<li><code>/pipeline</code>
<ul>
<li><code>logstash.conf</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><code>/elk-data</code>（忽略，全部由 Docker 自動生成）<!-- -->
<ul>
<li><code>/elasticsearch</code>
<ul>
<li><code>/data</code></li>
</ul>
</li>
<li><code>/kibana</code>
<ul>
<li><code>/data</code></li>
</ul>
</li>
</ul>
</li>
<li><code>docker-compose.yml</code></li>
</ul>
</li>
</ul>
<h2>3.1 Elasticsearch 配置</h2>
<p><code>elk-test/elk-config/elasticsearch/elasticsearch.yml</code>：</p>
<pre><code class="language-yaml">cluster.name: &quot;elasticsearch&quot;
network.host: 0.0.0.0
xpack.security.enabled: false
xpack.security.enrollment.enabled: false
xpack.security.autoconfiguration.enabled: false
</code></pre>
<hr/>
<h2>3.2 Kibana 配置</h2>
<p><code>elk-test/elk-config/kibana/kibana.yml</code>：</p>
<pre><code class="language-yaml">server.name: kibana
server.host: &quot;0.0.0.0&quot;
elasticsearch.hosts: [&quot;http://elasticsearch:9200&quot;]
monitoring.ui.container.elasticsearch.enabled: true
</code></pre>
<hr/>
<h2>3.3 Logstash pipeline 配置</h2>
<p><code>elk-test/elk-config/logstash/pipeline/logstash.conf</code>：</p>
<pre><code class="language-plaintext">input {
    tcp {
        port =&gt; &quot;5000&quot;
        codec =&gt; json_lines
    }
}

output {
    stdout {}
    elasticsearch {
        hosts =&gt; [&quot;http://elasticsearch:9200&quot;]
        index =&gt; &quot;mick-elk-%{+YYYY.MM.dd}&quot;
    }
}
</code></pre>
<hr/>
<h2>3.2 Docker Compose 配置</h2>
<p><code>elk-test/docker-compose.yml</code>：</p>
<pre><code class="language-yaml">version: &quot;3.8&quot;

networks:
    elk:
        driver: bridge

services:
    elasticsearch:
        container_name: elasticsearch
        image: elasticsearch:8.12.2
        mem_limit: 1073741824
        ports:
            - &quot;9200:9200&quot;
            - &quot;9300:9300&quot;
        networks:
            - elk
        volumes:
            - ./elk-config/elasticsearch/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml
            - ./elk-data/elasticsearch/data:/usr/share/elasticsearch/data
        environment:
            - discovery.type=single-node
            - ELASTIC_PASSWORD=elastic
            - bootstrap.memory_lock=true

    logstash:
        depends_on:
            - elasticsearch
        container_name: logstash
        image: logstash:8.12.2
        mem_limit: 1073741824
        ports:
            - &quot;5000:5000&quot;
            - &quot;9600:9600&quot;
        networks:
            - elk
        volumes:
            - ./elk-config/logstash/pipeline/logstash.conf:/usr/share/logstash/pipeline/logstash.conf

    kibana:
        depends_on:
            - elasticsearch
        container_name: kibana
        image: kibana:8.12.2
        mem_limit: 1073741824
        ports:
            - &quot;5601:5601&quot;
        networks:
            - elk
        volumes:
            - ./elk-config/kibana/kibana.yml:/usr/share/kibana/config/kibana.yml
            - ./elk-data/kibana/data:/usr/share/kibana/data
</code></pre>
<hr/>
<h2>3.3 執行 Docker Compose</h2>
<p>喺 <code>elk-test</code> folder 度執行 command：</p>
<pre><code class="language-bash">docker-compose up -d
</code></pre>
<p>停止／清理：</p>
<pre><code class="language-bash">docker-compose down
</code></pre>
<hr/>
<h1>4 產生 log</h1>
<ol>
<li>啟動 application（用默認 Spring profile）。</li>
<li>等待 console 出現一堆 <code>Mick says xxxxxxxxxxxxx</code> 既 log messages，建議至少 <code>10</code> 個。</li>
<li>打開 <a href="http://localhost:9200/_search?size=100">http://localhost:9200/_search?size=100</a> 應該可以見到一堆 log documents。</li>
</ol>
<hr/>
<h1>5 設定 Kibana、檢視結果</h1>
<ol>
<li>打開 <a href="http://localhost:5601">http://localhost:5601</a>。</li>
<li>佢會問我地 Enrollment token，我地可以撳「Configure manually」按鈕。</li>
<li>輸入 <code>http://elasticsearch:9200</code>，然後撳「Check address」按鈕。</li>
<li>佢會顯示「Elastic is already configured」，撳「Continue to Kibana」按鈕。</li>
<li>去左手邊既 navigation menu &gt; Analytics &gt; Discover 頁面。</li>
<li>因為我地已經有啲 log data，所以佢會顯示「You have data in Elasticsearch. Now, create a data view.」。</li>
<li>撳「Create data view」按鈕。<!-- -->
<ol>
<li>喺「Name」度輸入 <code>Mick testing</code>。</li>
<li>喺「Index pattern」輸入 <code>mick-elk-*</code>。</li>
<li>喺「Timestamp field」揀 <code>@timestamp</code>。</li>
</ol>
</li>
<li>右邊會顯示符合個 index pattern 既 index 來源。</li>
<li>撳「Save data view to Kibana」按鈕。</li>
<li>喺 data view 順序加入以下既 fields：<!-- -->
<ol>
<li><code>host</code></li>
<li><code>app_name</code></li>
<li><code>level</code></li>
<li><code>logger_name</code></li>
<li><code>message</code></li>
</ol>
</li>
<li>確保 <code>@timestamp</code> column 係 descending order。</li>
<li>可以撳右上既 Date quick select &gt; Refresh every 設定 <code>5 seconds</code>。</li>
<li>如果畫面太細，可以撳右上 Chart options &gt; Hide chart。</li>
</ol>
<p>註：以上既設定會被儲存喺 Elasticsearch 裡面既 <code>.kibana</code> index（<a href="http://localhost:9200/.kibana/_search?size=100">http://localhost:9200/.kibana/_search?size=100</a>）。</p>
<p><img src="blog/2021-10/spring-boot-elk-logging/kibana-create-data-view.png" alt=""/></p>
<p><img src="blog/2021-10/spring-boot-elk-logging/kibana-data-view-with-logs.png" alt=""/></p>
<hr/>
<h1>6 注意事項</h1>
<ul>
<li>確保電腦有 <code>85%</code> 或以上 disk space，否則 Elasticsearch 會 <code>red</code> status。<!-- -->
<ul>
<li>檢查 cluster health：<a href="http://localhost:9200/_cluster/health">http://localhost:9200/_cluster/health</a></li>
</ul>
</li>
</ul>
<hr/>
<h1>7 參考資料</h1>
<ul>
<li><a href="https://isd-soft.com/tech_blog/sprinkle-elk-spring-boot-logs/">Sprinkle Some ELK on Your Spring Boot Logs</a></li>
<li><a href="https://github.com/deviantony/docker-elk/blob/main/docker-compose.yml">deviantony/docker-elk - <code>docker-compose.yml</code></a></li>
</ul><hr/><div class="vstack gap-3"><div class="text-center container"><div class="justify-content-center g-3 row row-cols-md-3 row-cols-sm-2 row-cols-1"><div class="col"><a target="_blank" rel="external nofollow noopener noreferrer" class="SiteFooter_contact-item__2JRRr card" href="tel:+85263301333"><div class="card-body"><div class="card-title h5"><i class="fa-solid fa-phone" style="color:#009688"></i></div><p class="text-muted card-text">6330 1333<!-- --> </p></div></a></div><div class="col"><a target="_blank" rel="external nofollow noopener noreferrer" class="SiteFooter_contact-item__2JRRr card" href="mailto:michaelboyboy@gmail.com"><div class="card-body"><div class="card-title h5"><i class="fa-solid fa-envelope" style="color:#f44336"></i></div><p class="text-muted card-text">michaelboyboy@gmail.com<!-- --> </p></div></a></div><div class="col"><a target="_blank" rel="external nofollow noopener noreferrer" class="SiteFooter_contact-item__2JRRr card" href="https://www.linkedin.com/in/mickchung"><div class="card-body"><div class="card-title h5"><i class="fa-brands fa-linkedin" style="color:#2196f3"></i></div><p class="text-muted card-text">www.linkedin.com/in/mickchung<!-- --> </p></div></a></div></div></div></div></div><script src="/e2-next/_next/static/chunks/webpack-f088da4552bcc253.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[8287,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"2153\",\"static/chunks/2153-45fd9844831c6348.js\",\"7177\",\"static/chunks/app/layout-ea91c2d128ec48c2.js\"],\"default\"]\n3:I[3339,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"8974\",\"static/chunks/app/page-c8b940db14fac9a0.js\"],\"default\"]\n4:I[1367,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"2153\",\"static/chunks/2153-45fd9844831c6348.js\",\"7177\",\"static/chunks/app/layout-ea91c2d128ec48c2.js\"],\"default\"]\n5:I[5244,[],\"\"]\n6:I[3866,[],\"\"]\n7:I[4798,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"8974\",\"static/chunks/app/page-c8b940db14fac9a0.js\"],\"default\"]\n8:I[6121,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"8974\",\"static/chunks/app/page-c8b940db14fac9a0.js\"],\"default\"]\n9:I[3667,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"8974\",\"static/chunks/app/page-c8b940db14fac9a0.js\"],\"default\"]\na:I[8407,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"2153\",\"static/chunks/2153-45fd9844831c6348.js\",\"7177\",\"static/chunks/app/layout-ea91c2d128ec48c2.js\"],\"default\"]\nb:I[8173,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"8974\",\"static/chunks/app/page-c8b940db14fac9a0.js\"],\"\"]\nc:I[3197,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"2153\",\"static/chunks/2153-45fd9844831c6348.js\",\"7177\",\"static/chunks/app/layout-ea91c2d128ec48c2.js\"],\"default\"]\nd:I[7933,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"2153\",\"static/chunks/2153-45fd9844831c6348.js\",\"7177\",\"static/chunks/app/layout-ea91c2d128ec48c2.js\"],\"default\"]\ne:I[3800,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"2153\",\"static/chunks/2153-45fd9844831c6348.js\",\"7177\",\"static/chunks/app/layout-ea91c2d128ec48c2.js\"],\"default\"]\n11:I[6213,[],\"OutletBoundary\"]\n13:I[6213,[],\"MetadataBoundary\"]\n15:I[6213,[],\"ViewportBoundary\"]\n17:I[4835,[],\"\"]\n:HL[\"/e2-next/_next/static/css/d3df112486f97f47.css\",\"style\"]\n:HL[\"/e2-next/_next/static/css/c3624a693ae5a0c4.css\",\"style\"]\nf:T40a,\u003c?xml version=\"1.0\" encoding=\"UTF-8\"?\u003e\r\n\u003cconfiguration\u003e\r\n\t\u003cspringProperty scope=\"context\" name=\"app_name\" source=\"s"])</script><script>self.__next_f.push([1,"pring.application.name\" /\u003e\r\n\r\n\t\u003cappender name=\"console\" class=\"ch.qos.logback.core.ConsoleAppender\"\u003e\r\n\t\t\u003cencoder\u003e\r\n\t\t\t\u003cpattern\u003e[${app_name:-}] %d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} (%file:%line\\) - %msg%n\u003c/pattern\u003e\r\n\t\t\u003c/encoder\u003e\r\n\t\u003c/appender\u003e\r\n\r\n\t\u003cappender name=\"file\" class=\"ch.qos.logback.core.rolling.RollingFileAppender\"\u003e\r\n\t\t\u003cencoder class=\"net.logstash.logback.encoder.LogstashEncoder\"\u003e\r\n\t\t\t\u003cincludeContext\u003efalse\u003c/includeContext\u003e\r\n\t\t\t\u003ccustomFields\u003e{ \"host\": \"${hostname:-}\", \"app_name\": \"${app_name:-}\" }\u003c/customFields\u003e\r\n\t\t\u003c/encoder\u003e\r\n\r\n\t\t\u003cfile\u003elogs/app.log\u003c/file\u003e\r\n\r\n\t\t\u003crollingPolicy class=\"ch.qos.logback.core.rolling.TimeBasedRollingPolicy\"\u003e\r\n\t\t\t\u003cfileNamePattern\u003elogs/archived/app.log.%d{yyyy-MM-dd}\u003c/fileNamePattern\u003e\r\n\t\t\t\u003cmaxHistory\u003e30\u003c/maxHistory\u003e\r\n\t\t\u003c/rollingPolicy\u003e\r\n\t\u003c/appender\u003e\r\n\r\n\t\u003croot level=\"INFO\"\u003e\r\n\t\t\u003cappender-ref ref=\"console\" /\u003e\r\n\t\t\u003cappender-ref ref=\"file\" /\u003e\r\n\t\u003c/root\u003e\r\n\u003c/configuration\u003e\n10:T5ac,version: \"3.8\"\r\n\r\nnetworks:\r\n    elk:\r\n        driver: bridge\r\n\r\nservices:\r\n    elasticsearch:\r\n        container_name: elasticsearch\r\n        image: elasticsearch:8.12.2\r\n        mem_limit: 1073741824\r\n        ports:\r\n            - \"9200:9200\"\r\n            - \"9300:9300\"\r\n        networks:\r\n            - elk\r\n        volumes:\r\n            - ./elk-config/elasticsearch/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml\r\n            - ./elk-data/elasticsearch/data:/usr/share/elasticsearch/data\r\n        environment:\r\n            - discovery.type=single-node\r\n            - ELASTIC_PASSWORD=elastic\r\n            - bootstrap.memory_lock=true\r\n\r\n    logstash:\r\n        depends_on:\r\n            - elasticsearch\r\n        container_name: logstash\r\n        image: logstash:8.12.2\r\n        mem_limit: 1073741824\r\n        ports:\r\n            - \"5000:5000\"\r\n            - \"9600:9600\"\r\n        networks:\r\n            - elk\r\n        volumes:\r\n            - ./elk-config/logstash/pipeline/logstash.conf:/usr/share/logstash/pipeline/logstash.conf\r\n\r\n    kibana:\r\n        depends_on:\r\n            - elasticsearch\r\n   "])</script><script>self.__next_f.push([1,"     container_name: kibana\r\n        image: kibana:8.12.2\r\n        mem_limit: 1073741824\r\n        ports:\r\n            - \"5601:5601\"\r\n        networks:\r\n            - elk\r\n        volumes:\r\n            - ./elk-config/kibana/kibana.yml:/usr/share/kibana/config/kibana.yml\r\n            - ./elk-data/kibana/data:/usr/share/kibana/data\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"wfZ4FdS4ntgGvzjeKJhfw\",\"p\":\"/e2-next\",\"c\":[\"\",\"blog\",\"spring-boot-elk-logging\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"blog\",{\"children\":[\"(2021-10)\",{\"children\":[\"spring-boot-elk-logging\",{\"children\":[\"__PAGE__\",{}]}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/e2-next/_next/static/css/d3df112486f97f47.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}],[\"$\",\"link\",\"1\",{\"rel\":\"stylesheet\",\"href\":\"/e2-next/_next/static/css/c3624a693ae5a0c4.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[[\"$\",\"head\",null,{\"children\":[[\"$\",\"link\",null,{\"href\":\"https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900\u0026display=swap\",\"rel\":\"stylesheet\"}],[\"$\",\"link\",null,{\"rel\":\"stylesheet\",\"href\":\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css\"}]]}],[\"$\",\"body\",null,{\"children\":[\"$\",\"$L2\",null,{\"children\":[\"$\",\"$L3\",null,{\"gap\":5,\"children\":[[\"$\",\"$L3\",null,{\"gap\":5,\"className\":\"text-center\",\"children\":[[\"$\",\"div\",null,{\"children\":[[\"$\",\"code\",null,{\"className\":\"SiteHeader_name__cwQmL\",\"children\":\"Chung Cheuk Hang Michael\"}],[\"$\",\"code\",null,{\"className\":\"SiteHeader_title__CCfvI\",\"children\":\"Java Web Developer\"}]]}],[\"$\",\"$L4\",null,{}]]}],[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L6\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[],[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}],[\"$\",\"hr\",null,{}],[\"$\",\"$L3\",null,{\"gap\":3,\"children\":[\"$\",\"$L7\",null,{\"className\":\"text-center\",\"children\":[\"$\",\"$L8\",null,{\"xs\":1,\"sm\":2,\"md\":3,\"className\":\"justify-content-center g-3\",\"children\":[[\"$\",\"$L9\",\"0\",{\"children\":[\"$\",\"$La\",null,{\"as\":\"$b\",\"href\":\"tel:+85263301333\",\"target\":\"_blank\",\"rel\":\"external nofollow noopener noreferrer\",\"className\":\"SiteFooter_contact-item__2JRRr\",\"children\":[\"$\",\"$Lc\",null,{\"children\":[[\"$\",\"$Ld\",null,{\"children\":[\"$\",\"i\",null,{\"className\":\"fa-solid fa-phone\",\"style\":{\"color\":\"#009688\"}}]}],[\"$\",\"$Le\",null,{\"className\":\"text-muted\",\"children\":[\"6330 1333\",\" \"]}]]}]}]}],[\"$\",\"$L9\",\"1\",{\"children\":[\"$\",\"$La\",null,{\"as\":\"$b\",\"href\":\"mailto:michaelboyboy@gmail.com\",\"target\":\"_blank\",\"rel\":\"external nofollow noopener noreferrer\",\"className\":\"SiteFooter_contact-item__2JRRr\",\"children\":[\"$\",\"$Lc\",null,{\"children\":[[\"$\",\"$Ld\",null,{\"children\":[\"$\",\"i\",null,{\"className\":\"fa-solid fa-envelope\",\"style\":{\"color\":\"#f44336\"}}]}],[\"$\",\"$Le\",null,{\"className\":\"text-muted\",\"children\":[\"michaelboyboy@gmail.com\",\" \"]}]]}]}]}],[\"$\",\"$L9\",\"2\",{\"children\":[\"$\",\"$La\",null,{\"as\":\"$b\",\"href\":\"https://www.linkedin.com/in/mickchung\",\"target\":\"_blank\",\"rel\":\"external nofollow noopener noreferrer\",\"className\":\"SiteFooter_contact-item__2JRRr\",\"children\":[\"$\",\"$Lc\",null,{\"children\":[[\"$\",\"$Ld\",null,{\"children\":[\"$\",\"i\",null,{\"className\":\"fa-brands fa-linkedin\",\"style\":{\"color\":\"#2196f3\"}}]}],[\"$\",\"$Le\",null,{\"className\":\"text-muted\",\"children\":[\"www.linkedin.com/in/mickchung\",\" \"]}]]}]}]}]]}]}]}]]}]}]}]]}]]}],{\"children\":[\"blog\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L6\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"(2021-10)\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"(2021-10)\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L6\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"spring-boot-elk-logging\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"(2021-10)\",\"children\",\"spring-boot-elk-logging\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L6\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"h1\",null,{\"children\":\"1 ELK 簡介\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"ELK stack（Elasticsearch、Logstash、Kibana）係 Elastic 公司既 open-source log 管理工具，可以幫我地有效咁搵 log，當我地需要 debug 或者 troubleshoot 一啲 application 問題既時候就會非常有用。\"}],\"\\n\",[\"$\",\"table\",null,{\"children\":[[\"$\",\"thead\",null,{\"children\":[\"$\",\"tr\",null,{\"children\":[[\"$\",\"th\",null,{\"style\":{\"textAlign\":\"center\"},\"children\":\"工具\"}],[\"$\",\"th\",null,{\"children\":\"作用\"}]]}]}],[\"$\",\"tbody\",null,{\"children\":[[\"$\",\"tr\",null,{\"children\":[[\"$\",\"td\",null,{\"style\":{\"textAlign\":\"center\"},\"children\":\"Logstash\"}],[\"$\",\"td\",null,{\"children\":\"收集唔同來源既 log 資料，再通過 API 將資料傳送到唔同既目的地（Elasticsearch）。\"}]]}],[\"$\",\"tr\",null,{\"children\":[[\"$\",\"td\",null,{\"style\":{\"textAlign\":\"center\"},\"children\":\"Elasticsearch\"}],[\"$\",\"td\",null,{\"children\":\"儲存 log 資料，再自動做 indexing，所以有強大既資料搜尋功能（快如 Google search）。佢提供左儲存資料、管理資料、搜尋資料既 API。\"}]]}],[\"$\",\"tr\",null,{\"children\":[[\"$\",\"td\",null,{\"style\":{\"textAlign\":\"center\"},\"children\":\"Kibana\"}],[\"$\",\"td\",null,{\"children\":\"提供網頁，畀我地用唔同既搜尋條件（時間段、keyword、metadata）搜尋 log，亦可以用圖表視覺化搜尋結果。佢通過 API 取得 log 資料（Elasticsearch），然後喺網頁上面顯示結果出黎。\"}]]}]]}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"所以一個 log 既 flow 會係由 application 去 Logstash 再去 Elasticsearch 再去 Kibana，最終喺一個網頁上面顯示出黎。\"}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"1.1 ELK 版本\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"根據 \",[\"$\",\"a\",null,{\"href\":\"https://endoflife.date/elasticsearch\",\"children\":\"endoflife.date\"}],\"，我地最好用仲有 active support 既 version \",[\"$\",\"code\",null,{\"children\":\"8\"}],\"。\"]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h1\",null,{\"children\":\"2 動手寫\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"我地會用到 Spring Boot、Lombok、Slf4j 以及 Logback。\"}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"2.1 Maven dependencies\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"我地會用到 Lombok 既 \",[\"$\",\"code\",null,{\"children\":\"@Slf4j\"}],\" annotation 去 generate construct logger object 既 code。\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-xml\",\"children\":\"\u003cparent\u003e\\r\\n    \u003cgroupId\u003eorg.springframework.boot\u003c/groupId\u003e\\r\\n    \u003cartifactId\u003espring-boot-starter-parent\u003c/artifactId\u003e\\r\\n    \u003cversion\u003e3.2.3\u003c/version\u003e\\r\\n\u003c/parent\u003e\\r\\n\\r\\n\u003cdependencies\u003e\\r\\n    \u003cdependency\u003e\\r\\n        \u003cgroupId\u003eorg.springframework.boot\u003c/groupId\u003e\\r\\n        \u003cartifactId\u003espring-boot-starter-web\u003c/artifactId\u003e\\r\\n    \u003c/dependency\u003e\\r\\n\\r\\n    \u003cdependency\u003e\\r\\n        \u003cgroupId\u003eorg.projectlombok\u003c/groupId\u003e\\r\\n        \u003cartifactId\u003elombok\u003c/artifactId\u003e\\r\\n    \u003c/dependency\u003e\\r\\n\\r\\n    \u003cdependency\u003e\\r\\n        \u003cgroupId\u003enet.logstash.logback\u003c/groupId\u003e\\r\\n        \u003cartifactId\u003elogstash-logback-encoder\u003c/artifactId\u003e\\r\\n        \u003cversion\u003e7.2\u003c/version\u003e\\r\\n    \u003c/dependency\u003e\\r\\n\u003c/dependencies\u003e\\n\"}]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"2.2 Application 配置\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"我地可以有 \",[\"$\",\"code\",null,{\"children\":\"2\"}],\" 個 Spring Boot profiles：\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"application.yml\"}],\"（default profile，默認會用呢個）：\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-yaml\",\"children\":\"spring.application.name: mick-app\\r\\n\\r\\nlogging:\\r\\n    config: classpath:logback/logback-prod.xml\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"application-dev.yml\"}],\"（\",[\"$\",\"code\",null,{\"children\":\"dev\"}],\" profile，指定先會用呢個）：\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-yaml\",\"children\":\"spring.application.name: mick-app\\r\\n\\r\\nlogging:\\r\\n    config: classpath:logback/logback-dev.xml\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"註：如果要指定用 \",[\"$\",\"code\",null,{\"children\":\"dev\"}],\" profile，啟動個 application 果陣要用 VM argument \",[\"$\",\"code\",null,{\"children\":\"-Dspring.profiles.active=dev\"}],\"。\"]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"2.3 Logback 配置\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"喺我地既 Maven project 度建立 \",[\"$\",\"code\",null,{\"children\":\"2\"}],\" 個配置檔：\"]}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"src/main/resources\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"/logback\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"logback-dev.xml\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"logback-prod.xml\"}]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"logback-dev.xml\"}],\"（console + file）：\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-xml\",\"children\":\"$f\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"logback-prod.xml\"}],\"（console + TCP socket）：\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-xml\",\"children\":\"\u003c?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?\u003e\\r\\n\u003cconfiguration\u003e\\r\\n\\t\u003cspringProperty scope=\\\"context\\\" name=\\\"app_name\\\" source=\\\"spring.application.name\\\" /\u003e\\r\\n\\r\\n\\t\u003cappender name=\\\"console\\\" class=\\\"ch.qos.logback.core.ConsoleAppender\\\"\u003e\\r\\n\\t\\t\u003cencoder\u003e\\r\\n\\t\\t\\t\u003cpattern\u003e[${hostname:-} ${app_name:-}] %d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} (%file:%line\\\\) - %msg%n\u003c/pattern\u003e\\r\\n\\t\\t\u003c/encoder\u003e\\r\\n\\t\u003c/appender\u003e\\r\\n\\r\\n\\t\u003cappender name=\\\"stash\\\" class=\\\"net.logstash.logback.appender.LogstashTcpSocketAppender\\\"\u003e\\r\\n\\t\\t\u003cencoder class=\\\"net.logstash.logback.encoder.LogstashEncoder\\\"\u003e\\r\\n\\t\\t\\t\u003cincludeContext\u003efalse\u003c/includeContext\u003e\\r\\n\\t\\t\\t\u003ccustomFields\u003e{ \\\"host\\\": \\\"${hostname:-}\\\", \\\"app_name\\\": \\\"${app_name:-}\\\" }\u003c/customFields\u003e\\r\\n\\t\\t\u003c/encoder\u003e\\r\\n\\r\\n\\t\\t\u003cdestination\u003e127.0.0.1:5000\u003c/destination\u003e\\r\\n\\t\\t\u003ckeepAliveDuration\u003e5 minutes\u003c/keepAliveDuration\u003e\\r\\n\\t\\t\u003creconnectionDelay\u003e10 second\u003c/reconnectionDelay\u003e\\r\\n\\t\u003c/appender\u003e\\r\\n\\r\\n\\t\u003croot level=\\\"INFO\\\"\u003e\\r\\n\\t\\t\u003cappender-ref ref=\\\"console\\\" /\u003e\\r\\n\\t\\t\u003cappender-ref ref=\\\"stash\\\" /\u003e\\r\\n\\t\u003c/root\u003e\\r\\n\u003c/configuration\u003e\\n\"}]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"2.4 寫 Java code\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Project structure：\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"src/main/java\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"/code\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"LogGenerator.java\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"MainApplication.java\"}]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"2.4.1 定時生成 log 既 component\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"LogGenerator.java\"}],\"：\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-java\",\"children\":\"@Slf4j\\r\\n@EnableScheduling\\r\\n@Component\\r\\npublic class LogGenerator {\\r\\n\\r\\n    @Scheduled(cron = \\\"* * * * * *\\\")\\r\\n    public void generateLog() {\\r\\n        log.info(\\\"Michael says {}\\\", System.currentTimeMillis());\\r\\n    }\\r\\n}\\n\"}]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h1\",null,{\"children\":\"3 部署 ELK\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"我地會用 Docker Compose 黎建立一個 Docker network 以及 ELK 既 containers，呢啲 containers 會連接到同一個 Docker network。\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"我地需要一個 working directory：\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"elk-test\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"/elk-config\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"/elasticsearch\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"elasticsearch.yml\"}]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"/kibana\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"kibana.yml\"}]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"/logstash\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"/pipeline\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"logstash.conf\"}]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"/elk-data\"}],\"（忽略，全部由 Docker 自動生成）\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"/elasticsearch\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"/data\"}]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"/kibana\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"/data\"}]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"docker-compose.yml\"}]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"3.1 Elasticsearch 配置\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"elk-test/elk-config/elasticsearch/elasticsearch.yml\"}],\"：\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-yaml\",\"children\":\"cluster.name: \\\"elasticsearch\\\"\\r\\nnetwork.host: 0.0.0.0\\r\\nxpack.security.enabled: false\\r\\nxpack.security.enrollment.enabled: false\\r\\nxpack.security.autoconfiguration.enabled: false\\n\"}]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"3.2 Kibana 配置\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"elk-test/elk-config/kibana/kibana.yml\"}],\"：\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-yaml\",\"children\":\"server.name: kibana\\r\\nserver.host: \\\"0.0.0.0\\\"\\r\\nelasticsearch.hosts: [\\\"http://elasticsearch:9200\\\"]\\r\\nmonitoring.ui.container.elasticsearch.enabled: true\\n\"}]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"3.3 Logstash pipeline 配置\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"elk-test/elk-config/logstash/pipeline/logstash.conf\"}],\"：\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-plaintext\",\"children\":\"input {\\r\\n    tcp {\\r\\n        port =\u003e \\\"5000\\\"\\r\\n        codec =\u003e json_lines\\r\\n    }\\r\\n}\\r\\n\\r\\noutput {\\r\\n    stdout {}\\r\\n    elasticsearch {\\r\\n        hosts =\u003e [\\\"http://elasticsearch:9200\\\"]\\r\\n        index =\u003e \\\"mick-elk-%{+YYYY.MM.dd}\\\"\\r\\n    }\\r\\n}\\n\"}]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"3.2 Docker Compose 配置\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"elk-test/docker-compose.yml\"}],\"：\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-yaml\",\"children\":\"$10\"}]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"3.3 執行 Docker Compose\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"喺 \",[\"$\",\"code\",null,{\"children\":\"elk-test\"}],\" folder 度執行 command：\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-bash\",\"children\":\"docker-compose up -d\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"停止／清理：\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-bash\",\"children\":\"docker-compose down\\n\"}]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h1\",null,{\"children\":\"4 產生 log\"}],\"\\n\",[\"$\",\"ol\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"啟動 application（用默認 Spring profile）。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"等待 console 出現一堆 \",[\"$\",\"code\",null,{\"children\":\"Mick says xxxxxxxxxxxxx\"}],\" 既 log messages，建議至少 \",[\"$\",\"code\",null,{\"children\":\"10\"}],\" 個。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"打開 \",[\"$\",\"a\",null,{\"href\":\"http://localhost:9200/_search?size=100\",\"children\":\"http://localhost:9200/_search?size=100\"}],\" 應該可以見到一堆 log documents。\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h1\",null,{\"children\":\"5 設定 Kibana、檢視結果\"}],\"\\n\",[\"$\",\"ol\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"打開 \",[\"$\",\"a\",null,{\"href\":\"http://localhost:5601\",\"children\":\"http://localhost:5601\"}],\"。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"佢會問我地 Enrollment token，我地可以撳「Configure manually」按鈕。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"輸入 \",[\"$\",\"code\",null,{\"children\":\"http://elasticsearch:9200\"}],\"，然後撳「Check address」按鈕。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"佢會顯示「Elastic is already configured」，撳「Continue to Kibana」按鈕。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"去左手邊既 navigation menu \u003e Analytics \u003e Discover 頁面。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"因為我地已經有啲 log data，所以佢會顯示「You have data in Elasticsearch. Now, create a data view.」。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"撳「Create data view」按鈕。\",\"\\n\",[\"$\",\"ol\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"喺「Name」度輸入 \",[\"$\",\"code\",null,{\"children\":\"Mick testing\"}],\"。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"喺「Index pattern」輸入 \",[\"$\",\"code\",null,{\"children\":\"mick-elk-*\"}],\"。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"喺「Timestamp field」揀 \",[\"$\",\"code\",null,{\"children\":\"@timestamp\"}],\"。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"右邊會顯示符合個 index pattern 既 index 來源。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"撳「Save data view to Kibana」按鈕。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"喺 data view 順序加入以下既 fields：\",\"\\n\",[\"$\",\"ol\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"host\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"app_name\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"level\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"logger_name\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"message\"}]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"確保 \",[\"$\",\"code\",null,{\"children\":\"@timestamp\"}],\" column 係 descending order。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"可以撳右上既 Date quick select \u003e Refresh every 設定 \",[\"$\",\"code\",null,{\"children\":\"5 seconds\"}],\"。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"如果畫面太細，可以撳右上 Chart options \u003e Hide chart。\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"註：以上既設定會被儲存喺 Elasticsearch 裡面既 \",[\"$\",\"code\",null,{\"children\":\".kibana\"}],\" index（\",[\"$\",\"a\",null,{\"href\":\"http://localhost:9200/.kibana/_search?size=100\",\"children\":\"http://localhost:9200/.kibana/_search?size=100\"}],\"）。\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"img\",null,{\"src\":\"blog/2021-10/spring-boot-elk-logging/kibana-create-data-view.png\",\"alt\":\"\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"img\",null,{\"src\":\"blog/2021-10/spring-boot-elk-logging/kibana-data-view-with-logs.png\",\"alt\":\"\"}]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h1\",null,{\"children\":\"6 注意事項\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"確保電腦有 \",[\"$\",\"code\",null,{\"children\":\"85%\"}],\" 或以上 disk space，否則 Elasticsearch 會 \",[\"$\",\"code\",null,{\"children\":\"red\"}],\" status。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"檢查 cluster health：\",[\"$\",\"a\",null,{\"href\":\"http://localhost:9200/_cluster/health\",\"children\":\"http://localhost:9200/_cluster/health\"}]]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h1\",null,{\"children\":\"7 參考資料\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://isd-soft.com/tech_blog/sprinkle-elk-spring-boot-logs/\",\"children\":\"Sprinkle Some ELK on Your Spring Boot Logs\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://github.com/deviantony/docker-elk/blob/main/docker-compose.yml\",\"children\":[\"deviantony/docker-elk - \",[\"$\",\"code\",null,{\"children\":\"docker-compose.yml\"}]]}]}],\"\\n\"]}]],null,[\"$\",\"$L11\",null,{\"children\":\"$L12\"}]]}],{},null,false]},null,false]},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$1\",\"FMw2MBrVqts7H0IsRmv3I\",{\"children\":[[\"$\",\"$L13\",null,{\"children\":\"$L14\"}],[\"$\",\"$L15\",null,{\"children\":\"$L16\"}],null]}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$17\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"16:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n14:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"Michael Chung's e-Portfolio\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"Powered by Next.js and React\"}]]\n"])</script><script>self.__next_f.push([1,"12:null\n"])</script></body></html>