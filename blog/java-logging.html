<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" as="image" href="blog/2021-09/java-logging/bridging-legacy-apis.png"/><link rel="stylesheet" href="/e2-next/_next/static/css/d3df112486f97f47.css" data-precedence="next"/><link rel="stylesheet" href="/e2-next/_next/static/css/c3624a693ae5a0c4.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/e2-next/_next/static/chunks/webpack-f088da4552bcc253.js"/><script src="/e2-next/_next/static/chunks/4bd1b696-120f4d9c40d223dd.js" async=""></script><script src="/e2-next/_next/static/chunks/1517-c8d232d43a11224c.js" async=""></script><script src="/e2-next/_next/static/chunks/main-app-05c45cc8f30d6cea.js" async=""></script><script src="/e2-next/_next/static/chunks/7829-b7b9eb1dbe0d40e4.js" async=""></script><script src="/e2-next/_next/static/chunks/2153-45fd9844831c6348.js" async=""></script><script src="/e2-next/_next/static/chunks/app/layout-ea91c2d128ec48c2.js" async=""></script><script src="/e2-next/_next/static/chunks/app/page-c8b940db14fac9a0.js" async=""></script><title>Michael Chung&#x27;s e-Portfolio</title><meta name="description" content="Powered by Next.js and React"/><link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&amp;display=swap" rel="stylesheet"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/><script src="/e2-next/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body><div class="vstack gap-5"><div class="text-center vstack gap-5"><div><code class="SiteHeader_name__cwQmL">Chung Cheuk Hang Michael</code><code class="SiteHeader_title__CCfvI">Java Web Developer</code></div><nav class="justify-content-center navbar navbar-expand-md navbar-dark"><button type="button" aria-label="Toggle navigation" class="navbar-toggler collapsed"><span class="navbar-toggler-icon"></span></button><div class="justify-content-center navbar-collapse collapse"><div class="justify-content-center navbar-nav nav-underline"><div class="nav-item"><a draggable="false" data-rr-ui-event-key="/" class="nav-link" href="/e2-next">Home</a></div><div class="nav-item"><a draggable="false" data-rr-ui-event-key="/work" class="nav-link" href="/e2-next/work">Work</a></div><div class="nav-item"><a draggable="false" data-rr-ui-event-key="/hobbyProjects" class="nav-link" href="/e2-next/hobbyProjects">Hobby projects</a></div><div class="nav-item"><a draggable="false" data-rr-ui-event-key="/personality" class="nav-link" href="/e2-next/personality">Personality</a></div><div class="nav-item"><a draggable="false" data-rr-ui-event-key="/blog" class="nav-link" href="/e2-next/blog">Blog</a></div></div></div></nav></div><h1>1 Logging 簡介</h1>
<p>一個程式運行既時候係咩狀態、以前處理過啲咩、有冇曾經出 exceptions，如果我地唔做 logging 就冇辦法知道，然後就唔可能有系統地去 troubleshoot 或者 debug 到個程式。</p>
<p>Java 既基礎班有教我地用 <code>System.out</code> 或者 <code>System.err</code>（同為 <code>PrintStream</code> type）既 <code>println(...)</code> 或者 <code>printf(...)</code> 去令個程式喺 runtime 時候喺 console 度顯示到 log，但問題係 console 既 log 只能喺果個 console session 仍然存在既時候 keep 到紀錄，而如果 console session 完結左，我地係冇辦法睇得返啲 log。</p>
<p>因此，我地必須將啲 log save 落 file 度。除此之外，用 console 去做 logging 仲有唔少問題，所以就要用啲 logging libraries 去做 logging，亦需要用啲工具去幫手管理啲 log。</p>
<hr/>
<h1>2 如何做好 logging</h1>
<p>好既 logging practices 至少包括以下幾點：</p>
<ul>
<li>可以自行配置格式<!-- -->
<ul>
<li>包括由邊一個 Java class 既邊一行生產出黎、生產既 timestamp 資料</li>
<li>包括額外數據（例如 microservice architecture 既 web applications 之間如果用 per-HTTP-request trace ID 溝通，日後就可以用 trace ID 追蹤到成個 flow，知道先後 call 左邊啲 microservices）。</li>
<li>一個 Java 程式可以產生多個 threads，如果係 web application 既程式而 log entry 度又冇加到 per-HTTP-request 既 trace ID 或者 session ID，我地就只能以 thread name 黎分返開啲 log，從而串連啲 log 去跟住個 flow debug。</li>
<li>可以做到 log message 只係一個 log entry</li>
</ul>
</li>
<li>根據日期、檔案大小拆檔，並且識自動管理<!-- -->
<ul>
<li>假如我地個程式有好多野 log，亦有好多 users 用我地個 web service，咁我地個 web application 程式就可以生產到勁多 log。咁既情況下，最好係我地可以將啲 log 根據日期自動開新檔案儲存啲 log，甚或再根據檔案大小拆分檔案。</li>
</ul>
</li>
<li>可以配合搜尋工具<!-- -->
<ul>
<li>如果我地既程式係一個提供 web service 既 web application，而我地又得一個或者一堆 log files，但冇工具去管理佢地，咁我地係好難可以搵返特定既 log 出黎，所以我地亦要用啲專門管理 log 既工具。<!-- -->
<ul>
<li>Open source 既工具有 Elastic 既 ELK stack<!-- -->
<ul>
<li>Elasticsearch - 儲存 log、搜尋引擎</li>
<li>Logstash - 讀 log、處理 log</li>
<li>Kibana - 搜尋 log 既用戶介面、視覺化或者圖像化搜尋結果</li>
</ul>
</li>
<li>收費 cloud 既工具有 Sumo Logic</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr/>
<h1>3 Logging libraries</h1>
<p>Logging 可以分為 API 以及實現既 libraries。我地可以喺程式裡面用唔同既配搭：</p>
<ul>
<li>Log4j2 Core（API）、Log4j2 API（實現）</li>
<li>Slf4j（API）、Logback（實現）</li>
<li>Apache Commons Logging（API）、Log4j2（實現）<!-- -->
<ul>
<li>需要使用 Commons Logging Bridge</li>
</ul>
</li>
</ul>
<p><img src="blog/2021-09/java-logging/bridging-legacy-apis.png" alt=""/></p>
<h2>3.1 Log4j2 漏洞</h2>
<p>時間線：<a href="https://orangecyberdefense.com/nl/blog/threat/log4j-vulnerability/">Log4j Vulnerability</a></p>
<h3>3.1.1 JNDI lookup 遠程代碼執行漏洞（2021 年 12 月）</h3>
<p>喺 2021 年 12 月，Log4j2 畀人發現有遠程代碼執行漏洞（Log4Shell／<code>CVE-2021-44228</code>）。呢個漏洞係利用 Log4j 既一個 JNDI lookup 功能。</p>
<p>通常啲 logging libraries 都可以畀我地將 object value substitute 落帶有 <code>{}</code> placeholder 既 log message format 裡面，而如果呢個 object 係一個 JNDI URL 既 string，因為 Log4j2 本來默認左 JNDI lookup 既關係，Log4j2 就會連接到呢個 JNDI URL。如果個 JNDI URL 係一個上載喺黑客 server 上面既一個惡意 Java class 既網址，咁就有可能令到 Log4j2 call 左果個惡意網址去下載同埋執行果個惡意 Java class，從而達到最危險既資訊安全漏洞——遠程代碼執行漏洞（remote code execution）。</p>
<p>受影響既版本由 <code>2.0-beta-9</code> 至到 <code>2.14.1</code>，然後 Apache 推出左 <code>2.15.0</code> 去解決呢個漏洞。</p>
<p>如果冇辦法升級到最新版本，只要用既版本係 <code>2.10.0</code> 或以上，就可以能用呢啲參數：</p>
<table><thead><tr><th style="text-align:center">參數類別</th><th style="text-align:center">參數名稱</th><th style="text-align:center">參數值</th></tr></thead><tbody><tr><td style="text-align:center">System property</td><td style="text-align:center"><code>log4j2.formatMsgNoLookups</code></td><td style="text-align:center"><code>true</code></td></tr><tr><td style="text-align:center">Environment variable</td><td style="text-align:center"><code>LOG4J_FORMAT_MSG_NO_LOOKUPS</code></td><td style="text-align:center"><code>true</code></td></tr></tbody></table>
<p>參考資料：</p>
<ul>
<li><a href="https://www.reddit.com/r/blueteamsec/comments/rd38z9/log4j_0day_being_exploited/">Reddit - Log4j 0day being exploited</a></li>
<li><a href="https://securityboulevard.com/2021/12/log4shell-jndi-injection-via-attackable-log4j/">Log4Shell: JNDI Injection via Attackable Log4J</a>（<a href="https://web.archive.org/web/20230503012532/https://securityboulevard.com/2021/12/log4shell-jndi-injection-via-attackable-log4j/">備用一</a>／<a href="https://archive.ph/HNwfs">備用二</a>）</li>
<li><a href="https://www.youtube.com/watch?v=uyq8yxWO1ls">Youtube - Log4J Vulnerability (Log4Shell) Explained - for Java developers</a></li>
<li><a href="https://www.pcmag.com/news/countless-serves-are-vulnerable-to-apache-log4j-zero-day-exploit">Countless Servers Are Vulnerable to Apache Log4j Zero-Day Exploit</a>（<a href="https://web.archive.org/web/20230503055429/https://www.pcmag.com/news/countless-serves-are-vulnerable-to-apache-log4j-zero-day-exploit">備用一</a>／<a href="https://archive.ph/sLjQh">備用二</a>）</li>
<li><a href="https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/">Inside the Log4j2 vulnerability (CVE-2021-44228)</a></li>
<li><a href="https://www.anquanke.com/post/id/262668">Apache Log4j2 遠程代碼執行漏洞分析</a>（<a href="https://web.archive.org/web/20230503012709/https://www.anquanke.com/post/id/262668">備用一</a>／<a href="https://archive.ph/PtDnt">備用二</a>）</li>
<li><a href="https://spring.io/blog/2021/12/10/log4j2-vulnerability-and-spring-boot">Log4J2 Vulnerability and Spring Boot</a></li>
<li><a href="https://logging.apache.org/log4j/2.x/">Log4j2 官網</a></li>
<li><a href="https://www.cnblogs.com/yyhuni/p/15088134.html">8u191 後的 JNDI 注入利用</a>（<a href="https://web.archive.org/web/20230503012839/https://www.cnblogs.com/yyhuni/p/15088134.html">備用一</a>／<a href="https://archive.ph/03McJ">備用二</a>）</li>
<li><a href="https://www.youtube.com/watch?v=Y8a5nB-vy78">Youtube - A Journey From JNDI/LDAP Manipulation to Remote Code Execution Dream Land</a></li>
</ul>
<hr/>
<h3>3.1.2 Infinite recursion DoS 漏洞（2021 年 12 月）</h3>
<p>不過之後又有人發現 Log4j2 仲有 DoS 漏洞（<code>CVE-2021-45105</code>），情況就好似 iPhone 既 iMessage 輸入特定文字有機會令到個程式 crash 咁。要解決呢個問題，就要升級 Log4j2 到 <code>2.17.0</code>（到底有完沒完？）。</p>
<p>參考資料：</p>
<ul>
<li><a href="https://issues.apache.org/jira/browse/LOG4J2-3230">Log4j2 JIRA - Certain strings can cause infinite recursion</a></li>
</ul>
<hr/>
<h1>4 動手寫</h1>
<h2>4.1 普通 Java 程式（非 Spring）</h2>
<p>我地會用到 Lombok、Slf4j 以及 Logback。</p>
<h3>4.1.1 Maven dependencies</h3>
<p>我地會用到 Lombok 既 <code>@Slf4j</code> annotation 去 generate construct logger object 既 code。</p>
<pre><code class="language-xml">&lt;dependencies&gt;

	&lt;dependency&gt;
		&lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
		&lt;artifactId&gt;lombok&lt;/artifactId&gt;
		&lt;version&gt;1.18.24&lt;/version&gt;
		&lt;scope&gt;provided&lt;/scope&gt;
	&lt;/dependency&gt;

	&lt;dependency&gt;
		&lt;groupId&gt;org.slf4j&lt;/groupId&gt;
		&lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;
		&lt;version&gt;1.7.36&lt;/version&gt;
	&lt;/dependency&gt;

	&lt;dependency&gt;
		&lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;
		&lt;artifactId&gt;logback-classic&lt;/artifactId&gt;
		&lt;version&gt;1.2.11&lt;/version&gt;
	&lt;/dependency&gt;

&lt;/dependencies&gt;
</code></pre>
<hr/>
<h2>4.2 Spring Boot web application</h2>
<p>我地會用到 Spring Boot、Lombok、Slf4j 以及 Logback。</p>
<h3>4.2.1 Maven dependencies</h3>
<p>我地會用到 Lombok 既 <code>@Slf4j</code> annotation 去 generate create construct object 既 code。</p>
<pre><code class="language-xml">&lt;parent&gt;
	&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
	&lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
	&lt;version&gt;2.6.1&lt;/version&gt;
&lt;/parent&gt;

&lt;dependencies&gt;

	&lt;dependency&gt;
		&lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
		&lt;artifactId&gt;lombok&lt;/artifactId&gt;
	&lt;/dependency&gt;

	&lt;dependency&gt;
		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
		&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
	&lt;/dependency&gt;

	&lt;dependency&gt;
		&lt;groupId&gt;net.logstash.logback&lt;/groupId&gt;
		&lt;artifactId&gt;logstash-logback-encoder&lt;/artifactId&gt;
		&lt;version&gt;7.0.1&lt;/version&gt;
	&lt;/dependency&gt;

&lt;/dependencies&gt;
</code></pre>
<hr/>
<h2>4.3 Logback 配置</h2>
<p>喺我地既 Maven project 度建立一個配置檔：</p>
<ul>
<li><code>main/resources</code>
<ul>
<li><code>logback.xml</code></li>
</ul>
</li>
</ul>
<p>檔案內容：</p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;configuration&gt;
    &lt;appender name=&quot;console&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;
        &lt;encoder&gt;
            &lt;pattern&gt;%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} (%file:%line\) - %msg%n&lt;/pattern&gt;
			&lt;charset&gt;UTF-8&lt;/charset&gt;
        &lt;/encoder&gt;
    &lt;/appender&gt;

    &lt;appender name=&quot;stash&quot; class=&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;&gt;
        &lt;file&gt;logs/app.log&lt;/file&gt;

        &lt;rollingPolicy class=&quot;ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy&quot;&gt;
            &lt;fileNamePattern&gt;logs/archived/app.%d{yyyy-MM-dd}.%i.log&lt;/fileNamePattern&gt;
            &lt;maxHistory&gt;30&lt;/maxHistory&gt;
            &lt;maxFileSize&gt;100MB&lt;/maxFileSize&gt;
            &lt;totalSizeCap&gt;1GB&lt;/totalSizeCap&gt;
        &lt;/rollingPolicy&gt;

        &lt;encoder class=&quot;net.logstash.logback.encoder.LogstashEncoder&quot; /&gt;
    &lt;/appender&gt;

    &lt;root level=&quot;INFO&quot;&gt;
        &lt;appender-ref ref=&quot;console&quot; /&gt;
        &lt;appender-ref ref=&quot;stash&quot; /&gt;
    &lt;/root&gt;
&lt;/configuration&gt;
</code></pre>
<p>解釋：</p>
<ul>
<li>呢度配置左 <code>2</code> 個 log appenders<!-- -->
<ul>
<li>當有 log 出現，每個 appender 都會接收到相同既 log</li>
<li>Console<!-- -->
<ul>
<li>仍然會喺 console 度出到 log，方便 local 啟動個 web application 既時候喺 IDE 或者 OS 自帶既 console（Windows 既 Command Prompt 或者 macOS 既 Terminal）睇到 log</li>
</ul>
</li>
<li>Logstash<!-- -->
<ul>
<li>Encoder 會指定用現成黎自 <code>logstash-logback-encoder</code> 既 <code>LogstashEncoder</code></li>
<li>呢個係為左畀 Elastic 既 ELK stack 裡面既 Logstash 工具睇得明我地既 log</li>
<li>每一行都係 JSON 格式</li>
</ul>
</li>
</ul>
</li>
<li><code>rollingPolicy</code> 可以畀我地配置點樣拆分檔案，到底係根據日期（每月一個或每日一個），又或者日期 + 檔案大小。<!-- -->
<ul>
<li>Logback 提供既 implementations<!-- -->
<ul>
<li><code>TimeBasedRollingPolicy</code></li>
<li><code>SizeAndTimeBasedRollingPolicy</code></li>
</ul>
</li>
<li><code>fileNamePattern</code>
<ul>
<li>用 <code>TimeBasedRollingPolicy</code> 既話，可以係以月拆分（用 <code>{yyyy-MM}</code>）或者以日拆分（用 <code>{yyyy-MM-dd}</code>）。</li>
<li>用 <code>SizeAndTimeBasedRollingPolicy</code> 既話，需要再加上 <code>%i</code>（第幾個分檔）。</li>
</ul>
</li>
<li><code>maxHistory</code>
<ul>
<li>儲存最近幾耐既 log 檔</li>
<li>如果 log 檔以月拆分，呢個數字就以月計（想一個月就寫 <code>1</code>）</li>
<li>如果 log 檔以日拆分，呢個數字就以日計（想一個月就寫 <code>30</code>）</li>
</ul>
</li>
<li><code>maxFileSize</code>
<ul>
<li>每個 log 檔既大小上限</li>
</ul>
</li>
<li><code>totalSizeCap</code>
<ul>
<li>所有舊既 log 檔既大小總數上限</li>
<li>一旦超出上限，會自動刪除日期最舊既 log 檔</li>
</ul>
</li>
<li>Logback 會先睇 <code>maxHistory</code>，之後再睇 <code>totalSizeCap</code> 去決定刪除舊既 log 檔。</li>
</ul>
</li>
</ul>
<hr/>
<h2>4.4 寫 Java code</h2>
<p>我地需要喺每個需要做 logging 既 class 加上 Lombok 既 <code>@Slf4j</code> annotation，然後用 Lombok 幫我地改好左叫 <code>log</code> 既 <code>org.slf4j.Logger</code> object 黎 log 我地既 log message。</p>
<pre><code class="language-java">@Slf4j
@Service
public class MyService {

    public void foo() {
        log.debug(&quot;This is DEBUG log.&quot;);
        log.info(&quot;This is INFO log.&quot;);
        log.trace(&quot;This is TRACE log.&quot;);

        try {
            throw new RuntimeException();
        } catch (Exception e) {
            log.warn(&quot;This is WARN log.&quot;, e);
            log.error(&quot;This is ERROR log.&quot;, e);
        }
    }
}
</code></pre>
<p>註：如果係喺有 exception 既情況下要 log，又想包括埋 stack trace，可以喺任何一個出 log 既 method call 既最後一個 argument 畀個 <code>Throwable</code> object 佢。</p>
<p>用左 <code>@Slf4j</code> 就可以取代一般寫法：</p>
<pre><code class="language-java">@Service
public class MyService {
    private Logger log = LoggerFactory.getLogger(getClass());
}
</code></pre>
<hr/>
<h1>5 參考資料</h1>
<ul>
<li><a href="http://www.slf4j.org/legacy.html">Slf4j 官網 - Bridging legacy APIs</a></li>
<li><a href="http://logback.qos.ch/manual/appenders.html">Logback 官網：Appenders</a></li>
<li><a href="https://www.liaoxuefeng.com/wiki/1252599548343744/1264739155914176">使用 SLF4J 和 Logback</a></li>
<li><a href="https://www.logicbig.com/tutorials/misc/java-logging/jcl-log4j2.html">Apache Commons Logging + log4j 2 Example</a></li>
</ul><hr/><div class="vstack gap-3"><div class="text-center container"><div class="justify-content-center g-3 row row-cols-md-3 row-cols-sm-2 row-cols-1"><div class="col"><a target="_blank" rel="external nofollow noopener noreferrer" class="SiteFooter_contact-item__2JRRr card" href="tel:+85263301333"><div class="card-body"><div class="card-title h5"><i class="fa-solid fa-phone" style="color:#009688"></i></div><p class="text-muted card-text">6330 1333<!-- --> </p></div></a></div><div class="col"><a target="_blank" rel="external nofollow noopener noreferrer" class="SiteFooter_contact-item__2JRRr card" href="mailto:michaelboyboy@gmail.com"><div class="card-body"><div class="card-title h5"><i class="fa-solid fa-envelope" style="color:#f44336"></i></div><p class="text-muted card-text">michaelboyboy@gmail.com<!-- --> </p></div></a></div><div class="col"><a target="_blank" rel="external nofollow noopener noreferrer" class="SiteFooter_contact-item__2JRRr card" href="https://www.linkedin.com/in/mickchung"><div class="card-body"><div class="card-title h5"><i class="fa-brands fa-linkedin" style="color:#2196f3"></i></div><p class="text-muted card-text">www.linkedin.com/in/mickchung<!-- --> </p></div></a></div></div></div></div></div><script src="/e2-next/_next/static/chunks/webpack-f088da4552bcc253.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[8287,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"2153\",\"static/chunks/2153-45fd9844831c6348.js\",\"7177\",\"static/chunks/app/layout-ea91c2d128ec48c2.js\"],\"default\"]\n3:I[3339,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"8974\",\"static/chunks/app/page-c8b940db14fac9a0.js\"],\"default\"]\n4:I[1367,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"2153\",\"static/chunks/2153-45fd9844831c6348.js\",\"7177\",\"static/chunks/app/layout-ea91c2d128ec48c2.js\"],\"default\"]\n5:I[5244,[],\"\"]\n6:I[3866,[],\"\"]\n7:I[4798,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"8974\",\"static/chunks/app/page-c8b940db14fac9a0.js\"],\"default\"]\n8:I[6121,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"8974\",\"static/chunks/app/page-c8b940db14fac9a0.js\"],\"default\"]\n9:I[3667,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"8974\",\"static/chunks/app/page-c8b940db14fac9a0.js\"],\"default\"]\na:I[8407,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"2153\",\"static/chunks/2153-45fd9844831c6348.js\",\"7177\",\"static/chunks/app/layout-ea91c2d128ec48c2.js\"],\"default\"]\nb:I[8173,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"8974\",\"static/chunks/app/page-c8b940db14fac9a0.js\"],\"\"]\nc:I[3197,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"2153\",\"static/chunks/2153-45fd9844831c6348.js\",\"7177\",\"static/chunks/app/layout-ea91c2d128ec48c2.js\"],\"default\"]\nd:I[7933,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"2153\",\"static/chunks/2153-45fd9844831c6348.js\",\"7177\",\"static/chunks/app/layout-ea91c2d128ec48c2.js\"],\"default\"]\ne:I[3800,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"2153\",\"static/chunks/2153-45fd9844831c6348.js\",\"7177\",\"static/chunks/app/layout-ea91c2d128ec48c2.js\"],\"default\"]\nf:I[6213,[],\"OutletBoundary\"]\n11:I[6213,[],\"MetadataBoundary\"]\n13:I[6213,[],\"ViewportBoundary\"]\n15:I[4835,[],\"\"]\n:HL[\"/e2-next/_next/static/css/d3df112486f97f47.css\",\"style\"]\n:HL[\"/e2-next/_next/static/css/c3624a693ae5a0c4.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"wfZ4FdS4ntgGvzjeKJhfw\",\"p\":\"/e2-next\",\"c\":[\"\",\"blog\",\"java-logging\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"blog\",{\"children\":[\"(2021-09)\",{\"children\":[\"java-logging\",{\"children\":[\"__PAGE__\",{}]}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/e2-next/_next/static/css/d3df112486f97f47.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}],[\"$\",\"link\",\"1\",{\"rel\":\"stylesheet\",\"href\":\"/e2-next/_next/static/css/c3624a693ae5a0c4.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[[\"$\",\"head\",null,{\"children\":[[\"$\",\"link\",null,{\"href\":\"https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900\u0026display=swap\",\"rel\":\"stylesheet\"}],[\"$\",\"link\",null,{\"rel\":\"stylesheet\",\"href\":\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css\"}]]}],[\"$\",\"body\",null,{\"children\":[\"$\",\"$L2\",null,{\"children\":[\"$\",\"$L3\",null,{\"gap\":5,\"children\":[[\"$\",\"$L3\",null,{\"gap\":5,\"className\":\"text-center\",\"children\":[[\"$\",\"div\",null,{\"children\":[[\"$\",\"code\",null,{\"className\":\"SiteHeader_name__cwQmL\",\"children\":\"Chung Cheuk Hang Michael\"}],[\"$\",\"code\",null,{\"className\":\"SiteHeader_title__CCfvI\",\"children\":\"Java Web Developer\"}]]}],[\"$\",\"$L4\",null,{}]]}],[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L6\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[],[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}],[\"$\",\"hr\",null,{}],[\"$\",\"$L3\",null,{\"gap\":3,\"children\":[\"$\",\"$L7\",null,{\"className\":\"text-center\",\"children\":[\"$\",\"$L8\",null,{\"xs\":1,\"sm\":2,\"md\":3,\"className\":\"justify-content-center g-3\",\"children\":[[\"$\",\"$L9\",\"0\",{\"children\":[\"$\",\"$La\",null,{\"as\":\"$b\",\"href\":\"tel:+85263301333\",\"target\":\"_blank\",\"rel\":\"external nofollow noopener noreferrer\",\"className\":\"SiteFooter_contact-item__2JRRr\",\"children\":[\"$\",\"$Lc\",null,{\"children\":[[\"$\",\"$Ld\",null,{\"children\":[\"$\",\"i\",null,{\"className\":\"fa-solid fa-phone\",\"style\":{\"color\":\"#009688\"}}]}],[\"$\",\"$Le\",null,{\"className\":\"text-muted\",\"children\":[\"6330 1333\",\" \"]}]]}]}]}],[\"$\",\"$L9\",\"1\",{\"children\":[\"$\",\"$La\",null,{\"as\":\"$b\",\"href\":\"mailto:michaelboyboy@gmail.com\",\"target\":\"_blank\",\"rel\":\"external nofollow noopener noreferrer\",\"className\":\"SiteFooter_contact-item__2JRRr\",\"children\":[\"$\",\"$Lc\",null,{\"children\":[[\"$\",\"$Ld\",null,{\"children\":[\"$\",\"i\",null,{\"className\":\"fa-solid fa-envelope\",\"style\":{\"color\":\"#f44336\"}}]}],[\"$\",\"$Le\",null,{\"className\":\"text-muted\",\"children\":[\"michaelboyboy@gmail.com\",\" \"]}]]}]}]}],[\"$\",\"$L9\",\"2\",{\"children\":[\"$\",\"$La\",null,{\"as\":\"$b\",\"href\":\"https://www.linkedin.com/in/mickchung\",\"target\":\"_blank\",\"rel\":\"external nofollow noopener noreferrer\",\"className\":\"SiteFooter_contact-item__2JRRr\",\"children\":[\"$\",\"$Lc\",null,{\"children\":[[\"$\",\"$Ld\",null,{\"children\":[\"$\",\"i\",null,{\"className\":\"fa-brands fa-linkedin\",\"style\":{\"color\":\"#2196f3\"}}]}],[\"$\",\"$Le\",null,{\"className\":\"text-muted\",\"children\":[\"www.linkedin.com/in/mickchung\",\" \"]}]]}]}]}]]}]}]}]]}]}]}]]}]]}],{\"children\":[\"blog\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L6\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"(2021-09)\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"(2021-09)\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L6\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"java-logging\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"(2021-09)\",\"children\",\"java-logging\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L6\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"h1\",null,{\"children\":\"1 Logging 簡介\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"一個程式運行既時候係咩狀態、以前處理過啲咩、有冇曾經出 exceptions，如果我地唔做 logging 就冇辦法知道，然後就唔可能有系統地去 troubleshoot 或者 debug 到個程式。\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"Java 既基礎班有教我地用 \",[\"$\",\"code\",null,{\"children\":\"System.out\"}],\" 或者 \",[\"$\",\"code\",null,{\"children\":\"System.err\"}],\"（同為 \",[\"$\",\"code\",null,{\"children\":\"PrintStream\"}],\" type）既 \",[\"$\",\"code\",null,{\"children\":\"println(...)\"}],\" 或者 \",[\"$\",\"code\",null,{\"children\":\"printf(...)\"}],\" 去令個程式喺 runtime 時候喺 console 度顯示到 log，但問題係 console 既 log 只能喺果個 console session 仍然存在既時候 keep 到紀錄，而如果 console session 完結左，我地係冇辦法睇得返啲 log。\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"因此，我地必須將啲 log save 落 file 度。除此之外，用 console 去做 logging 仲有唔少問題，所以就要用啲 logging libraries 去做 logging，亦需要用啲工具去幫手管理啲 log。\"}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h1\",null,{\"children\":\"2 如何做好 logging\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"好既 logging practices 至少包括以下幾點：\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"可以自行配置格式\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"包括由邊一個 Java class 既邊一行生產出黎、生產既 timestamp 資料\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"包括額外數據（例如 microservice architecture 既 web applications 之間如果用 per-HTTP-request trace ID 溝通，日後就可以用 trace ID 追蹤到成個 flow，知道先後 call 左邊啲 microservices）。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"一個 Java 程式可以產生多個 threads，如果係 web application 既程式而 log entry 度又冇加到 per-HTTP-request 既 trace ID 或者 session ID，我地就只能以 thread name 黎分返開啲 log，從而串連啲 log 去跟住個 flow debug。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"可以做到 log message 只係一個 log entry\"}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"根據日期、檔案大小拆檔，並且識自動管理\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"假如我地個程式有好多野 log，亦有好多 users 用我地個 web service，咁我地個 web application 程式就可以生產到勁多 log。咁既情況下，最好係我地可以將啲 log 根據日期自動開新檔案儲存啲 log，甚或再根據檔案大小拆分檔案。\"}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"可以配合搜尋工具\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"如果我地既程式係一個提供 web service 既 web application，而我地又得一個或者一堆 log files，但冇工具去管理佢地，咁我地係好難可以搵返特定既 log 出黎，所以我地亦要用啲專門管理 log 既工具。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Open source 既工具有 Elastic 既 ELK stack\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"Elasticsearch - 儲存 log、搜尋引擎\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"Logstash - 讀 log、處理 log\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"Kibana - 搜尋 log 既用戶介面、視覺化或者圖像化搜尋結果\"}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"收費 cloud 既工具有 Sumo Logic\"}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h1\",null,{\"children\":\"3 Logging libraries\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Logging 可以分為 API 以及實現既 libraries。我地可以喺程式裡面用唔同既配搭：\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"Log4j2 Core（API）、Log4j2 API（實現）\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"Slf4j（API）、Logback（實現）\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Apache Commons Logging（API）、Log4j2（實現）\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"需要使用 Commons Logging Bridge\"}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"img\",null,{\"src\":\"blog/2021-09/java-logging/bridging-legacy-apis.png\",\"alt\":\"\"}]}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"3.1 Log4j2 漏洞\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"時間線：\",[\"$\",\"a\",null,{\"href\":\"https://orangecyberdefense.com/nl/blog/threat/log4j-vulnerability/\",\"children\":\"Log4j Vulnerability\"}]]}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"3.1.1 JNDI lookup 遠程代碼執行漏洞（2021 年 12 月）\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"喺 2021 年 12 月，Log4j2 畀人發現有遠程代碼執行漏洞（Log4Shell／\",[\"$\",\"code\",null,{\"children\":\"CVE-2021-44228\"}],\"）。呢個漏洞係利用 Log4j 既一個 JNDI lookup 功能。\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"通常啲 logging libraries 都可以畀我地將 object value substitute 落帶有 \",[\"$\",\"code\",null,{\"children\":\"{}\"}],\" placeholder 既 log message format 裡面，而如果呢個 object 係一個 JNDI URL 既 string，因為 Log4j2 本來默認左 JNDI lookup 既關係，Log4j2 就會連接到呢個 JNDI URL。如果個 JNDI URL 係一個上載喺黑客 server 上面既一個惡意 Java class 既網址，咁就有可能令到 Log4j2 call 左果個惡意網址去下載同埋執行果個惡意 Java class，從而達到最危險既資訊安全漏洞——遠程代碼執行漏洞（remote code execution）。\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"受影響既版本由 \",[\"$\",\"code\",null,{\"children\":\"2.0-beta-9\"}],\" 至到 \",[\"$\",\"code\",null,{\"children\":\"2.14.1\"}],\"，然後 Apache 推出左 \",[\"$\",\"code\",null,{\"children\":\"2.15.0\"}],\" 去解決呢個漏洞。\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"如果冇辦法升級到最新版本，只要用既版本係 \",[\"$\",\"code\",null,{\"children\":\"2.10.0\"}],\" 或以上，就可以能用呢啲參數：\"]}],\"\\n\",[\"$\",\"table\",null,{\"children\":[[\"$\",\"thead\",null,{\"children\":[\"$\",\"tr\",null,{\"children\":[[\"$\",\"th\",null,{\"style\":{\"textAlign\":\"center\"},\"children\":\"參數類別\"}],[\"$\",\"th\",null,{\"style\":{\"textAlign\":\"center\"},\"children\":\"參數名稱\"}],[\"$\",\"th\",null,{\"style\":{\"textAlign\":\"center\"},\"children\":\"參數值\"}]]}]}],[\"$\",\"tbody\",null,{\"children\":[[\"$\",\"tr\",null,{\"children\":[[\"$\",\"td\",null,{\"style\":{\"textAlign\":\"center\"},\"children\":\"System property\"}],[\"$\",\"td\",null,{\"style\":{\"textAlign\":\"center\"},\"children\":[\"$\",\"code\",null,{\"children\":\"log4j2.formatMsgNoLookups\"}]}],[\"$\",\"td\",null,{\"style\":{\"textAlign\":\"center\"},\"children\":[\"$\",\"code\",null,{\"children\":\"true\"}]}]]}],[\"$\",\"tr\",null,{\"children\":[[\"$\",\"td\",null,{\"style\":{\"textAlign\":\"center\"},\"children\":\"Environment variable\"}],[\"$\",\"td\",null,{\"style\":{\"textAlign\":\"center\"},\"children\":[\"$\",\"code\",null,{\"children\":\"LOG4J_FORMAT_MSG_NO_LOOKUPS\"}]}],[\"$\",\"td\",null,{\"style\":{\"textAlign\":\"center\"},\"children\":[\"$\",\"code\",null,{\"children\":\"true\"}]}]]}]]}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"參考資料：\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://www.reddit.com/r/blueteamsec/comments/rd38z9/log4j_0day_being_exploited/\",\"children\":\"Reddit - Log4j 0day being exploited\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"a\",null,{\"href\":\"https://securityboulevard.com/2021/12/log4shell-jndi-injection-via-attackable-log4j/\",\"children\":\"Log4Shell: JNDI Injection via Attackable Log4J\"}],\"（\",[\"$\",\"a\",null,{\"href\":\"https://web.archive.org/web/20230503012532/https://securityboulevard.com/2021/12/log4shell-jndi-injection-via-attackable-log4j/\",\"children\":\"備用一\"}],\"／\",[\"$\",\"a\",null,{\"href\":\"https://archive.ph/HNwfs\",\"children\":\"備用二\"}],\"）\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://www.youtube.com/watch?v=uyq8yxWO1ls\",\"children\":\"Youtube - Log4J Vulnerability (Log4Shell) Explained - for Java developers\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"a\",null,{\"href\":\"https://www.pcmag.com/news/countless-serves-are-vulnerable-to-apache-log4j-zero-day-exploit\",\"children\":\"Countless Servers Are Vulnerable to Apache Log4j Zero-Day Exploit\"}],\"（\",[\"$\",\"a\",null,{\"href\":\"https://web.archive.org/web/20230503055429/https://www.pcmag.com/news/countless-serves-are-vulnerable-to-apache-log4j-zero-day-exploit\",\"children\":\"備用一\"}],\"／\",[\"$\",\"a\",null,{\"href\":\"https://archive.ph/sLjQh\",\"children\":\"備用二\"}],\"）\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/\",\"children\":\"Inside the Log4j2 vulnerability (CVE-2021-44228)\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"a\",null,{\"href\":\"https://www.anquanke.com/post/id/262668\",\"children\":\"Apache Log4j2 遠程代碼執行漏洞分析\"}],\"（\",[\"$\",\"a\",null,{\"href\":\"https://web.archive.org/web/20230503012709/https://www.anquanke.com/post/id/262668\",\"children\":\"備用一\"}],\"／\",[\"$\",\"a\",null,{\"href\":\"https://archive.ph/PtDnt\",\"children\":\"備用二\"}],\"）\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://spring.io/blog/2021/12/10/log4j2-vulnerability-and-spring-boot\",\"children\":\"Log4J2 Vulnerability and Spring Boot\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://logging.apache.org/log4j/2.x/\",\"children\":\"Log4j2 官網\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"a\",null,{\"href\":\"https://www.cnblogs.com/yyhuni/p/15088134.html\",\"children\":\"8u191 後的 JNDI 注入利用\"}],\"（\",[\"$\",\"a\",null,{\"href\":\"https://web.archive.org/web/20230503012839/https://www.cnblogs.com/yyhuni/p/15088134.html\",\"children\":\"備用一\"}],\"／\",[\"$\",\"a\",null,{\"href\":\"https://archive.ph/03McJ\",\"children\":\"備用二\"}],\"）\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://www.youtube.com/watch?v=Y8a5nB-vy78\",\"children\":\"Youtube - A Journey From JNDI/LDAP Manipulation to Remote Code Execution Dream Land\"}]}],\"\\n\"]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"3.1.2 Infinite recursion DoS 漏洞（2021 年 12 月）\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"不過之後又有人發現 Log4j2 仲有 DoS 漏洞（\",[\"$\",\"code\",null,{\"children\":\"CVE-2021-45105\"}],\"），情況就好似 iPhone 既 iMessage 輸入特定文字有機會令到個程式 crash 咁。要解決呢個問題，就要升級 Log4j2 到 \",[\"$\",\"code\",null,{\"children\":\"2.17.0\"}],\"（到底有完沒完？）。\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"參考資料：\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://issues.apache.org/jira/browse/LOG4J2-3230\",\"children\":\"Log4j2 JIRA - Certain strings can cause infinite recursion\"}]}],\"\\n\"]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h1\",null,{\"children\":\"4 動手寫\"}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"4.1 普通 Java 程式（非 Spring）\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"我地會用到 Lombok、Slf4j 以及 Logback。\"}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"4.1.1 Maven dependencies\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"我地會用到 Lombok 既 \",[\"$\",\"code\",null,{\"children\":\"@Slf4j\"}],\" annotation 去 generate construct logger object 既 code。\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-xml\",\"children\":\"\u003cdependencies\u003e\\r\\n\\r\\n\\t\u003cdependency\u003e\\r\\n\\t\\t\u003cgroupId\u003eorg.projectlombok\u003c/groupId\u003e\\r\\n\\t\\t\u003cartifactId\u003elombok\u003c/artifactId\u003e\\r\\n\\t\\t\u003cversion\u003e1.18.24\u003c/version\u003e\\r\\n\\t\\t\u003cscope\u003eprovided\u003c/scope\u003e\\r\\n\\t\u003c/dependency\u003e\\r\\n\\r\\n\\t\u003cdependency\u003e\\r\\n\\t\\t\u003cgroupId\u003eorg.slf4j\u003c/groupId\u003e\\r\\n\\t\\t\u003cartifactId\u003eslf4j-api\u003c/artifactId\u003e\\r\\n\\t\\t\u003cversion\u003e1.7.36\u003c/version\u003e\\r\\n\\t\u003c/dependency\u003e\\r\\n\\r\\n\\t\u003cdependency\u003e\\r\\n\\t\\t\u003cgroupId\u003ech.qos.logback\u003c/groupId\u003e\\r\\n\\t\\t\u003cartifactId\u003elogback-classic\u003c/artifactId\u003e\\r\\n\\t\\t\u003cversion\u003e1.2.11\u003c/version\u003e\\r\\n\\t\u003c/dependency\u003e\\r\\n\\r\\n\u003c/dependencies\u003e\\n\"}]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"4.2 Spring Boot web application\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"我地會用到 Spring Boot、Lombok、Slf4j 以及 Logback。\"}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"4.2.1 Maven dependencies\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"我地會用到 Lombok 既 \",[\"$\",\"code\",null,{\"children\":\"@Slf4j\"}],\" annotation 去 generate create construct object 既 code。\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-xml\",\"children\":\"\u003cparent\u003e\\r\\n\\t\u003cgroupId\u003eorg.springframework.boot\u003c/groupId\u003e\\r\\n\\t\u003cartifactId\u003espring-boot-starter-parent\u003c/artifactId\u003e\\r\\n\\t\u003cversion\u003e2.6.1\u003c/version\u003e\\r\\n\u003c/parent\u003e\\r\\n\\r\\n\u003cdependencies\u003e\\r\\n\\r\\n\\t\u003cdependency\u003e\\r\\n\\t\\t\u003cgroupId\u003eorg.projectlombok\u003c/groupId\u003e\\r\\n\\t\\t\u003cartifactId\u003elombok\u003c/artifactId\u003e\\r\\n\\t\u003c/dependency\u003e\\r\\n\\r\\n\\t\u003cdependency\u003e\\r\\n\\t\\t\u003cgroupId\u003eorg.springframework.boot\u003c/groupId\u003e\\r\\n\\t\\t\u003cartifactId\u003espring-boot-starter-web\u003c/artifactId\u003e\\r\\n\\t\u003c/dependency\u003e\\r\\n\\r\\n\\t\u003cdependency\u003e\\r\\n\\t\\t\u003cgroupId\u003enet.logstash.logback\u003c/groupId\u003e\\r\\n\\t\\t\u003cartifactId\u003elogstash-logback-encoder\u003c/artifactId\u003e\\r\\n\\t\\t\u003cversion\u003e7.0.1\u003c/version\u003e\\r\\n\\t\u003c/dependency\u003e\\r\\n\\r\\n\u003c/dependencies\u003e\\n\"}]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"4.3 Logback 配置\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"喺我地既 Maven project 度建立一個配置檔：\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"main/resources\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"logback.xml\"}]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"檔案內容：\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-xml\",\"children\":\"\u003c?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?\u003e\\r\\n\u003cconfiguration\u003e\\r\\n    \u003cappender name=\\\"console\\\" class=\\\"ch.qos.logback.core.ConsoleAppender\\\"\u003e\\r\\n        \u003cencoder\u003e\\r\\n            \u003cpattern\u003e%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} (%file:%line\\\\) - %msg%n\u003c/pattern\u003e\\r\\n\\t\\t\\t\u003ccharset\u003eUTF-8\u003c/charset\u003e\\r\\n        \u003c/encoder\u003e\\r\\n    \u003c/appender\u003e\\r\\n\\r\\n    \u003cappender name=\\\"stash\\\" class=\\\"ch.qos.logback.core.rolling.RollingFileAppender\\\"\u003e\\r\\n        \u003cfile\u003elogs/app.log\u003c/file\u003e\\r\\n\\r\\n        \u003crollingPolicy class=\\\"ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy\\\"\u003e\\r\\n            \u003cfileNamePattern\u003elogs/archived/app.%d{yyyy-MM-dd}.%i.log\u003c/fileNamePattern\u003e\\r\\n            \u003cmaxHistory\u003e30\u003c/maxHistory\u003e\\r\\n            \u003cmaxFileSize\u003e100MB\u003c/maxFileSize\u003e\\r\\n            \u003ctotalSizeCap\u003e1GB\u003c/totalSizeCap\u003e\\r\\n        \u003c/rollingPolicy\u003e\\r\\n\\r\\n        \u003cencoder class=\\\"net.logstash.logback.encoder.LogstashEncoder\\\" /\u003e\\r\\n    \u003c/appender\u003e\\r\\n\\r\\n    \u003croot level=\\\"INFO\\\"\u003e\\r\\n        \u003cappender-ref ref=\\\"console\\\" /\u003e\\r\\n        \u003cappender-ref ref=\\\"stash\\\" /\u003e\\r\\n    \u003c/root\u003e\\r\\n\u003c/configuration\u003e\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"解釋：\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"呢度配置左 \",[\"$\",\"code\",null,{\"children\":\"2\"}],\" 個 log appenders\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"當有 log 出現，每個 appender 都會接收到相同既 log\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Console\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"仍然會喺 console 度出到 log，方便 local 啟動個 web application 既時候喺 IDE 或者 OS 自帶既 console（Windows 既 Command Prompt 或者 macOS 既 Terminal）睇到 log\"}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Logstash\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Encoder 會指定用現成黎自 \",[\"$\",\"code\",null,{\"children\":\"logstash-logback-encoder\"}],\" 既 \",[\"$\",\"code\",null,{\"children\":\"LogstashEncoder\"}]]}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"呢個係為左畀 Elastic 既 ELK stack 裡面既 Logstash 工具睇得明我地既 log\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"每一行都係 JSON 格式\"}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"rollingPolicy\"}],\" 可以畀我地配置點樣拆分檔案，到底係根據日期（每月一個或每日一個），又或者日期 + 檔案大小。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Logback 提供既 implementations\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"TimeBasedRollingPolicy\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"SizeAndTimeBasedRollingPolicy\"}]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"fileNamePattern\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"用 \",[\"$\",\"code\",null,{\"children\":\"TimeBasedRollingPolicy\"}],\" 既話，可以係以月拆分（用 \",[\"$\",\"code\",null,{\"children\":\"{yyyy-MM}\"}],\"）或者以日拆分（用 \",[\"$\",\"code\",null,{\"children\":\"{yyyy-MM-dd}\"}],\"）。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"用 \",[\"$\",\"code\",null,{\"children\":\"SizeAndTimeBasedRollingPolicy\"}],\" 既話，需要再加上 \",[\"$\",\"code\",null,{\"children\":\"%i\"}],\"（第幾個分檔）。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"maxHistory\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"儲存最近幾耐既 log 檔\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"如果 log 檔以月拆分，呢個數字就以月計（想一個月就寫 \",[\"$\",\"code\",null,{\"children\":\"1\"}],\"）\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"如果 log 檔以日拆分，呢個數字就以日計（想一個月就寫 \",[\"$\",\"code\",null,{\"children\":\"30\"}],\"）\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"maxFileSize\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"每個 log 檔既大小上限\"}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"totalSizeCap\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"所有舊既 log 檔既大小總數上限\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"一旦超出上限，會自動刪除日期最舊既 log 檔\"}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Logback 會先睇 \",[\"$\",\"code\",null,{\"children\":\"maxHistory\"}],\"，之後再睇 \",[\"$\",\"code\",null,{\"children\":\"totalSizeCap\"}],\" 去決定刪除舊既 log 檔。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"4.4 寫 Java code\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"我地需要喺每個需要做 logging 既 class 加上 Lombok 既 \",[\"$\",\"code\",null,{\"children\":\"@Slf4j\"}],\" annotation，然後用 Lombok 幫我地改好左叫 \",[\"$\",\"code\",null,{\"children\":\"log\"}],\" 既 \",[\"$\",\"code\",null,{\"children\":\"org.slf4j.Logger\"}],\" object 黎 log 我地既 log message。\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-java\",\"children\":\"@Slf4j\\r\\n@Service\\r\\npublic class MyService {\\r\\n\\r\\n    public void foo() {\\r\\n        log.debug(\\\"This is DEBUG log.\\\");\\r\\n        log.info(\\\"This is INFO log.\\\");\\r\\n        log.trace(\\\"This is TRACE log.\\\");\\r\\n\\r\\n        try {\\r\\n            throw new RuntimeException();\\r\\n        } catch (Exception e) {\\r\\n            log.warn(\\\"This is WARN log.\\\", e);\\r\\n            log.error(\\\"This is ERROR log.\\\", e);\\r\\n        }\\r\\n    }\\r\\n}\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"註：如果係喺有 exception 既情況下要 log，又想包括埋 stack trace，可以喺任何一個出 log 既 method call 既最後一個 argument 畀個 \",[\"$\",\"code\",null,{\"children\":\"Throwable\"}],\" object 佢。\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"用左 \",[\"$\",\"code\",null,{\"children\":\"@Slf4j\"}],\" 就可以取代一般寫法：\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-java\",\"children\":\"@Service\\r\\npublic class MyService {\\r\\n    private Logger log = LoggerFactory.getLogger(getClass());\\r\\n}\\n\"}]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h1\",null,{\"children\":\"5 參考資料\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"http://www.slf4j.org/legacy.html\",\"children\":\"Slf4j 官網 - Bridging legacy APIs\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"http://logback.qos.ch/manual/appenders.html\",\"children\":\"Logback 官網：Appenders\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://www.liaoxuefeng.com/wiki/1252599548343744/1264739155914176\",\"children\":\"使用 SLF4J 和 Logback\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://www.logicbig.com/tutorials/misc/java-logging/jcl-log4j2.html\",\"children\":\"Apache Commons Logging + log4j 2 Example\"}]}],\"\\n\"]}]],null,[\"$\",\"$Lf\",null,{\"children\":\"$L10\"}]]}],{},null,false]},null,false]},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$1\",\"Rx1KyDO9Y6xAiIB6jSRWi\",{\"children\":[[\"$\",\"$L11\",null,{\"children\":\"$L12\"}],[\"$\",\"$L13\",null,{\"children\":\"$L14\"}],null]}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$15\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"14:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n12:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"Michael Chung's e-Portfolio\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"Powered by Next.js and React\"}]]\n"])</script><script>self.__next_f.push([1,"10:null\n"])</script></body></html>