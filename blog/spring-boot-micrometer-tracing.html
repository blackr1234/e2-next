<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" as="image" href="blog/2024-03/spring-boot-micrometer-tracing/kibana-search-logs-with-traceId.png"/><link rel="stylesheet" href="/e2-next/_next/static/css/d3df112486f97f47.css" data-precedence="next"/><link rel="stylesheet" href="/e2-next/_next/static/css/c3624a693ae5a0c4.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/e2-next/_next/static/chunks/webpack-f088da4552bcc253.js"/><script src="/e2-next/_next/static/chunks/4bd1b696-120f4d9c40d223dd.js" async=""></script><script src="/e2-next/_next/static/chunks/1517-c8d232d43a11224c.js" async=""></script><script src="/e2-next/_next/static/chunks/main-app-05c45cc8f30d6cea.js" async=""></script><script src="/e2-next/_next/static/chunks/7829-b7b9eb1dbe0d40e4.js" async=""></script><script src="/e2-next/_next/static/chunks/2153-45fd9844831c6348.js" async=""></script><script src="/e2-next/_next/static/chunks/app/layout-ea91c2d128ec48c2.js" async=""></script><script src="/e2-next/_next/static/chunks/app/page-c8b940db14fac9a0.js" async=""></script><title>Michael Chung&#x27;s e-Portfolio</title><meta name="description" content="Powered by Next.js and React"/><link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&amp;display=swap" rel="stylesheet"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/><script src="/e2-next/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body><div class="vstack gap-5"><div class="text-center vstack gap-5"><div><code class="SiteHeader_name__cwQmL">Chung Cheuk Hang Michael</code><code class="SiteHeader_title__CCfvI">Java Web Developer</code></div><nav class="justify-content-center navbar navbar-expand-md navbar-dark"><button type="button" aria-label="Toggle navigation" class="navbar-toggler collapsed"><span class="navbar-toggler-icon"></span></button><div class="justify-content-center navbar-collapse collapse"><div class="justify-content-center navbar-nav nav-underline"><div class="nav-item"><a draggable="false" data-rr-ui-event-key="/" class="nav-link" href="/e2-next">Home</a></div><div class="nav-item"><a draggable="false" data-rr-ui-event-key="/work" class="nav-link" href="/e2-next/work">Work</a></div><div class="nav-item"><a draggable="false" data-rr-ui-event-key="/hobbyProjects" class="nav-link" href="/e2-next/hobbyProjects">Hobby projects</a></div><div class="nav-item"><a draggable="false" data-rr-ui-event-key="/personality" class="nav-link" href="/e2-next/personality">Personality</a></div><div class="nav-item"><a draggable="false" data-rr-ui-event-key="/blog" class="nav-link" href="/e2-next/blog">Blog</a></div></div></div></nav></div><h1>1 Spring Boot 3 既 micrometer tracing</h1>
<p>Spring Boot 3 既其中一個比較大既改變，就係唔再支援 Spring Boot Sleuth（又或者話 Spring Boot Sleuth 唔支援 Spring Boot 3）。</p>
<p>根據 <a href="https://docs.spring.io/spring-cloud-sleuth/docs/current/reference/html/">Spring Cloud Sleuth 官方文檔</a>：</p>
<blockquote>
<p>!!!! IMPORTANT !!!!</p>
<p>Spring Cloud Sleuth’s last minor version is 3.1. You can check the 3.1.x branch for the latest commits.
Spring Cloud Sleuth will not work with Spring Boot 3.x onward. The last major version of Spring Boot that Sleuth will support is 2.x.</p>
<p>The core of this project got moved to <a href="https://micrometer.io/docs/tracing">Micrometer Tracing</a> project and the instrumentations will be moved to <a href="https://micrometer.io/">Micrometer</a> and all respective projects (no longer all instrumentations will be done in a single repository.</p>
<p>You can check the <a href="https://github.com/micrometer-metrics/tracing/wiki/Spring-Cloud-Sleuth-3.1-Migration-Guide">Micrometer Tracing migration guide</a> to learn how to migrate from Spring Cloud Sleuth to Micrometer Tracing.</p>
</blockquote>
<p>即係話，如果我地想繼續喺 HTTP requests 度加入 trace ID、span ID，我地要改用 micrometer tracing。</p>
<hr/>
<h1>2 定義</h1>
<p>喺 distributed tracing 裡面，我地有 trace ID、span ID 呢兩個 terms。</p>
<h2>2.1 Trace ID</h2>
<p>Trace ID 代表緊一個 distributed 既 request workflow，而呢個 request 會訪問好幾個 back-end microservices。利用同一個 trace ID 可以幫我地串連呢啲 back-end microservices，方便我地將同一個 request 既所有 microservices 既所有 application logs 搵出黎 troubleshoot 或者 debug。</p>
<p>進入一個新既 request workflow 既第一個 microservice 會負責生成 trace ID，然後當佢 send HTTP request 去佢既 downstream microservice 既時候，佢會喺個 HTTP request 加入一個 <code>traceparent</code> request header，而個 header value 既格式應該要符合 W3C 既 Trace Context 標準。</p>
<hr/>
<h2>2.2 Span ID</h2>
<p>Span ID 代表緊一個 request workflow 裡面既其中一小個 operation，係某一個 microservice 既某一個 operation unit。</p>
<hr/>
<h1>3 動手寫</h1>
<h2>3.1 Maven dependencies</h2>
<p>所有 microservices 都要有以下既 Maven dependencies：</p>
<pre><code class="language-xml">&lt;parent&gt;
	&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
	&lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
	&lt;version&gt;3.2.3&lt;/version&gt;
&lt;/parent&gt;

&lt;dependency&gt;
	&lt;groupId&gt;io.micrometer&lt;/groupId&gt;
	&lt;artifactId&gt;micrometer-registry-prometheus&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
	&lt;groupId&gt;io.micrometer&lt;/groupId&gt;
	&lt;artifactId&gt;micrometer-tracing-bridge-brave&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
	&lt;groupId&gt;net.logstash.logback&lt;/groupId&gt;
	&lt;artifactId&gt;logstash-logback-encoder&lt;/artifactId&gt;
	&lt;version&gt;7.2&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>如果需要用 <code>WebClient</code> 去 call downstream microservice 既話就加：</p>
<pre><code class="language-xml">&lt;dependency&gt;
	&lt;groupId&gt;org.springframework&lt;/groupId&gt;
	&lt;artifactId&gt;spring-webflux&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<p>如果需要用 OpenFeign 去 call downstream microservice 既話就加：</p>
<pre><code class="language-xml">&lt;dependency&gt;
	&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
	&lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
	&lt;groupId&gt;io.github.openfeign&lt;/groupId&gt;
	&lt;artifactId&gt;feign-micrometer&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<hr/>
<h2>3.2 寫 Java code</h2>
<h3>3.2.1 Spring <code>RestTemplate</code></h3>
<p>如果要令到 <code>RestTemplate</code> 識得喺 request header 度 forward micrometer tracing 既 data 去 downstream microservice 度，就要用 <code>RestTemplateBuilder</code> bean 去創建 <code>RestTemplate</code>：</p>
<pre><code class="language-java">@Configuration
public class RestTemplateConfig {

    @Bean
    RestTemplate restTemplate(RestTemplateBuilder builder) {

        final RestTemplate restTemplate = builder
            .setConnectTimeout(Duration.ofSeconds(10))
            .basicAuthentication(&quot;username&quot;, &quot;password&quot;)
            .defaultHeader(&quot;header1&quot;, &quot;header1-value&quot;)
            .defaultHeader(&quot;header2&quot;, &quot;header2-value&quot;)
            .build();

        // 如果加入左 jackson-dataformat-xml
        // 令 RestTemplate 唔好喺 Accept request header 度加入 application/xml 或相關既 values
        restTemplate.getMessageConverters()
            .removeIf(e -&gt; e.getClass()==MappingJackson2XmlHttpMessageConverter.class);

        return restTemplate;
    }
}
</code></pre>
<hr/>
<h3>3.2.2 Spring Webflux <code>WebClient</code></h3>
<p>如果要令到 <code>WebClient</code> 識得喺 request header 度 forward micrometer tracing 既 data 去 downstream microservice 度，就要用 <code>WebClient.Builder</code> bean 去創建 <code>WebClient</code>：</p>
<pre><code class="language-java">@Configuration
public class WebClientConfig {

    @Bean
    WebClient webClient(WebClient.Builder builder) {

        final HttpClient httpClient = HttpClient.newBuilder()
            .version(Version.HTTP_1_1)
            .connectTimeout(Duration.ofSeconds(10))
            .build();

        final WebClient client = builder
                .clientConnector(new JdkClientHttpConnector(httpClient))
                .defaultHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)
                .defaultHeader(&quot;header1&quot;, &quot;header1-value&quot;)
                .defaultHeader(&quot;header2&quot;, &quot;header2-value&quot;)
                .build();

        return client;
    }
}
</code></pre>
<hr/>
<h3>3.2.3 Spring 6.1 <code>RestClient</code></h3>
<p>如果要令到 <code>RestClient</code> 識得喺 request header 度 forward micrometer tracing 既 data 去 downstream microservice 度，就要用 <code>RestClient.Builder</code> bean 去創建 <code>RestClient</code>：</p>
<pre><code class="language-java">@Configuration
public class RestClientConfig {

    @Bean
    RestClient restClient(RestClient.Builder builder) {

        final RestClient client = builder
                .defaultHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)
                .defaultHeader(&quot;header1&quot;, &quot;header1-value&quot;)
                .defaultHeader(&quot;header2&quot;, &quot;header2-value&quot;)
                .build();

        return client;
    }
}
</code></pre>
<hr/>
<h3>3.2.4 Spring Cloud OpenFeign</h3>
<p>如果要令到 OpenFeign 識得喺 request header 度 forward micrometer tracing 既 data 去目標既 microservice 度，只需要喺 <code>pom.xml</code> 加入 <code>io.github.openfeign:feign-micrometer</code> 既 Maven dependency。</p>
<p>呢個 dependency 既版本由以下既 dependency management BOMs 控制。</p>
<ul>
<li><code>org.springframework.cloud:spring-cloud-dependencies</code>
<ul>
<li><code>org.springframework.cloud:spring-cloud-openfeign-dependencies</code>
<ul>
<li><code>io.github.openfeign:feign-bom</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<hr/>
<h2>3.3 Logback 配置</h2>
<p>最後一步，我地需要喺 <code>logback.xml</code> 裡面加入 trace ID 以及 span ID 既 MDC fields，咁喺 application logs 度就可以睇到佢地。</p>
<p>因為係 distributed microservices 既關係，我地如果用好似 ELK 咁既 centralized logging platform 既話，一定要可以分得到唔同既 microservices 既 logs，咁就要喺 <code>logback.xml</code> 既 encoders 度配置好：</p>
<ul>
<li>Host name，可以直接用 <code>${HOSTNAME:-}</code> 或者 <code>${hostname:-}</code>。</li>
<li>Spring application name，可以加入以下既配置，之後就可以用 <code>${app_name:-}</code>：<!-- -->
<ul>
<li>
<pre><code class="language-xml">&lt;!-- 喺 configuration 裡面 --&gt;
&lt;springProperty scope=&quot;context&quot; name=&quot;app_name&quot; source=&quot;spring.application.name&quot; /&gt;
</code></pre>
</li>
</ul>
</li>
</ul>
<p>詳情可以睇返呢篇：<a href="/blog/spring-boot-elk-logging">Spring 項目使用 ELK 做 logging</a>。</p>
<h3>3.3.1 自定義 encoder pattern</h3>
<p>如果要喺自定義既 encoder pattern 裡面加入 trace ID 以及 span ID，我地可以用：</p>
<ul>
<li><code>%X{traceId:-}</code></li>
<li><code>%X{spanId:-}</code></li>
</ul>
<p>例子：</p>
<pre><code class="language-xml">&lt;!-- 喺 appender 裡面 --&gt;
&lt;encoder&gt;
	&lt;pattern&gt;[${hostname:-} ${app_name:-}] [%X{traceId:-} %X{spanId:-}] %d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} (%file:%line\) - %msg%n&lt;/pattern&gt;
&lt;/encoder&gt;
</code></pre>
<p>註：</p>
<ul>
<li>呢度既 <code>:-</code> 係用黎分隔 key、value 既字符，佢既前面係 MDC key，後面係 value。<!-- -->
<ul>
<li>佢同 Spring 既 <code>:</code> 一樣意思，只不過係 Logback 揀左用 <code>:-</code>。</li>
<li><code>%X{key:-}</code> 既意思係如果 <code>key</code> 呢個 MDC key 未有 data 既話就會出 empty string（唔好誤以為會出 <code>-</code>）。</li>
<li><code>%X{key:-foo}</code> 既意思係如果 <code>key</code> 呢個 MDC key 未有 data 既話就會出 <code>foo</code>。</li>
</ul>
</li>
</ul>
<hr/>
<h3>3.3.2 Logstash Logback Encoder</h3>
<p>如果係用 Logstash Logback Encoder，亦即係 <code>net.logstash.logback:logstash-logback-encoder</code> 既 Maven dependency，咁我地就要用佢既 <code>includeMdcKeyName</code> XML element 去加入 trace ID 以及 span ID：</p>
<pre><code class="language-xml">&lt;!-- 喺 appender 裡面 --&gt;
&lt;encoder class=&quot;net.logstash.logback.encoder.LogstashEncoder&quot;&gt;
	&lt;includeContext&gt;false&lt;/includeContext&gt;
	&lt;includeMdcKeyName&gt;traceId&lt;/includeMdcKeyName&gt;
	&lt;includeMdcKeyName&gt;spanId&lt;/includeMdcKeyName&gt;
	&lt;customFields&gt;{ &quot;host&quot;: &quot;${hostname:-}&quot;, &quot;app_name&quot;: &quot;${app_name:-}&quot; }&lt;/customFields&gt;
&lt;/encoder&gt;
</code></pre>
<p>加左之後，每一個 log entry 既 JSON data 裡面都會多左 <code>traceId</code> 以及 <code>spanId</code> 既 key-value pairs。</p>
<hr/>
<h1>4 測試</h1>
<h2>4.1 本地測試</h2>
<ol>
<li>我地需要 set up 至少兩個 Spring Boot microservices。</li>
<li>全部 microservices 都要 expose 至少一個 HTTP REST endpoints。</li>
<li>除左最後一個只會被 call 但唔會 initiate call 既 microservice，我地要為所有作為 upstream 既其他 microservices 寫 HTTP call 既 code。<!-- -->
<ul>
<li>HTTP REST call flow：Service A ➜ Service B ➜ Service C 等等。</li>
<li>HTTP REST call 既 implementation 可以係 <code>RestTemplate</code>、<code>WebClient</code>、<code>RestClient</code> 或者 OpenFeign。</li>
</ul>
</li>
<li>用 cURL call Service A 既 HTTP REST endpoint。</li>
<li>檢查所有 microservices 既 console logs。<!-- -->
<ul>
<li>應該會見到只有一個 <code>32</code> 個位長度 alphanumeric 既 trace ID。</li>
<li>應該會見到每個 microservice 都有啲唔同既 <code>16</code> 個位長度 alphanumeric 既 span IDs。</li>
</ul>
</li>
<li>再用 cURL call Service A 既 HTTP REST endpoint。</li>
<li>再檢查所有 microservices 既 console logs。<!-- -->
<ul>
<li>應該會見到一個完全唔同既 trace ID。</li>
<li>應該會見到每個 microservice 又有啲唔同既 span IDs。</li>
</ul>
</li>
</ol>
<hr/>
<h2>4.2 測試發送 logs 去 ELK</h2>
<ol>
<li>我地需要 set up 至少兩個 Spring Boot microservices。</li>
<li>我地要配置好全部 microservices 既 <code>logback.xml</code>，將 <code>&lt;appender&gt;</code> 既 <code>&lt;destination&gt;</code> 配置為 <code>127.0.0.1:5000</code>，咁啲 logs 就會發送到本地部署既 Logstash。</li>
<li>全部 microservices 都要 expose 至少一個 HTTP REST endpoints。</li>
<li>除左最後一個只會被 call 但唔會 initiate call 既 microservice，我地要為所有作為 upstream 既其他 microservices 寫 HTTP call 既 code。<!-- -->
<ul>
<li>HTTP REST call flow：Service A ➜ Service B ➜ Service C 等等。</li>
<li>HTTP REST call 既 implementation 可以係 <code>RestTemplate</code>、<code>WebClient</code>、<code>RestClient</code> 或者 OpenFeign。</li>
</ul>
</li>
<li>用 cURL call Service A 既 HTTP REST endpoint。</li>
<li>打開 <a href="http://localhost:5601">http://localhost:5601</a> 檢查我地喺 Kibana 既 data view。<!-- -->
<ul>
<li>應該會見到只有一個 <code>32</code> 個位長度 alphanumeric 既 trace ID。</li>
<li>應該會見到每個 microservice 都有啲唔同既 <code>16</code> 個位長度 alphanumeric 既 span IDs。</li>
</ul>
</li>
<li>再用 cURL call Service A 既 HTTP REST endpoint。</li>
<li>再打開 <a href="http://localhost:5601">http://localhost:5601</a> 檢查我地喺 Kibana 既 data view。<!-- -->
<ul>
<li>應該會見到一個完全唔同既 trace ID。</li>
<li>應該會見到每個 microservice 又有啲唔同既 span IDs。</li>
</ul>
</li>
<li>我地可以撳落 <code>traceId</code> column 既某一個 cell value 隔籬既 <code>⊕</code> 號（「Filter for this traceId」），咁就可以睇曬所有同呢個 trace ID 有關係既 logs。</li>
</ol>
<p><img src="blog/2024-03/spring-boot-micrometer-tracing/kibana-search-logs-with-traceId.png" alt=""/></p>
<hr/>
<h1>5 參考資料</h1>
<ul>
<li><a href="https://spring.io/blog/2022/10/12/observability-with-spring-boot-3">Spring 官方 blog - Observability with Spring Boot 3</a></li>
<li><a href="https://docs.spring.io/spring-framework/reference/integration/observability.html">Spring 官方文檔 - Observability Support</a></li>
<li><a href="https://github.com/logfellow/logstash-logback-encoder?tab=readme-ov-file#mdc-fields">GitHub - logfellow/logstash-logback-encoder - Logstash Logback Encoder - MDC fields</a></li>
<li><a href="https://opentelemetry.io/docs/concepts/signals/traces/">OpenTelemetry - Traces</a></li>
<li><a href="https://github.com/w3c/trace-context/blob/main/spec/20-http_request_header_format.md">GitHub - w3c/trace-context - Trace Context HTTP Request Headers Format</a></li>
</ul><hr/><div class="vstack gap-3"><div class="text-center container"><div class="justify-content-center g-3 row row-cols-md-3 row-cols-sm-2 row-cols-1"><div class="col"><a target="_blank" rel="external nofollow noopener noreferrer" class="SiteFooter_contact-item__2JRRr card" href="tel:+85263301333"><div class="card-body"><div class="card-title h5"><i class="fa-solid fa-phone" style="color:#009688"></i></div><p class="text-muted card-text">6330 1333<!-- --> </p></div></a></div><div class="col"><a target="_blank" rel="external nofollow noopener noreferrer" class="SiteFooter_contact-item__2JRRr card" href="mailto:michaelboyboy@gmail.com"><div class="card-body"><div class="card-title h5"><i class="fa-solid fa-envelope" style="color:#f44336"></i></div><p class="text-muted card-text">michaelboyboy@gmail.com<!-- --> </p></div></a></div><div class="col"><a target="_blank" rel="external nofollow noopener noreferrer" class="SiteFooter_contact-item__2JRRr card" href="https://www.linkedin.com/in/mickchung"><div class="card-body"><div class="card-title h5"><i class="fa-brands fa-linkedin" style="color:#2196f3"></i></div><p class="text-muted card-text">www.linkedin.com/in/mickchung<!-- --> </p></div></a></div></div></div></div></div><script src="/e2-next/_next/static/chunks/webpack-f088da4552bcc253.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[8287,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"2153\",\"static/chunks/2153-45fd9844831c6348.js\",\"7177\",\"static/chunks/app/layout-ea91c2d128ec48c2.js\"],\"default\"]\n3:I[3339,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"8974\",\"static/chunks/app/page-c8b940db14fac9a0.js\"],\"default\"]\n4:I[1367,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"2153\",\"static/chunks/2153-45fd9844831c6348.js\",\"7177\",\"static/chunks/app/layout-ea91c2d128ec48c2.js\"],\"default\"]\n5:I[5244,[],\"\"]\n6:I[3866,[],\"\"]\n7:I[4798,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"8974\",\"static/chunks/app/page-c8b940db14fac9a0.js\"],\"default\"]\n8:I[6121,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"8974\",\"static/chunks/app/page-c8b940db14fac9a0.js\"],\"default\"]\n9:I[3667,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"8974\",\"static/chunks/app/page-c8b940db14fac9a0.js\"],\"default\"]\na:I[8407,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"2153\",\"static/chunks/2153-45fd9844831c6348.js\",\"7177\",\"static/chunks/app/layout-ea91c2d128ec48c2.js\"],\"default\"]\nb:I[8173,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"8974\",\"static/chunks/app/page-c8b940db14fac9a0.js\"],\"\"]\nc:I[3197,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"2153\",\"static/chunks/2153-45fd9844831c6348.js\",\"7177\",\"static/chunks/app/layout-ea91c2d128ec48c2.js\"],\"default\"]\nd:I[7933,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"2153\",\"static/chunks/2153-45fd9844831c6348.js\",\"7177\",\"static/chunks/app/layout-ea91c2d128ec48c2.js\"],\"default\"]\ne:I[3800,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"2153\",\"static/chunks/2153-45fd9844831c6348.js\",\"7177\",\"static/chunks/app/layout-ea91c2d128ec48c2.js\"],\"default\"]\nf:I[6213,[],\"OutletBoundary\"]\n11:I[6213,[],\"MetadataBoundary\"]\n13:I[6213,[],\"ViewportBoundary\"]\n15:I[4835,[],\"\"]\n:HL[\"/e2-next/_next/static/css/d3df112486f97f47.css\",\"style\"]\n:HL[\"/e2-next/_next/static/css/c3624a693ae5a0c4.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"wfZ4FdS4ntgGvzjeKJhfw\",\"p\":\"/e2-next\",\"c\":[\"\",\"blog\",\"spring-boot-micrometer-tracing\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"blog\",{\"children\":[\"(2024-03)\",{\"children\":[\"spring-boot-micrometer-tracing\",{\"children\":[\"__PAGE__\",{}]}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/e2-next/_next/static/css/d3df112486f97f47.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}],[\"$\",\"link\",\"1\",{\"rel\":\"stylesheet\",\"href\":\"/e2-next/_next/static/css/c3624a693ae5a0c4.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[[\"$\",\"head\",null,{\"children\":[[\"$\",\"link\",null,{\"href\":\"https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900\u0026display=swap\",\"rel\":\"stylesheet\"}],[\"$\",\"link\",null,{\"rel\":\"stylesheet\",\"href\":\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css\"}]]}],[\"$\",\"body\",null,{\"children\":[\"$\",\"$L2\",null,{\"children\":[\"$\",\"$L3\",null,{\"gap\":5,\"children\":[[\"$\",\"$L3\",null,{\"gap\":5,\"className\":\"text-center\",\"children\":[[\"$\",\"div\",null,{\"children\":[[\"$\",\"code\",null,{\"className\":\"SiteHeader_name__cwQmL\",\"children\":\"Chung Cheuk Hang Michael\"}],[\"$\",\"code\",null,{\"className\":\"SiteHeader_title__CCfvI\",\"children\":\"Java Web Developer\"}]]}],[\"$\",\"$L4\",null,{}]]}],[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L6\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[],[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}],[\"$\",\"hr\",null,{}],[\"$\",\"$L3\",null,{\"gap\":3,\"children\":[\"$\",\"$L7\",null,{\"className\":\"text-center\",\"children\":[\"$\",\"$L8\",null,{\"xs\":1,\"sm\":2,\"md\":3,\"className\":\"justify-content-center g-3\",\"children\":[[\"$\",\"$L9\",\"0\",{\"children\":[\"$\",\"$La\",null,{\"as\":\"$b\",\"href\":\"tel:+85263301333\",\"target\":\"_blank\",\"rel\":\"external nofollow noopener noreferrer\",\"className\":\"SiteFooter_contact-item__2JRRr\",\"children\":[\"$\",\"$Lc\",null,{\"children\":[[\"$\",\"$Ld\",null,{\"children\":[\"$\",\"i\",null,{\"className\":\"fa-solid fa-phone\",\"style\":{\"color\":\"#009688\"}}]}],[\"$\",\"$Le\",null,{\"className\":\"text-muted\",\"children\":[\"6330 1333\",\" \"]}]]}]}]}],[\"$\",\"$L9\",\"1\",{\"children\":[\"$\",\"$La\",null,{\"as\":\"$b\",\"href\":\"mailto:michaelboyboy@gmail.com\",\"target\":\"_blank\",\"rel\":\"external nofollow noopener noreferrer\",\"className\":\"SiteFooter_contact-item__2JRRr\",\"children\":[\"$\",\"$Lc\",null,{\"children\":[[\"$\",\"$Ld\",null,{\"children\":[\"$\",\"i\",null,{\"className\":\"fa-solid fa-envelope\",\"style\":{\"color\":\"#f44336\"}}]}],[\"$\",\"$Le\",null,{\"className\":\"text-muted\",\"children\":[\"michaelboyboy@gmail.com\",\" \"]}]]}]}]}],[\"$\",\"$L9\",\"2\",{\"children\":[\"$\",\"$La\",null,{\"as\":\"$b\",\"href\":\"https://www.linkedin.com/in/mickchung\",\"target\":\"_blank\",\"rel\":\"external nofollow noopener noreferrer\",\"className\":\"SiteFooter_contact-item__2JRRr\",\"children\":[\"$\",\"$Lc\",null,{\"children\":[[\"$\",\"$Ld\",null,{\"children\":[\"$\",\"i\",null,{\"className\":\"fa-brands fa-linkedin\",\"style\":{\"color\":\"#2196f3\"}}]}],[\"$\",\"$Le\",null,{\"className\":\"text-muted\",\"children\":[\"www.linkedin.com/in/mickchung\",\" \"]}]]}]}]}]]}]}]}]]}]}]}]]}]]}],{\"children\":[\"blog\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L6\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"(2024-03)\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"(2024-03)\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L6\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"spring-boot-micrometer-tracing\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"(2024-03)\",\"children\",\"spring-boot-micrometer-tracing\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L6\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"h1\",null,{\"children\":\"1 Spring Boot 3 既 micrometer tracing\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Spring Boot 3 既其中一個比較大既改變，就係唔再支援 Spring Boot Sleuth（又或者話 Spring Boot Sleuth 唔支援 Spring Boot 3）。\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"根據 \",[\"$\",\"a\",null,{\"href\":\"https://docs.spring.io/spring-cloud-sleuth/docs/current/reference/html/\",\"children\":\"Spring Cloud Sleuth 官方文檔\"}],\"：\"]}],\"\\n\",[\"$\",\"blockquote\",null,{\"children\":[\"\\n\",[\"$\",\"p\",null,{\"children\":\"!!!! IMPORTANT !!!!\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Spring Cloud Sleuth’s last minor version is 3.1. You can check the 3.1.x branch for the latest commits.\\r\\nSpring Cloud Sleuth will not work with Spring Boot 3.x onward. The last major version of Spring Boot that Sleuth will support is 2.x.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"The core of this project got moved to \",[\"$\",\"a\",null,{\"href\":\"https://micrometer.io/docs/tracing\",\"children\":\"Micrometer Tracing\"}],\" project and the instrumentations will be moved to \",[\"$\",\"a\",null,{\"href\":\"https://micrometer.io/\",\"children\":\"Micrometer\"}],\" and all respective projects (no longer all instrumentations will be done in a single repository.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"You can check the \",[\"$\",\"a\",null,{\"href\":\"https://github.com/micrometer-metrics/tracing/wiki/Spring-Cloud-Sleuth-3.1-Migration-Guide\",\"children\":\"Micrometer Tracing migration guide\"}],\" to learn how to migrate from Spring Cloud Sleuth to Micrometer Tracing.\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"即係話，如果我地想繼續喺 HTTP requests 度加入 trace ID、span ID，我地要改用 micrometer tracing。\"}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h1\",null,{\"children\":\"2 定義\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"喺 distributed tracing 裡面，我地有 trace ID、span ID 呢兩個 terms。\"}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"2.1 Trace ID\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Trace ID 代表緊一個 distributed 既 request workflow，而呢個 request 會訪問好幾個 back-end microservices。利用同一個 trace ID 可以幫我地串連呢啲 back-end microservices，方便我地將同一個 request 既所有 microservices 既所有 application logs 搵出黎 troubleshoot 或者 debug。\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"進入一個新既 request workflow 既第一個 microservice 會負責生成 trace ID，然後當佢 send HTTP request 去佢既 downstream microservice 既時候，佢會喺個 HTTP request 加入一個 \",[\"$\",\"code\",null,{\"children\":\"traceparent\"}],\" request header，而個 header value 既格式應該要符合 W3C 既 Trace Context 標準。\"]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"2.2 Span ID\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Span ID 代表緊一個 request workflow 裡面既其中一小個 operation，係某一個 microservice 既某一個 operation unit。\"}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h1\",null,{\"children\":\"3 動手寫\"}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"3.1 Maven dependencies\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"所有 microservices 都要有以下既 Maven dependencies：\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-xml\",\"children\":\"\u003cparent\u003e\\r\\n\\t\u003cgroupId\u003eorg.springframework.boot\u003c/groupId\u003e\\r\\n\\t\u003cartifactId\u003espring-boot-starter-parent\u003c/artifactId\u003e\\r\\n\\t\u003cversion\u003e3.2.3\u003c/version\u003e\\r\\n\u003c/parent\u003e\\r\\n\\r\\n\u003cdependency\u003e\\r\\n\\t\u003cgroupId\u003eio.micrometer\u003c/groupId\u003e\\r\\n\\t\u003cartifactId\u003emicrometer-registry-prometheus\u003c/artifactId\u003e\\r\\n\u003c/dependency\u003e\\r\\n\u003cdependency\u003e\\r\\n\\t\u003cgroupId\u003eio.micrometer\u003c/groupId\u003e\\r\\n\\t\u003cartifactId\u003emicrometer-tracing-bridge-brave\u003c/artifactId\u003e\\r\\n\u003c/dependency\u003e\\r\\n\\r\\n\u003cdependency\u003e\\r\\n\\t\u003cgroupId\u003enet.logstash.logback\u003c/groupId\u003e\\r\\n\\t\u003cartifactId\u003elogstash-logback-encoder\u003c/artifactId\u003e\\r\\n\\t\u003cversion\u003e7.2\u003c/version\u003e\\r\\n\u003c/dependency\u003e\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"如果需要用 \",[\"$\",\"code\",null,{\"children\":\"WebClient\"}],\" 去 call downstream microservice 既話就加：\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-xml\",\"children\":\"\u003cdependency\u003e\\r\\n\\t\u003cgroupId\u003eorg.springframework\u003c/groupId\u003e\\r\\n\\t\u003cartifactId\u003espring-webflux\u003c/artifactId\u003e\\r\\n\u003c/dependency\u003e\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"如果需要用 OpenFeign 去 call downstream microservice 既話就加：\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-xml\",\"children\":\"\u003cdependency\u003e\\r\\n\\t\u003cgroupId\u003eorg.springframework.cloud\u003c/groupId\u003e\\r\\n\\t\u003cartifactId\u003espring-cloud-starter-openfeign\u003c/artifactId\u003e\\r\\n\u003c/dependency\u003e\\r\\n\u003cdependency\u003e\\r\\n\\t\u003cgroupId\u003eio.github.openfeign\u003c/groupId\u003e\\r\\n\\t\u003cartifactId\u003efeign-micrometer\u003c/artifactId\u003e\\r\\n\u003c/dependency\u003e\\n\"}]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"3.2 寫 Java code\"}],\"\\n\",[\"$\",\"h3\",null,{\"children\":[\"3.2.1 Spring \",[\"$\",\"code\",null,{\"children\":\"RestTemplate\"}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"如果要令到 \",[\"$\",\"code\",null,{\"children\":\"RestTemplate\"}],\" 識得喺 request header 度 forward micrometer tracing 既 data 去 downstream microservice 度，就要用 \",[\"$\",\"code\",null,{\"children\":\"RestTemplateBuilder\"}],\" bean 去創建 \",[\"$\",\"code\",null,{\"children\":\"RestTemplate\"}],\"：\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-java\",\"children\":\"@Configuration\\r\\npublic class RestTemplateConfig {\\r\\n\\r\\n    @Bean\\r\\n    RestTemplate restTemplate(RestTemplateBuilder builder) {\\r\\n\\r\\n        final RestTemplate restTemplate = builder\\r\\n            .setConnectTimeout(Duration.ofSeconds(10))\\r\\n            .basicAuthentication(\\\"username\\\", \\\"password\\\")\\r\\n            .defaultHeader(\\\"header1\\\", \\\"header1-value\\\")\\r\\n            .defaultHeader(\\\"header2\\\", \\\"header2-value\\\")\\r\\n            .build();\\r\\n\\r\\n        // 如果加入左 jackson-dataformat-xml\\r\\n        // 令 RestTemplate 唔好喺 Accept request header 度加入 application/xml 或相關既 values\\r\\n        restTemplate.getMessageConverters()\\r\\n            .removeIf(e -\u003e e.getClass()==MappingJackson2XmlHttpMessageConverter.class);\\r\\n\\r\\n        return restTemplate;\\r\\n    }\\r\\n}\\n\"}]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h3\",null,{\"children\":[\"3.2.2 Spring Webflux \",[\"$\",\"code\",null,{\"children\":\"WebClient\"}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"如果要令到 \",[\"$\",\"code\",null,{\"children\":\"WebClient\"}],\" 識得喺 request header 度 forward micrometer tracing 既 data 去 downstream microservice 度，就要用 \",[\"$\",\"code\",null,{\"children\":\"WebClient.Builder\"}],\" bean 去創建 \",[\"$\",\"code\",null,{\"children\":\"WebClient\"}],\"：\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-java\",\"children\":\"@Configuration\\r\\npublic class WebClientConfig {\\r\\n\\r\\n    @Bean\\r\\n    WebClient webClient(WebClient.Builder builder) {\\r\\n\\r\\n        final HttpClient httpClient = HttpClient.newBuilder()\\r\\n            .version(Version.HTTP_1_1)\\r\\n            .connectTimeout(Duration.ofSeconds(10))\\r\\n            .build();\\r\\n\\r\\n        final WebClient client = builder\\r\\n                .clientConnector(new JdkClientHttpConnector(httpClient))\\r\\n                .defaultHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)\\r\\n                .defaultHeader(\\\"header1\\\", \\\"header1-value\\\")\\r\\n                .defaultHeader(\\\"header2\\\", \\\"header2-value\\\")\\r\\n                .build();\\r\\n\\r\\n        return client;\\r\\n    }\\r\\n}\\n\"}]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h3\",null,{\"children\":[\"3.2.3 Spring 6.1 \",[\"$\",\"code\",null,{\"children\":\"RestClient\"}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"如果要令到 \",[\"$\",\"code\",null,{\"children\":\"RestClient\"}],\" 識得喺 request header 度 forward micrometer tracing 既 data 去 downstream microservice 度，就要用 \",[\"$\",\"code\",null,{\"children\":\"RestClient.Builder\"}],\" bean 去創建 \",[\"$\",\"code\",null,{\"children\":\"RestClient\"}],\"：\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-java\",\"children\":\"@Configuration\\r\\npublic class RestClientConfig {\\r\\n\\r\\n    @Bean\\r\\n    RestClient restClient(RestClient.Builder builder) {\\r\\n\\r\\n        final RestClient client = builder\\r\\n                .defaultHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)\\r\\n                .defaultHeader(\\\"header1\\\", \\\"header1-value\\\")\\r\\n                .defaultHeader(\\\"header2\\\", \\\"header2-value\\\")\\r\\n                .build();\\r\\n\\r\\n        return client;\\r\\n    }\\r\\n}\\n\"}]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"3.2.4 Spring Cloud OpenFeign\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"如果要令到 OpenFeign 識得喺 request header 度 forward micrometer tracing 既 data 去目標既 microservice 度，只需要喺 \",[\"$\",\"code\",null,{\"children\":\"pom.xml\"}],\" 加入 \",[\"$\",\"code\",null,{\"children\":\"io.github.openfeign:feign-micrometer\"}],\" 既 Maven dependency。\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"呢個 dependency 既版本由以下既 dependency management BOMs 控制。\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"org.springframework.cloud:spring-cloud-dependencies\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"org.springframework.cloud:spring-cloud-openfeign-dependencies\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"io.github.openfeign:feign-bom\"}]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"3.3 Logback 配置\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"最後一步，我地需要喺 \",[\"$\",\"code\",null,{\"children\":\"logback.xml\"}],\" 裡面加入 trace ID 以及 span ID 既 MDC fields，咁喺 application logs 度就可以睇到佢地。\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"因為係 distributed microservices 既關係，我地如果用好似 ELK 咁既 centralized logging platform 既話，一定要可以分得到唔同既 microservices 既 logs，咁就要喺 \",[\"$\",\"code\",null,{\"children\":\"logback.xml\"}],\" 既 encoders 度配置好：\"]}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Host name，可以直接用 \",[\"$\",\"code\",null,{\"children\":\"$${HOSTNAME:-}\"}],\" 或者 \",[\"$\",\"code\",null,{\"children\":\"$${hostname:-}\"}],\"。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Spring application name，可以加入以下既配置，之後就可以用 \",[\"$\",\"code\",null,{\"children\":\"$${app_name:-}\"}],\"：\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-xml\",\"children\":\"\u003c!-- 喺 configuration 裡面 --\u003e\\r\\n\u003cspringProperty scope=\\\"context\\\" name=\\\"app_name\\\" source=\\\"spring.application.name\\\" /\u003e\\n\"}]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"詳情可以睇返呢篇：\",[\"$\",\"a\",null,{\"href\":\"/blog/spring-boot-elk-logging\",\"children\":\"Spring 項目使用 ELK 做 logging\"}],\"。\"]}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"3.3.1 自定義 encoder pattern\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"如果要喺自定義既 encoder pattern 裡面加入 trace ID 以及 span ID，我地可以用：\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"%X{traceId:-}\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"code\",null,{\"children\":\"%X{spanId:-}\"}]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"例子：\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-xml\",\"children\":\"\u003c!-- 喺 appender 裡面 --\u003e\\r\\n\u003cencoder\u003e\\r\\n\\t\u003cpattern\u003e[${hostname:-} ${app_name:-}] [%X{traceId:-} %X{spanId:-}] %d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} (%file:%line\\\\) - %msg%n\u003c/pattern\u003e\\r\\n\u003c/encoder\u003e\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"註：\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"呢度既 \",[\"$\",\"code\",null,{\"children\":\":-\"}],\" 係用黎分隔 key、value 既字符，佢既前面係 MDC key，後面係 value。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"佢同 Spring 既 \",[\"$\",\"code\",null,{\"children\":\":\"}],\" 一樣意思，只不過係 Logback 揀左用 \",[\"$\",\"code\",null,{\"children\":\":-\"}],\"。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"%X{key:-}\"}],\" 既意思係如果 \",[\"$\",\"code\",null,{\"children\":\"key\"}],\" 呢個 MDC key 未有 data 既話就會出 empty string（唔好誤以為會出 \",[\"$\",\"code\",null,{\"children\":\"-\"}],\"）。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"%X{key:-foo}\"}],\" 既意思係如果 \",[\"$\",\"code\",null,{\"children\":\"key\"}],\" 呢個 MDC key 未有 data 既話就會出 \",[\"$\",\"code\",null,{\"children\":\"foo\"}],\"。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"3.3.2 Logstash Logback Encoder\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"如果係用 Logstash Logback Encoder，亦即係 \",[\"$\",\"code\",null,{\"children\":\"net.logstash.logback:logstash-logback-encoder\"}],\" 既 Maven dependency，咁我地就要用佢既 \",[\"$\",\"code\",null,{\"children\":\"includeMdcKeyName\"}],\" XML element 去加入 trace ID 以及 span ID：\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-xml\",\"children\":\"\u003c!-- 喺 appender 裡面 --\u003e\\r\\n\u003cencoder class=\\\"net.logstash.logback.encoder.LogstashEncoder\\\"\u003e\\r\\n\\t\u003cincludeContext\u003efalse\u003c/includeContext\u003e\\r\\n\\t\u003cincludeMdcKeyName\u003etraceId\u003c/includeMdcKeyName\u003e\\r\\n\\t\u003cincludeMdcKeyName\u003espanId\u003c/includeMdcKeyName\u003e\\r\\n\\t\u003ccustomFields\u003e{ \\\"host\\\": \\\"${hostname:-}\\\", \\\"app_name\\\": \\\"${app_name:-}\\\" }\u003c/customFields\u003e\\r\\n\u003c/encoder\u003e\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"加左之後，每一個 log entry 既 JSON data 裡面都會多左 \",[\"$\",\"code\",null,{\"children\":\"traceId\"}],\" 以及 \",[\"$\",\"code\",null,{\"children\":\"spanId\"}],\" 既 key-value pairs。\"]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h1\",null,{\"children\":\"4 測試\"}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"4.1 本地測試\"}],\"\\n\",[\"$\",\"ol\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"我地需要 set up 至少兩個 Spring Boot microservices。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"全部 microservices 都要 expose 至少一個 HTTP REST endpoints。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"除左最後一個只會被 call 但唔會 initiate call 既 microservice，我地要為所有作為 upstream 既其他 microservices 寫 HTTP call 既 code。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"HTTP REST call flow：Service A ➜ Service B ➜ Service C 等等。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"HTTP REST call 既 implementation 可以係 \",[\"$\",\"code\",null,{\"children\":\"RestTemplate\"}],\"、\",[\"$\",\"code\",null,{\"children\":\"WebClient\"}],\"、\",[\"$\",\"code\",null,{\"children\":\"RestClient\"}],\" 或者 OpenFeign。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"用 cURL call Service A 既 HTTP REST endpoint。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"檢查所有 microservices 既 console logs。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"應該會見到只有一個 \",[\"$\",\"code\",null,{\"children\":\"32\"}],\" 個位長度 alphanumeric 既 trace ID。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"應該會見到每個 microservice 都有啲唔同既 \",[\"$\",\"code\",null,{\"children\":\"16\"}],\" 個位長度 alphanumeric 既 span IDs。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"再用 cURL call Service A 既 HTTP REST endpoint。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"再檢查所有 microservices 既 console logs。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"應該會見到一個完全唔同既 trace ID。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"應該會見到每個 microservice 又有啲唔同既 span IDs。\"}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"4.2 測試發送 logs 去 ELK\"}],\"\\n\",[\"$\",\"ol\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"我地需要 set up 至少兩個 Spring Boot microservices。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"我地要配置好全部 microservices 既 \",[\"$\",\"code\",null,{\"children\":\"logback.xml\"}],\"，將 \",[\"$\",\"code\",null,{\"children\":\"\u003cappender\u003e\"}],\" 既 \",[\"$\",\"code\",null,{\"children\":\"\u003cdestination\u003e\"}],\" 配置為 \",[\"$\",\"code\",null,{\"children\":\"127.0.0.1:5000\"}],\"，咁啲 logs 就會發送到本地部署既 Logstash。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"全部 microservices 都要 expose 至少一個 HTTP REST endpoints。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"除左最後一個只會被 call 但唔會 initiate call 既 microservice，我地要為所有作為 upstream 既其他 microservices 寫 HTTP call 既 code。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"HTTP REST call flow：Service A ➜ Service B ➜ Service C 等等。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"HTTP REST call 既 implementation 可以係 \",[\"$\",\"code\",null,{\"children\":\"RestTemplate\"}],\"、\",[\"$\",\"code\",null,{\"children\":\"WebClient\"}],\"、\",[\"$\",\"code\",null,{\"children\":\"RestClient\"}],\" 或者 OpenFeign。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"用 cURL call Service A 既 HTTP REST endpoint。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"打開 \",[\"$\",\"a\",null,{\"href\":\"http://localhost:5601\",\"children\":\"http://localhost:5601\"}],\" 檢查我地喺 Kibana 既 data view。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"應該會見到只有一個 \",[\"$\",\"code\",null,{\"children\":\"32\"}],\" 個位長度 alphanumeric 既 trace ID。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"應該會見到每個 microservice 都有啲唔同既 \",[\"$\",\"code\",null,{\"children\":\"16\"}],\" 個位長度 alphanumeric 既 span IDs。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"再用 cURL call Service A 既 HTTP REST endpoint。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"再打開 \",[\"$\",\"a\",null,{\"href\":\"http://localhost:5601\",\"children\":\"http://localhost:5601\"}],\" 檢查我地喺 Kibana 既 data view。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"應該會見到一個完全唔同既 trace ID。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"應該會見到每個 microservice 又有啲唔同既 span IDs。\"}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"我地可以撳落 \",[\"$\",\"code\",null,{\"children\":\"traceId\"}],\" column 既某一個 cell value 隔籬既 \",[\"$\",\"code\",null,{\"children\":\"⊕\"}],\" 號（「Filter for this traceId」），咁就可以睇曬所有同呢個 trace ID 有關係既 logs。\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"img\",null,{\"src\":\"blog/2024-03/spring-boot-micrometer-tracing/kibana-search-logs-with-traceId.png\",\"alt\":\"\"}]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h1\",null,{\"children\":\"5 參考資料\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://spring.io/blog/2022/10/12/observability-with-spring-boot-3\",\"children\":\"Spring 官方 blog - Observability with Spring Boot 3\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://docs.spring.io/spring-framework/reference/integration/observability.html\",\"children\":\"Spring 官方文檔 - Observability Support\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://github.com/logfellow/logstash-logback-encoder?tab=readme-ov-file#mdc-fields\",\"children\":\"GitHub - logfellow/logstash-logback-encoder - Logstash Logback Encoder - MDC fields\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://opentelemetry.io/docs/concepts/signals/traces/\",\"children\":\"OpenTelemetry - Traces\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://github.com/w3c/trace-context/blob/main/spec/20-http_request_header_format.md\",\"children\":\"GitHub - w3c/trace-context - Trace Context HTTP Request Headers Format\"}]}],\"\\n\"]}]],null,[\"$\",\"$Lf\",null,{\"children\":\"$L10\"}]]}],{},null,false]},null,false]},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$1\",\"B38LA37t35l-l4yppiXX7\",{\"children\":[[\"$\",\"$L11\",null,{\"children\":\"$L12\"}],[\"$\",\"$L13\",null,{\"children\":\"$L14\"}],null]}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$15\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"14:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n12:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"Michael Chung's e-Portfolio\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"Powered by Next.js and React\"}]]\n"])</script><script>self.__next_f.push([1,"10:null\n"])</script></body></html>