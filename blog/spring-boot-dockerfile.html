<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" as="image" href="/blog/2024-03/spring-boot-dockerfile/snyk-best-practices.png"/><link rel="preload" as="image" href="/blog/2024-03/spring-boot-dockerfile/k8s-probes.jpg"/><link rel="stylesheet" href="/e2-next/_next/static/css/d3df112486f97f47.css" data-precedence="next"/><link rel="stylesheet" href="/e2-next/_next/static/css/c3624a693ae5a0c4.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/e2-next/_next/static/chunks/webpack-f088da4552bcc253.js"/><script src="/e2-next/_next/static/chunks/4bd1b696-120f4d9c40d223dd.js" async=""></script><script src="/e2-next/_next/static/chunks/1517-c8d232d43a11224c.js" async=""></script><script src="/e2-next/_next/static/chunks/main-app-05c45cc8f30d6cea.js" async=""></script><script src="/e2-next/_next/static/chunks/7829-b7b9eb1dbe0d40e4.js" async=""></script><script src="/e2-next/_next/static/chunks/2153-45fd9844831c6348.js" async=""></script><script src="/e2-next/_next/static/chunks/app/layout-ea91c2d128ec48c2.js" async=""></script><script src="/e2-next/_next/static/chunks/app/page-c8b940db14fac9a0.js" async=""></script><title>Michael Chung&#x27;s e-Portfolio</title><meta name="description" content="Powered by Next.js and React"/><link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&amp;display=swap" rel="stylesheet"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/><script src="/e2-next/_next/static/chunks/polyfills-42372ed130431b0a.js" noModule=""></script></head><body><div class="vstack gap-5"><div class="text-center vstack gap-5"><div><code class="SiteHeader_name__cwQmL">Chung Cheuk Hang Michael</code><code class="SiteHeader_title__CCfvI">Java Web Developer</code></div><nav class="justify-content-center navbar navbar-expand-md navbar-dark"><button type="button" aria-label="Toggle navigation" class="navbar-toggler collapsed"><span class="navbar-toggler-icon"></span></button><div class="justify-content-center navbar-collapse collapse"><div class="justify-content-center navbar-nav nav-underline"><div class="nav-item"><a draggable="false" data-rr-ui-event-key="/" class="nav-link" href="/e2-next">Home</a></div><div class="nav-item"><a draggable="false" data-rr-ui-event-key="/work" class="nav-link" href="/e2-next/work">Work</a></div><div class="nav-item"><a draggable="false" data-rr-ui-event-key="/hobbyProjects" class="nav-link" href="/e2-next/hobbyProjects">Hobby projects</a></div><div class="nav-item"><a draggable="false" data-rr-ui-event-key="/personality" class="nav-link" href="/e2-next/personality">Personality</a></div><div class="nav-item"><a draggable="false" data-rr-ui-event-key="/blog" class="nav-link" href="/e2-next/blog">Blog</a></div></div></div></nav></div><h1>1 Spring Boot 項目</h1>
<h2>1.1 Maven dependencies</h2>
<pre><code class="language-xml">&lt;parent&gt;
	&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
	&lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
	&lt;version&gt;3.2.4&lt;/version&gt;
&lt;/parent&gt;

&lt;dependencies&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
		&lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
	&lt;/dependency&gt;
	&lt;dependency&gt;
		&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
		&lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
	&lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>
<hr/>
<h2>1.2 Main class</h2>
<pre><code class="language-java">@SpringBootApplication
public class MainApplication {

    public static void main(String[] args) {
        SpringApplication.run(MainApplication.class, args);
    }
}
</code></pre>
<hr/>
<h2>1.3 Application 配置</h2>
<p><code>application.yml</code>：</p>
<pre><code class="language-yaml">management:
    endpoints:
        web:
            exposure:
                include: health,info,env,beans,loggers

# 等目前既 HTTP requests 完成曬之後先會 shutdown，等候時間上限 60 秒
server:
    shutdown: graceful
spring:
    lifecycle:
        timeout-per-shutdown-phase: 60s
</code></pre>
<hr/>
<h1>2 Dockerfile</h1>
<p>關於 OpenJDK 用 <code>jlink</code> command 保留有需要既 modules，可以睇返呢篇：<a href="/blog/custom-jre">客製化 JRE</a>。</p>
<h2>2.1 只有 OpenJDK 既 Dockerfile</h2>
<pre><code class="language-plaintext">FROM mcr.microsoft.com/openjdk/jdk:17-ubuntu AS jre-stage

RUN jlink \
 --add-modules \
java.base,\
java.compiler,\
java.datatransfer,\
java.desktop,\
java.instrument,\
java.logging,\
java.management,\
java.management.rmi,\
java.naming,\
java.net.http,\
java.prefs,\
java.rmi,\
java.scripting,\
java.se,\
java.security.jgss,\
java.security.sasl,\
java.smartcardio,\
java.sql,\
java.sql.rowset,\
java.transaction.xa,\
java.xml,\
java.xml.crypto,\
jdk.accessibility,\
jdk.charsets,\
jdk.crypto.cryptoki,\
jdk.crypto.ec,\
jdk.dynalink,\
jdk.httpserver,\
jdk.internal.ed,\
jdk.internal.le,\
jdk.internal.vm.ci,\
jdk.internal.vm.compiler,\
jdk.internal.vm.compiler.management,\
jdk.jdwp.agent,\
jdk.jfr,\
jdk.jsobject,\
jdk.localedata,\
jdk.management,\
jdk.management.agent,\
jdk.management.jfr,\
jdk.naming.dns,\
jdk.naming.rmi,\
jdk.net,\
jdk.nio.mapmode,\
jdk.random,\
jdk.sctp,\
jdk.security.auth,\
jdk.security.jgss,\
jdk.unsupported,\
jdk.xml.dom,\
jdk.zipfs \
 --strip-debug \
 --no-man-pages \
 --no-header-files \
 --compress=2 \
 --output /javaruntime



FROM ubuntu:22.04

# VOLUME /tmp
EXPOSE 8080

RUN mkdir -m 445 /app &amp;&amp; mkdir -m 445 /app/jre
WORKDIR /app

RUN addgroup --system mygroup &amp;&amp; adduser --system --shell /bin/false --ingroup mygroup myuser
USER myuser

ENV PATH &quot;/app/jre/bin:$PATH&quot;
COPY --from=jre-stage  --chown=root:root --chmod=445 /javaruntime /app/jre

# CMD &quot;java&quot; &quot;-jar&quot; &quot;app.jar&quot;
ENTRYPOINT [&quot;java&quot;, &quot;-jar&quot;, &quot;app.jar&quot;]

COPY --chown=root:root --chmod=444 /target/app.jar app.jar
</code></pre>
<h3>2.1.1 Build script</h3>
<p>我地可以配合以下既 build script：</p>
<pre><code class="language-bash">CALL mvn clean package

PUSHD target
REN *.jar app.jar
POPD

docker image build -t spring-boot-3-docker-test -f Dockerfile-openjdk.txt .
</code></pre>
<p>註：將 Dockerfile 保存做 <code>Dockerfile-openjdk.txt</code>。</p>
<hr/>
<h2>2.2 行埋 Maven build 既 Dockerfile</h2>
<pre><code class="language-plaintext">FROM maven:3.9.6-eclipse-temurin-17 AS mvn-stage
RUN mkdir /project
COPY . /project
WORKDIR /project
RUN mvn clean package &amp;&amp; mv /project/target/*.jar /project/target/app.jar



FROM mcr.microsoft.com/openjdk/jdk:17-ubuntu AS jre-stage

RUN jlink \
 --add-modules \
java.base,\
java.compiler,\
java.datatransfer,\
java.desktop,\
java.instrument,\
java.logging,\
java.management,\
java.management.rmi,\
java.naming,\
java.net.http,\
java.prefs,\
java.rmi,\
java.scripting,\
java.se,\
java.security.jgss,\
java.security.sasl,\
java.smartcardio,\
java.sql,\
java.sql.rowset,\
java.transaction.xa,\
java.xml,\
java.xml.crypto,\
jdk.accessibility,\
jdk.charsets,\
jdk.crypto.cryptoki,\
jdk.crypto.ec,\
jdk.dynalink,\
jdk.httpserver,\
jdk.internal.ed,\
jdk.internal.le,\
jdk.internal.vm.ci,\
jdk.internal.vm.compiler,\
jdk.internal.vm.compiler.management,\
jdk.jdwp.agent,\
jdk.jfr,\
jdk.jsobject,\
jdk.localedata,\
jdk.management,\
jdk.management.agent,\
jdk.management.jfr,\
jdk.naming.dns,\
jdk.naming.rmi,\
jdk.net,\
jdk.nio.mapmode,\
jdk.random,\
jdk.sctp,\
jdk.security.auth,\
jdk.security.jgss,\
jdk.unsupported,\
jdk.xml.dom,\
jdk.zipfs \
 --strip-debug \
 --no-man-pages \
 --no-header-files \
 --compress=2 \
 --output /javaruntime



FROM ubuntu:22.04

# VOLUME /tmp
EXPOSE 8080

RUN mkdir -m 445 /app &amp;&amp; mkdir -m 445 /app/jre
WORKDIR /app

RUN addgroup --system mygroup &amp;&amp; adduser --system --shell /bin/false --ingroup mygroup myuser
USER myuser

ENV PATH &quot;/app/jre/bin:$PATH&quot;
COPY --from=jre-stage  --chown=root:root --chmod=445 /javaruntime /app/jre

# CMD &quot;java&quot; &quot;-jar&quot; &quot;app.jar&quot;
ENTRYPOINT [&quot;java&quot;, &quot;-jar&quot;, &quot;app.jar&quot;]

COPY --from=mvn-stage --chown=root:root --chmod=444 /project/target/app.jar app.jar
</code></pre>
<h3>2.2.1 Build script</h3>
<pre><code class="language-bash">docker image build -t spring-boot-3-docker-test -f Dockerfile-maven-and-openjdk.txt .
</code></pre>
<p>註：將 Dockerfile 保存做 <code>Dockerfile-maven-and-openjdk.txt</code>。</p>
<hr/>
<h2>2.3 詳細解釋</h2>
<ul>
<li>我地需要用到 Docker 既 multi-stage build 功能黎完成一啲事前準備功夫。<!-- -->
<ul>
<li>包括：<!-- -->
<ul>
<li>用 <code>jlink</code> 客製化 OpenJDK，淨係保留對我地有用既 Java modules。</li>
<li>用 <code>mvn</code> 打包個 Spring Boot 項目既 JAR 檔。</li>
</ul>
</li>
<li>呢啲事前準備功夫可以用 intermediate stages 黎達成，而呢啲 stages 所產生出黎既 containers 同最後既 Docker image 冇關係。</li>
<li>我地可以將 intermediate stages 裡面既 output 檔案抄去最終既 Docker image 度。</li>
<li>真正既 base image 係 <code>ubuntu</code>。</li>
</ul>
</li>
<li><code>VOLUME</code> instruction 係用黎定義我地個 Docker image 可能有啲需要保存既用戶數據。<!-- -->
<ul>
<li>Docker Desktop 既 behavior 係會自動建立 anonymous volume(s)，但如果我地用 <code>docker container run</code> 執行並且加左 <code>--rm</code>，咁個 container 結束既時候，Docker 就會自動刪除相關既 anonymous volume(s)。</li>
<li>如果喺 cloud 既 Kubernetes 上面運行，而 <code>readOnlyFilesystem</code> 設置左係 <code>true</code>，而 containerd 又設置左 <code>ignore_image_defined_volumes</code> 係 <code>true</code>，咁呢個 <code>VOLUME</code> instruction 會被無視。<!-- -->
<ul>
<li>喺個 Docker container 裡面執行 <code>mount</code> command 可以睇到 <code>Dockerfile</code> 既 <code>VOLUME</code> instructions 有冇令 volume mounts 生效到。</li>
</ul>
</li>
</ul>
</li>
<li><code>EXPOSE</code> instruction 係用黎定義我地個 app 會行喺咩 port 上面。</li>
<li><code>RUN</code> instruction 係用黎執行任意既 Linux commands。<!-- -->
<ul>
<li>為左減少 layers 既數量，我地要盡量將啲 commands 放到一個 <code>RUN</code> instruction 裡面，用 <code>&amp;&amp;</code> 黎串連多個 commands，咁 Docker 就只會為呢一個 <code>RUN</code> instruction 增加一個 layer。</li>
</ul>
</li>
<li><code>mkdir -m &lt;permission&gt;</code> 係用黎創建目錄，同時改變埋目錄既權限。</li>
<li><code>WORKDIR</code> instruction 會改變 container 既 working directory，影響後續 <code>RUN</code>、<code>CMD</code>、<code>ENTRYPOINT</code>、<code>COPY</code> 以及 <code>ADD</code> instructions 既 working directory。<!-- -->
<ul>
<li><code>docker container exec</code> 或者 <code>kubectl exec</code> 入去個 container 之後最初既 working directory 會係 <code>WORKDIR</code> instruction 定義既 path。</li>
<li>用 <code>pwd</code> command 可以顯示 working directory。</li>
<li>正因為咁，所以最後一句 <code>COPY</code> instruction 會將 <code>app.jar</code> 抄到去個 <code>ubuntu</code> base image 既 <code>/app</code>（working directory）。</li>
</ul>
</li>
<li><code>addgroup</code>、<code>adduser</code> 係用黎新增 group、新增 user。<!-- -->
<ul>
<li>加黎完全係為左安全需要。</li>
<li>因為 Docker 默認會用 <code>root</code> user 黎做曬所有野，我地唔希望個 Docker container 用一個有好大權限既 user。</li>
</ul>
</li>
<li><code>USER</code> instruction 會切換 user，影響後續既 <code>RUN</code> instructions，亦會影響 runtime 既時候執行 <code>CMD</code> 或者 <code>ENTRYPOINT</code> 既 user。<!-- -->
<ul>
<li>基於安全考慮，user 唔應該用默認既 <code>root</code>，否則就有好多權限。</li>
</ul>
</li>
<li><code>ENV</code> instructions 係用黎設置 environment variable。<!-- -->
<ul>
<li>我地要重新設置 <code>PATH</code> environment variable 係因為我地只係 base 左 <code>ubuntu</code> image，再將 OpenJDK 既 binaries 抄入去。如果唔設置 <code>PATH</code> 既話，<code>ubuntu</code> 就唔知道可以喺 <code>/app/jre/bin</code> 度 lookup <code>java</code> 執行檔。<!-- -->
<ul>
<li>修改 <code>PATH</code> 比較正路既做法係將要加入既 path 放喺左邊，然後用 <code>:</code> 同現時既 paths 分隔。放喺左邊既原因係如果有兩個或以上既 paths 存在相同既執行檔，咁 Linux 會用最左邊果個，亦即係話擺喺左邊既呢個方法喺呢個情況下會比較有效。</li>
</ul>
</li>
</ul>
</li>
<li><code>COPY</code> instruction 可以幫我地抄檔案或者目錄。<!-- -->
<ul>
<li><code>--from</code> 會幫我地由之前既 stage 既 file system 抄 <code>/javaruntime</code> 裡面啲野去 <code>ubuntu</code> 既 <code>/app/jre</code> 裡面。</li>
<li>如果冇 <code>--from</code>，就會由本地既 working directory 抄入去。</li>
<li>可以用 <code>--chown</code> 順便做埋 <code>chown</code>，將 owner、group 改做 <code>&lt;user&gt;:&lt;group&gt;</code>。</li>
<li>可以用 <code>--chmod</code> 順便做埋 <code>chmod</code>，修改權限。<!-- -->
<ul>
<li>例如將權限改做 <code>445</code>，咁 owner、group 只可以 read，而 public（其他 users 或者 groups）只可以 read、execute。</li>
</ul>
</li>
</ul>
</li>
<li><code>#</code> 係用黎寫 comment，咁果句就唔會生效。</li>
<li>我地可以用 <code>CMD</code> 或者 <code>ENTRYPOINT</code> instruction 黎話畀 Docker 知 Docker container 執行既時候應該行咩 commands。<!-- -->
<ul>
<li><code>CMD</code> 可以被覆蓋。</li>
<li><code>ENTRYPOINT</code> 唔可以被覆蓋，一定會執行。</li>
</ul>
</li>
<li>關於權限，我地既 OpenJDK、<code>app.jar</code> 既 owner、group 都係 <code>root</code>，但因為我地用左 <code>USER</code> instruction 切換左做 <code>myuser</code>，而呢個 user 屬於另一個叫 <code>mygroup</code> 既 group，所以佢地需要開放權限畀 public，咁 <code>myuser</code> 先可以用到佢地。<!-- -->
<ul>
<li><code>myuser</code> 需要 OpenJDK 既 read、execute 權限。</li>
<li><code>myuser</code> 需要 <code>app.jar</code> 既 read 權限，唔需要 execute 權限係因為佢唔係直接執行 <code>app.jar</code>，而係透過 OpenJDK 裡面既 <code>java</code>。</li>
</ul>
</li>
</ul>
<hr/>
<h1>3 執行</h1>
<h2>3.1 Docker Desktop</h2>
<pre><code class="language-bash">docker container run --rm -p 8080:8080 spring-boot-3-docker-test
</code></pre>
<p>Read-only file system 模式：</p>
<pre><code class="language-bash">docker container run --rm -p 8080:8080 --read-only spring-boot-3-docker-test
</code></pre>
<p>註：</p>
<ul>
<li>用左 <code>--read-only</code> 既話，一定要令到 <code>/tmp</code> 有 volume mount，從而令 <code>/tmp</code> 可以寫入。<!-- -->
<ul>
<li>否則，如果 Spring Boot 既 embedded Tomcat 喺 runtime 既時候創建唔到目錄或者寫入唔到落 temp folder 既話，就會令成個 Spring Boot microservice 啟動失敗。</li>
<li>用 Docker Desktop 既話可以利用 Dockerfile 既 <code>VOLUME /tmp</code> instruction。</li>
</ul>
</li>
</ul>
<hr/>
<h2>3.2 Kubernetes</h2>
<p>我地可以開啟 Docker Desktop 內置既 Kubernetes 功能，或者用某個 cloud provider 既 Kubernetes 服務。</p>
<p>關於 <code>kubectl</code> CLI 既 commands 可以睇返呢篇：<a href="/blog/kubectl-basics">kubectl 基本操作</a>。</p>
<h3>3.2.1 單獨 <code>Pod</code></h3>
<p><code>k8s-pod.yml</code>：</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
    name: spring-boot-3-docker-test
spec:
    terminationGracePeriodSeconds: 60 # 唔可以少過 Spring Boot 既 graceful shutdown 時限配置
    containers:
        - name: spring-boot-3-docker-test
          image: spring-boot-3-docker-test:latest
          imagePullPolicy: Never # 只限本地測試用
          securityContext:
              readOnlyRootFilesystem: true # 安全需要
          ports:
              - containerPort: 8080
          startupProbe:
              httpGet:
                  path: /actuator/health/liveness
                  port: 8080
              initialDelaySeconds: 5
              periodSeconds: 5
              failureThreshold: 30
          livenessProbe:
              httpGet:
                  path: /actuator/health/liveness
                  port: 8080
              initialDelaySeconds: 5
              periodSeconds: 10
              failureThreshold: 3
          readinessProbe:
              httpGet:
                  path: /actuator/health/readiness
                  port: 8080
              initialDelaySeconds: 5
              periodSeconds: 10
              failureThreshold: 3
          args: # 示範用 command line arguments 黎改變 Spring Boot behaviors
              - --logging.level.root=DEBUG
          resources:
              limits:
                  cpu: 1000m
              requests:
                  cpu: 100m

          # 用 emptyDir 方法，令 /tmp 可以寫入
          volumeMounts:
              - name: empty-tmp-dir
                mountPath: /tmp
    volumes:
        - name: empty-tmp-dir
          emptyDir: {}
</code></pre>
<p>保存左個檔案之後執行：</p>
<pre><code class="language-bash">kubectl apply -f k8s-pod.yml
</code></pre>
<p>之後 port-forward 個 K8s <code>Pod</code>：</p>
<pre><code class="language-bash">kubectl port-forward spring-boot-3-docker-test 8080
</code></pre>
<hr/>
<h3>3.2.2 <code>Deployment</code></h3>
<p><code>k8s-deployment.yml</code>：</p>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
    name: spring-boot-3-docker-test-deployment
spec:
    replicas: 2 # 呢個會係固定數量
    selector:
        matchLabels:
            app: spring-boot-3-docker-test
    template:
        metadata:
            labels:
                app: spring-boot-3-docker-test
        spec:
            terminationGracePeriodSeconds: 60 # 唔可以少過 Spring Boot 既 graceful shutdown 時限配置
            containers:
                - name: spring-boot-3-docker-test
                  image: spring-boot-3-docker-test:latest
                  imagePullPolicy: Never # 只限本地測試用
                  securityContext:
                      readOnlyRootFilesystem: true # 安全需要
                  ports:
                      - containerPort: 8080
                  startupProbe:
                      httpGet:
                          path: /actuator/health/liveness
                          port: 8080
                      initialDelaySeconds: 5
                      periodSeconds: 5
                      failureThreshold: 30
                  livenessProbe:
                      httpGet:
                          path: /actuator/health/liveness
                          port: 8080
                      initialDelaySeconds: 5
                      periodSeconds: 10
                      failureThreshold: 3
                  readinessProbe:
                      httpGet:
                          path: /actuator/health/readiness
                          port: 8080
                      initialDelaySeconds: 5
                      periodSeconds: 10
                      failureThreshold: 3
                  args: # 示範用 command line arguments 黎改變 Spring Boot behaviors
                      - --logging.level.root=DEBUG
                  resources:
                      limits:
                          cpu: 1000m
                      requests:
                          cpu: 100m

                  # 用 emptyDir 方法，令 /tmp 可以寫入
                  volumeMounts:
                      - name: empty-tmp-dir
                        mountPath: /tmp
            volumes:
                - name: empty-tmp-dir
                  emptyDir: {}
</code></pre>
<p>保存左個檔案之後執行：</p>
<pre><code class="language-bash">kubectl apply -f k8s-deployment.yml
</code></pre>
<p>之後 port-forward 個 K8s <code>Deployment</code>：</p>
<pre><code class="language-bash">kubectl port-forward deployment/spring-boot-3-docker-test-deployment 8080
</code></pre>
<hr/>
<h2>3.3 測試</h2>
<p>可以檢查下 Spring Boot Actuator 既 HTTP REST endpoints：</p>
<pre><code class="language-bash">curl http://localhost:8080/actuator/health
curl http://localhost:8080/actuator/health/liveness
curl http://localhost:8080/actuator/health/readiness
curl http://localhost:8080/actuator/info
curl http://localhost:8080/actuator/env
curl http://localhost:8080/actuator/beans
curl http://localhost:8080/actuator/loggers
</code></pre>
<hr/>
<h2>3.4 詳細解釋</h2>
<ul>
<li>Spring Boot 本身具備 cloud awareness。<!-- -->
<ul>
<li>喺呢個測試項目裡面，我地用左 Spring Boot Actuator，而個 Spring Boot microservice 又喺 Kubernetes 上面運行。</li>
<li>Spring Boot 會 check 到有 <code>KUBERNETES_SERVICE_HOST</code>、<code>KUBERNETES_SERVICE_PORT</code> 呢兩個 environment variables。</li>
<li>所以 Spring Boot 就知道佢而家喺 Kubernetes 上面行緊，就會自動 expose <code>/actuator/health/liveness</code>、<code>/actuator/health/readiness</code> 呢兩個 HTTP REST endpoints。</li>
</ul>
</li>
<li>我地配置 Kubernetes 既 <code>terminationGracePeriodSeconds</code> 秒數唔應該少過我地配置既 Spring Boot graceful shutdown 既 <code>spring.lifecycle.timeout-per-shutdown-phase</code> 配置時限。<!-- -->
<ul>
<li>Spring Boot 默認係會即時 shutdown，無視未完成既 HTTP requests。<!-- -->
<ul>
<li>我地當然唔想有 HTTP requests 突然被中斷，所以我地要指示 Spring Boot 用 graceful shutdown 方式，並且將 shutdown timeout 設置到一個合理既數值。<!-- -->
<ul>
<li>將 <code>server.shutdown</code> 設置做 <code>graceful</code>。</li>
<li><code>spring.lifecycle.timeout-per-shutdown-phase</code> 既默認值係 <code>30</code> 秒。</li>
</ul>
</li>
<li>設置好之後，Spring Boot 會等到當時未完成既 HTTP requests 都完成曬或者到左 shutdown timeout 既時限先至 shutdown。</li>
</ul>
</li>
<li>Kubernetes 都有默認 <code>30</code> 秒既 <code>terminationGracePeriodSeconds</code> 配置。<!-- -->
<ul>
<li>如果我地有配置到比 <code>30</code> 秒長既 Spring Boot shutdown timeout，咁我地都要配置埋 Kubernetes 果個。</li>
</ul>
</li>
<li>例子／測試方法<!-- -->
<ol>
<li>我地既 Spring Boot microservice 可以 expose 一個會 <code>Thread.sleep(100_000)</code>（暫停 <code>100</code> 秒）既 HTTP REST endpoint。</li>
<li>然後設置 Spring Boot graceful shutdown、shutdown timeout 做 <code>120</code> 秒。</li>
<li>重新 build 個 Spring Boot Docker image。</li>
<li>然後喺部署 Kubernetes 既 YAML 配置檔度設置 termination grace period 做 <code>120</code> 秒。</li>
<li>用 <code>kubectl apply</code> 部署個 Spring Boot microservice 既 K8s <code>Deployment</code>。</li>
<li>我地 port-forward 其中一個 <code>Pod</code>，然後用 Postman 或者 Bruno 去 call 個新 endpoint。</li>
<li>我地即刻執行 <code>kubectl rollout restart deployment spring-boot-3-docker-test-deployment</code>。</li>
<li>我地會見到 Postman 或者 Bruno 可以執行個 HTTP request 長達 <code>120</code> 秒，到成功返回 HTTP response 之後 Kubernetes 先會結束個 <code>Pod</code>，然後用新既去取代佢。</li>
</ol>
</li>
</ul>
</li>
<li>Kubernetes 提供左唔同既 probes 配置去驗證個 <code>Pod</code> 到底正唔正常。<!-- -->
<ul>
<li>佢可以持續咁自動 call 個 <code>Pod</code> 既一啲 HTTP endpoints。<!-- -->
<ul>
<li>成功既定義係 HTTP response status code 要係 <code>200</code> 至 <code>399</code>。</li>
</ul>
</li>
<li>Probes<!-- -->
<ul>
<li>如果 startup probe 既 HTTP endpoint fail 左，Kubernetes 就會回收個 <code>Pod</code>。</li>
<li>如果 liveness probe 既 HTTP endpoint fail 左，Kubernetes 就會回收個 <code>Pod</code>。</li>
<li>如果 readiness probe 既 HTTP endpoint fail 左，Kubernetes 就會唔畀 traffic 去呢個 <code>Pod</code> 度。</li>
</ul>
</li>
<li><code>initialDelaySeconds</code> 係初始化既時候，Kubernetes 應該等幾耐先開始驗證。</li>
<li><code>periodSeconds</code> 係初始化完成之後，Kubernetes 每隔幾耐需要驗證。</li>
<li><code>failureThreshold</code> 可以允許幾次失敗。</li>
</ul>
</li>
<li>Spring Boot Actuator 提供左對應 Kubernetes liveness、readiness probes 既 HTTP REST endpoints。<!-- -->
<ul>
<li><code>/actuator/health/liveness</code> 可以用落 Kubernetes 既 liveness probe。</li>
<li><code>/actuator/health/readiness</code> 可以用落 Kubernetes 既 readiness probe。<!-- -->
<ul>
<li>呢個 endpoint 返回 HTTP response status code <code>200</code> 既話，即係表示個 HTTP server 已經準備好接受 HTTP requests。</li>
</ul>
</li>
<li>Liveness endpoint 返回正面既結果，唔代表 readiness endpoint 會返回正面既結果，因為個 HTTP server 未必準備好接受 HTTP requests。</li>
<li>如果 readiness endpoint 返回正面既結果，咁 liveness endpoint 都應該返回正面既結果。</li>
</ul>
</li>
<li>Spring Boot Actuator 冇提供對應 Kubernetes startup probe 既 startup endpoint。<!-- -->
<ul>
<li>有兩個解決方法：<!-- -->
<ol>
<li>我地可以用返 Spring Boot Actuator 既 liveness endpoint 作為 Kubernetes startup probe，然後配置一個好大既 <code>failureThreshold</code>，例如 <code>30</code> 次，配合短既 <code>periodSeconds</code>，例如 <code>5</code> 秒（即係最長 <code>2.5</code> 分鐘）。<!-- -->
<ul>
<li>呢個做法等於延續 Kubernetes liveness probe 既驗證時間。</li>
</ul>
</li>
<li>我地可以為 Kubernetes liveness、readiness probes 配置一個好大既 <code>initialDelaySeconds</code>，例如 <code>180</code> 秒，但呢個時間係固定既，時間越長就越會增加 scaling 既成本。</li>
</ol>
</li>
</ul>
</li>
<li>我地可以用 K8s <code>Deployment</code> 既 <code>replicas</code> 配置黎定義需要既 <code>Pod</code> 數量。<!-- -->
<ul>
<li>用呢個方法得到既 <code>Pod</code> 數量係固定既，唔會因應 <code>Pod</code> container 既 CPU、memory 情況而自動增加減少。<!-- -->
<ul>
<li>比較好既做法係用 K8s <code>HorizontalPodAutoscaler</code>。</li>
</ul>
</li>
<li>Kubernetes 會幫我地管理 <code>Pod</code>，盡可能保持我地要求既 <code>Pod</code> 數量。</li>
<li>Kubernetes 會幫我地自動創建一個 K8s <code>ReplicaSet</code>。</li>
</ul>
</li>
</ul>
<hr/>
<h2>3.5 注意事項</h2>
<ul>
<li>設置左 <code>readOnlyRootFilesystem</code> 做 <code>true</code> 既話，一定要令到 <code>/tmp</code> 有 volume mount，從而令 <code>/tmp</code> 可以寫入。<!-- -->
<ul>
<li>否則，如果 Spring Boot 既 embedded Tomcat 喺 runtime 既時候創建唔到目錄或者寫入唔到落 temp folder 既話，就會令成個 Spring Boot microservice 啟動失敗。</li>
<li>用 Docker Desktop 既 Kubernetes 既話，有兩個方法：<!-- -->
<ol>
<li>用 Kubernetes 正路既 <code>emptyDir</code> 方法。</li>
<li>Dockerfile 用 <code>VOLUME /tmp</code> instruction。</li>
</ol>
</li>
<li>用 cloud 既 Kubernetes 既話，有兩個方法：<!-- -->
<ol>
<li>用 Kubernetes 正路既 <code>emptyDir</code> 方法。</li>
<li>Dockerfile 用 <code>VOLUME /tmp</code> instruction，但 containerd 既 <code>ignore_image_defined_volumes</code> 一定要配合佢而設置做 <code>false</code>。</li>
</ol>
</li>
</ul>
</li>
</ul>
<hr/>
<h1>4 附錄</h1>
<h2>4.1 Snyk Java Dockerfile best practices</h2>
<p><img src="/blog/2024-03/spring-boot-dockerfile/snyk-best-practices.png" alt=""/></p>
<hr/>
<h2>4.2 Kubernetes pod lifecycle</h2>
<p><img src="/blog/2024-03/spring-boot-dockerfile/k8s-probes.jpg" alt=""/></p>
<hr/>
<h2>4.3 Read-only file system <code>/tmp</code> 寫入問題</h2>
<p>以下係如果我地冇整好 volume mount 落 <code>/tmp</code> 會造成既 startup error：</p>
<pre><code class="language-plaintext">Caused by: org.springframework.boot.web.server.WebServerException: Unable to create tempDir. java.io.tmpdir is set to /tmp
        at org.springframework.boot.web.server.AbstractConfigurableWebServerFactory.createTempDir(AbstractConfigurableWebServerFactory.java:241)
        at org.springframework.boot.web.embedded.tomcat.TomcatServletWebServerFactory.getWebServer(TomcatServletWebServerFactory.java:202)
        at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.createWebServer(ServletWebServerApplicationContext.java:188)
        at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.onRefresh(ServletWebServerApplicationContext.java:162)
        ... 15 common frames omitted
Caused by: java.nio.file.FileSystemException: /tmp/tomcat.8080.9381430298818445978: Read-only file system
        at java.base/sun.nio.fs.UnixException.translateToIOException(Unknown Source)
        at java.base/sun.nio.fs.UnixException.rethrowAsIOException(Unknown Source)
        at java.base/sun.nio.fs.UnixException.rethrowAsIOException(Unknown Source)
        at java.base/sun.nio.fs.UnixFileSystemProvider.createDirectory(Unknown Source)
        at java.base/java.nio.file.Files.createDirectory(Unknown Source)
        at java.base/java.nio.file.TempFileHelper.create(Unknown Source)
        at java.base/java.nio.file.TempFileHelper.createTempDirectory(Unknown Source)
        at java.base/java.nio.file.Files.createTempDirectory(Unknown Source)
        at org.springframework.boot.web.server.AbstractConfigurableWebServerFactory.createTempDir(AbstractConfigurableWebServerFactory.java:235)
        ... 18 common frames omitted
</code></pre>
<hr/>
<h1>5 參考資料</h1>
<ul>
<li><a href="https://docs.docker.com/reference/dockerfile/">Docker 官網 - Dockerfile reference</a></li>
<li><a href="https://docs.docker.com/build/building/multi-stage/">Docker 官網 - Multi-stage builds</a></li>
<li><a href="https://snyk.io/blog/best-practices-to-build-java-containers-with-docker/">Snyk - 10 best practices to build a Java container with Docker</a></li>
<li><a href="https://learn.microsoft.com/en-us/java/openjdk/containers#create-a-custom-java-runtime">Microsoft 官方文檔 - Container images for the Microsoft Build of OpenJDK - Create a custom Java runtime</a></li>
<li><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints.kubernetes-probes.lifecycle">Spring Boot 官方文檔 - Production-ready Features - 2.10.2. Application Lifecycle and Probe States</a></li>
<li><a href="https://andrewlock.net/deploying-asp-net-core-applications-to-kubernetes-part-6-adding-health-checks-with-liveness-readiness-and-startup-probes/">Adding health checks with Liveness, Readiness, and Startup probes</a></li>
<li><a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/">Kubernetes 官方文檔 - Configure Liveness, Readiness and Startup Probes</a></li>
<li><a href="https://kubernetes.io/docs/concepts/storage/volumes/#emptydir">Kubernetes 官方文檔 - Volumes - emptyDir</a></li>
</ul><hr/><div class="vstack gap-3"><div class="text-center container"><div class="justify-content-center g-3 row row-cols-md-3 row-cols-sm-2 row-cols-1"><div class="col"><a target="_blank" rel="external nofollow noopener noreferrer" class="SiteFooter_contact-item__2JRRr card" href="tel:+85263301333"><div class="card-body"><div class="card-title h5"><i class="fa-solid fa-phone" style="color:#009688"></i></div><p class="text-muted card-text">6330 1333<!-- --> </p></div></a></div><div class="col"><a target="_blank" rel="external nofollow noopener noreferrer" class="SiteFooter_contact-item__2JRRr card" href="mailto:michaelboyboy@gmail.com"><div class="card-body"><div class="card-title h5"><i class="fa-solid fa-envelope" style="color:#f44336"></i></div><p class="text-muted card-text">michaelboyboy@gmail.com<!-- --> </p></div></a></div><div class="col"><a target="_blank" rel="external nofollow noopener noreferrer" class="SiteFooter_contact-item__2JRRr card" href="https://www.linkedin.com/in/mickchung"><div class="card-body"><div class="card-title h5"><i class="fa-brands fa-linkedin" style="color:#2196f3"></i></div><p class="text-muted card-text">www.linkedin.com/in/mickchung<!-- --> </p></div></a></div></div></div></div></div><script src="/e2-next/_next/static/chunks/webpack-f088da4552bcc253.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0])</script><script>self.__next_f.push([1,"1:\"$Sreact.fragment\"\n2:I[8287,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"2153\",\"static/chunks/2153-45fd9844831c6348.js\",\"7177\",\"static/chunks/app/layout-ea91c2d128ec48c2.js\"],\"default\"]\n3:I[3339,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"8974\",\"static/chunks/app/page-c8b940db14fac9a0.js\"],\"default\"]\n4:I[1367,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"2153\",\"static/chunks/2153-45fd9844831c6348.js\",\"7177\",\"static/chunks/app/layout-ea91c2d128ec48c2.js\"],\"default\"]\n5:I[5244,[],\"\"]\n6:I[3866,[],\"\"]\n7:I[4798,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"8974\",\"static/chunks/app/page-c8b940db14fac9a0.js\"],\"default\"]\n8:I[6121,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"8974\",\"static/chunks/app/page-c8b940db14fac9a0.js\"],\"default\"]\n9:I[3667,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"8974\",\"static/chunks/app/page-c8b940db14fac9a0.js\"],\"default\"]\na:I[8407,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"2153\",\"static/chunks/2153-45fd9844831c6348.js\",\"7177\",\"static/chunks/app/layout-ea91c2d128ec48c2.js\"],\"default\"]\nb:I[8173,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"8974\",\"static/chunks/app/page-c8b940db14fac9a0.js\"],\"\"]\nc:I[3197,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"2153\",\"static/chunks/2153-45fd9844831c6348.js\",\"7177\",\"static/chunks/app/layout-ea91c2d128ec48c2.js\"],\"default\"]\nd:I[7933,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"2153\",\"static/chunks/2153-45fd9844831c6348.js\",\"7177\",\"static/chunks/app/layout-ea91c2d128ec48c2.js\"],\"default\"]\ne:I[3800,[\"7829\",\"static/chunks/7829-b7b9eb1dbe0d40e4.js\",\"2153\",\"static/chunks/2153-45fd9844831c6348.js\",\"7177\",\"static/chunks/app/layout-ea91c2d128ec48c2.js\"],\"default\"]\n14:I[6213,[],\"OutletBoundary\"]\n16:I[6213,[],\"MetadataBoundary\"]\n18:I[6213,[],\"ViewportBoundary\"]\n1a:I[4835,[],\"\"]\n:HL[\"/e2-next/_next/static/css/d3df112486f97f47.css\",\"style\"]\n:HL[\"/e2-next/_next/static/css/c3624a693ae5a0c4.css\",\"style\"]\nf:T636,FROM mcr.microsoft.com/openjdk/jdk:17-ubuntu AS jre-stage\r\n\r\nRUN jlink \\\r\n --add-modules \\\r\njava.base,\\\r\njava.compi"])</script><script>self.__next_f.push([1,"ler,\\\r\njava.datatransfer,\\\r\njava.desktop,\\\r\njava.instrument,\\\r\njava.logging,\\\r\njava.management,\\\r\njava.management.rmi,\\\r\njava.naming,\\\r\njava.net.http,\\\r\njava.prefs,\\\r\njava.rmi,\\\r\njava.scripting,\\\r\njava.se,\\\r\njava.security.jgss,\\\r\njava.security.sasl,\\\r\njava.smartcardio,\\\r\njava.sql,\\\r\njava.sql.rowset,\\\r\njava.transaction.xa,\\\r\njava.xml,\\\r\njava.xml.crypto,\\\r\njdk.accessibility,\\\r\njdk.charsets,\\\r\njdk.crypto.cryptoki,\\\r\njdk.crypto.ec,\\\r\njdk.dynalink,\\\r\njdk.httpserver,\\\r\njdk.internal.ed,\\\r\njdk.internal.le,\\\r\njdk.internal.vm.ci,\\\r\njdk.internal.vm.compiler,\\\r\njdk.internal.vm.compiler.management,\\\r\njdk.jdwp.agent,\\\r\njdk.jfr,\\\r\njdk.jsobject,\\\r\njdk.localedata,\\\r\njdk.management,\\\r\njdk.management.agent,\\\r\njdk.management.jfr,\\\r\njdk.naming.dns,\\\r\njdk.naming.rmi,\\\r\njdk.net,\\\r\njdk.nio.mapmode,\\\r\njdk.random,\\\r\njdk.sctp,\\\r\njdk.security.auth,\\\r\njdk.security.jgss,\\\r\njdk.unsupported,\\\r\njdk.xml.dom,\\\r\njdk.zipfs \\\r\n --strip-debug \\\r\n --no-man-pages \\\r\n --no-header-files \\\r\n --compress=2 \\\r\n --output /javaruntime\r\n\r\n\r\n\r\nFROM ubuntu:22.04\r\n\r\n# VOLUME /tmp\r\nEXPOSE 8080\r\n\r\nRUN mkdir -m 445 /app \u0026\u0026 mkdir -m 445 /app/jre\r\nWORKDIR /app\r\n\r\nRUN addgroup --system mygroup \u0026\u0026 adduser --system --shell /bin/false --ingroup mygroup myuser\r\nUSER myuser\r\n\r\nENV PATH \"/app/jre/bin:$PATH\"\r\nCOPY --from=jre-stage  --chown=root:root --chmod=445 /javaruntime /app/jre\r\n\r\n# CMD \"java\" \"-jar\" \"app.jar\"\r\nENTRYPOINT [\"java\", \"-jar\", \"app.jar\"]\r\n\r\nCOPY --chown=root:root --chmod=444 /target/app.jar app.jar\n10:T709,FROM maven:3.9.6-eclipse-temurin-17 AS mvn-stage\r\nRUN mkdir /project\r\nCOPY . /project\r\nWORKDIR /project\r\nRUN mvn clean package \u0026\u0026 mv /project/target/*.jar /project/target/app.jar\r\n\r\n\r\n\r\nFROM mcr.microsoft.com/openjdk/jdk:17-ubuntu AS jre-stage\r\n\r\nRUN jlink \\\r\n --add-modules \\\r\njava.base,\\\r\njava.compiler,\\\r\njava.datatransfer,\\\r\njava.desktop,\\\r\njava.instrument,\\\r\njava.logging,\\\r\njava.management,\\\r\njava.management.rmi,\\\r\njava.naming,\\\r\njava.net.http,\\\r\njava.prefs,\\\r\njava.rmi,\\\r\njava.scripting,\\\r\njava.se,\\\r\njava.security.jgss,\\\r\njava.security.sasl,\\\r\njava.smartca"])</script><script>self.__next_f.push([1,"rdio,\\\r\njava.sql,\\\r\njava.sql.rowset,\\\r\njava.transaction.xa,\\\r\njava.xml,\\\r\njava.xml.crypto,\\\r\njdk.accessibility,\\\r\njdk.charsets,\\\r\njdk.crypto.cryptoki,\\\r\njdk.crypto.ec,\\\r\njdk.dynalink,\\\r\njdk.httpserver,\\\r\njdk.internal.ed,\\\r\njdk.internal.le,\\\r\njdk.internal.vm.ci,\\\r\njdk.internal.vm.compiler,\\\r\njdk.internal.vm.compiler.management,\\\r\njdk.jdwp.agent,\\\r\njdk.jfr,\\\r\njdk.jsobject,\\\r\njdk.localedata,\\\r\njdk.management,\\\r\njdk.management.agent,\\\r\njdk.management.jfr,\\\r\njdk.naming.dns,\\\r\njdk.naming.rmi,\\\r\njdk.net,\\\r\njdk.nio.mapmode,\\\r\njdk.random,\\\r\njdk.sctp,\\\r\njdk.security.auth,\\\r\njdk.security.jgss,\\\r\njdk.unsupported,\\\r\njdk.xml.dom,\\\r\njdk.zipfs \\\r\n --strip-debug \\\r\n --no-man-pages \\\r\n --no-header-files \\\r\n --compress=2 \\\r\n --output /javaruntime\r\n\r\n\r\n\r\nFROM ubuntu:22.04\r\n\r\n# VOLUME /tmp\r\nEXPOSE 8080\r\n\r\nRUN mkdir -m 445 /app \u0026\u0026 mkdir -m 445 /app/jre\r\nWORKDIR /app\r\n\r\nRUN addgroup --system mygroup \u0026\u0026 adduser --system --shell /bin/false --ingroup mygroup myuser\r\nUSER myuser\r\n\r\nENV PATH \"/app/jre/bin:$PATH\"\r\nCOPY --from=jre-stage  --chown=root:root --chmod=445 /javaruntime /app/jre\r\n\r\n# CMD \"java\" \"-jar\" \"app.jar\"\r\nENTRYPOINT [\"java\", \"-jar\", \"app.jar\"]\r\n\r\nCOPY --from=mvn-stage --chown=root:root --chmod=444 /project/target/app.jar app.jar\n11:T698,apiVersion: v1\r\nkind: Pod\r\nmetadata:\r\n    name: spring-boot-3-docker-test\r\nspec:\r\n    terminationGracePeriodSeconds: 60 # 唔可以少過 Spring Boot 既 graceful shutdown 時限配置\r\n    containers:\r\n        - name: spring-boot-3-docker-test\r\n          image: spring-boot-3-docker-test:latest\r\n          imagePullPolicy: Never # 只限本地測試用\r\n          securityContext:\r\n              readOnlyRootFilesystem: true # 安全需要\r\n          ports:\r\n              - containerPort: 8080\r\n          startupProbe:\r\n              httpGet:\r\n                  path: /actuator/health/liveness\r\n                  port: 8080\r\n              initialDelaySeconds: 5\r\n              periodSeconds: 5\r\n              failureThreshold: 30\r\n          livenessProbe:\r\n              httpGet:\r\n                  pat"])</script><script>self.__next_f.push([1,"h: /actuator/health/liveness\r\n                  port: 8080\r\n              initialDelaySeconds: 5\r\n              periodSeconds: 10\r\n              failureThreshold: 3\r\n          readinessProbe:\r\n              httpGet:\r\n                  path: /actuator/health/readiness\r\n                  port: 8080\r\n              initialDelaySeconds: 5\r\n              periodSeconds: 10\r\n              failureThreshold: 3\r\n          args: # 示範用 command line arguments 黎改變 Spring Boot behaviors\r\n              - --logging.level.root=DEBUG\r\n          resources:\r\n              limits:\r\n                  cpu: 1000m\r\n              requests:\r\n                  cpu: 100m\r\n\r\n          # 用 emptyDir 方法，令 /tmp 可以寫入\r\n          volumeMounts:\r\n              - name: empty-tmp-dir\r\n                mountPath: /tmp\r\n    volumes:\r\n        - name: empty-tmp-dir\r\n          emptyDir: {}\n12:T902,"])</script><script>self.__next_f.push([1,"apiVersion: apps/v1\r\nkind: Deployment\r\nmetadata:\r\n    name: spring-boot-3-docker-test-deployment\r\nspec:\r\n    replicas: 2 # 呢個會係固定數量\r\n    selector:\r\n        matchLabels:\r\n            app: spring-boot-3-docker-test\r\n    template:\r\n        metadata:\r\n            labels:\r\n                app: spring-boot-3-docker-test\r\n        spec:\r\n            terminationGracePeriodSeconds: 60 # 唔可以少過 Spring Boot 既 graceful shutdown 時限配置\r\n            containers:\r\n                - name: spring-boot-3-docker-test\r\n                  image: spring-boot-3-docker-test:latest\r\n                  imagePullPolicy: Never # 只限本地測試用\r\n                  securityContext:\r\n                      readOnlyRootFilesystem: true # 安全需要\r\n                  ports:\r\n                      - containerPort: 8080\r\n                  startupProbe:\r\n                      httpGet:\r\n                          path: /actuator/health/liveness\r\n                          port: 8080\r\n                      initialDelaySeconds: 5\r\n                      periodSeconds: 5\r\n                      failureThreshold: 30\r\n                  livenessProbe:\r\n                      httpGet:\r\n                          path: /actuator/health/liveness\r\n                          port: 8080\r\n                      initialDelaySeconds: 5\r\n                      periodSeconds: 10\r\n                      failureThreshold: 3\r\n                  readinessProbe:\r\n                      httpGet:\r\n                          path: /actuator/health/readiness\r\n                          port: 8080\r\n                      initialDelaySeconds: 5\r\n                      periodSeconds: 10\r\n                      failureThreshold: 3\r\n                  args: # 示範用 command line arguments 黎改變 Spring Boot behaviors\r\n                      - --logging.level.root=DEBUG\r\n                  resources:\r\n                      limits:\r\n                          cpu: 1000m\r\n                      requests:\r\n                          cpu: 100m\r\n\r\n                  # 用 emptyDir 方法，令 /tmp 可以寫入\r\n                  volumeMounts:\r\n                      - name: empty-tmp-dir\r\n                        mountPath: /tmp\r\n            volumes:\r\n                - name: empty-tmp-dir\r\n                  emptyDir: {}\n"])</script><script>self.__next_f.push([1,"13:T69d,Caused by: org.springframework.boot.web.server.WebServerException: Unable to create tempDir. java.io.tmpdir is set to /tmp\r\n        at org.springframework.boot.web.server.AbstractConfigurableWebServerFactory.createTempDir(AbstractConfigurableWebServerFactory.java:241)\r\n        at org.springframework.boot.web.embedded.tomcat.TomcatServletWebServerFactory.getWebServer(TomcatServletWebServerFactory.java:202)\r\n        at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.createWebServer(ServletWebServerApplicationContext.java:188)\r\n        at org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.onRefresh(ServletWebServerApplicationContext.java:162)\r\n        ... 15 common frames omitted\r\nCaused by: java.nio.file.FileSystemException: /tmp/tomcat.8080.9381430298818445978: Read-only file system\r\n        at java.base/sun.nio.fs.UnixException.translateToIOException(Unknown Source)\r\n        at java.base/sun.nio.fs.UnixException.rethrowAsIOException(Unknown Source)\r\n        at java.base/sun.nio.fs.UnixException.rethrowAsIOException(Unknown Source)\r\n        at java.base/sun.nio.fs.UnixFileSystemProvider.createDirectory(Unknown Source)\r\n        at java.base/java.nio.file.Files.createDirectory(Unknown Source)\r\n        at java.base/java.nio.file.TempFileHelper.create(Unknown Source)\r\n        at java.base/java.nio.file.TempFileHelper.createTempDirectory(Unknown Source)\r\n        at java.base/java.nio.file.Files.createTempDirectory(Unknown Source)\r\n        at org.springframework.boot.web.server.AbstractConfigurableWebServerFactory.createTempDir(AbstractConfigurableWebServerFactory.java:235)\r\n        ... 18 common frames omitted\n"])</script><script>self.__next_f.push([1,"0:{\"P\":null,\"b\":\"wfZ4FdS4ntgGvzjeKJhfw\",\"p\":\"/e2-next\",\"c\":[\"\",\"blog\",\"spring-boot-dockerfile\"],\"i\":false,\"f\":[[[\"\",{\"children\":[\"blog\",{\"children\":[\"(2024-03)\",{\"children\":[\"spring-boot-dockerfile\",{\"children\":[\"__PAGE__\",{}]}]}]}]},\"$undefined\",\"$undefined\",true],[\"\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/e2-next/_next/static/css/d3df112486f97f47.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}],[\"$\",\"link\",\"1\",{\"rel\":\"stylesheet\",\"href\":\"/e2-next/_next/static/css/c3624a693ae5a0c4.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\",\"nonce\":\"$undefined\"}]],[\"$\",\"html\",null,{\"lang\":\"en\",\"children\":[[\"$\",\"head\",null,{\"children\":[[\"$\",\"link\",null,{\"href\":\"https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900\u0026display=swap\",\"rel\":\"stylesheet\"}],[\"$\",\"link\",null,{\"rel\":\"stylesheet\",\"href\":\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css\"}]]}],[\"$\",\"body\",null,{\"children\":[\"$\",\"$L2\",null,{\"children\":[\"$\",\"$L3\",null,{\"gap\":5,\"children\":[[\"$\",\"$L3\",null,{\"gap\":5,\"className\":\"text-center\",\"children\":[[\"$\",\"div\",null,{\"children\":[[\"$\",\"code\",null,{\"className\":\"SiteHeader_name__cwQmL\",\"children\":\"Chung Cheuk Hang Michael\"}],[\"$\",\"code\",null,{\"className\":\"SiteHeader_title__CCfvI\",\"children\":\"Java Web Developer\"}]]}],[\"$\",\"$L4\",null,{}]]}],[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L6\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[],[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":404}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]]],\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}],[\"$\",\"hr\",null,{}],[\"$\",\"$L3\",null,{\"gap\":3,\"children\":[\"$\",\"$L7\",null,{\"className\":\"text-center\",\"children\":[\"$\",\"$L8\",null,{\"xs\":1,\"sm\":2,\"md\":3,\"className\":\"justify-content-center g-3\",\"children\":[[\"$\",\"$L9\",\"0\",{\"children\":[\"$\",\"$La\",null,{\"as\":\"$b\",\"href\":\"tel:+85263301333\",\"target\":\"_blank\",\"rel\":\"external nofollow noopener noreferrer\",\"className\":\"SiteFooter_contact-item__2JRRr\",\"children\":[\"$\",\"$Lc\",null,{\"children\":[[\"$\",\"$Ld\",null,{\"children\":[\"$\",\"i\",null,{\"className\":\"fa-solid fa-phone\",\"style\":{\"color\":\"#009688\"}}]}],[\"$\",\"$Le\",null,{\"className\":\"text-muted\",\"children\":[\"6330 1333\",\" \"]}]]}]}]}],[\"$\",\"$L9\",\"1\",{\"children\":[\"$\",\"$La\",null,{\"as\":\"$b\",\"href\":\"mailto:michaelboyboy@gmail.com\",\"target\":\"_blank\",\"rel\":\"external nofollow noopener noreferrer\",\"className\":\"SiteFooter_contact-item__2JRRr\",\"children\":[\"$\",\"$Lc\",null,{\"children\":[[\"$\",\"$Ld\",null,{\"children\":[\"$\",\"i\",null,{\"className\":\"fa-solid fa-envelope\",\"style\":{\"color\":\"#f44336\"}}]}],[\"$\",\"$Le\",null,{\"className\":\"text-muted\",\"children\":[\"michaelboyboy@gmail.com\",\" \"]}]]}]}]}],[\"$\",\"$L9\",\"2\",{\"children\":[\"$\",\"$La\",null,{\"as\":\"$b\",\"href\":\"https://www.linkedin.com/in/mickchung\",\"target\":\"_blank\",\"rel\":\"external nofollow noopener noreferrer\",\"className\":\"SiteFooter_contact-item__2JRRr\",\"children\":[\"$\",\"$Lc\",null,{\"children\":[[\"$\",\"$Ld\",null,{\"children\":[\"$\",\"i\",null,{\"className\":\"fa-brands fa-linkedin\",\"style\":{\"color\":\"#2196f3\"}}]}],[\"$\",\"$Le\",null,{\"className\":\"text-muted\",\"children\":[\"www.linkedin.com/in/mickchung\",\" \"]}]]}]}]}]]}]}]}]]}]}]}]]}]]}],{\"children\":[\"blog\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L6\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"(2024-03)\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"(2024-03)\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L6\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"spring-boot-dockerfile\",[\"$\",\"$1\",\"c\",{\"children\":[null,[\"$\",\"$L5\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"(2024-03)\",\"children\",\"spring-boot-dockerfile\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$L6\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"forbidden\":\"$undefined\",\"unauthorized\":\"$undefined\"}]]}],{\"children\":[\"__PAGE__\",[\"$\",\"$1\",\"c\",{\"children\":[[[\"$\",\"h1\",null,{\"children\":\"1 Spring Boot 項目\"}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"1.1 Maven dependencies\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-xml\",\"children\":\"\u003cparent\u003e\\r\\n\\t\u003cgroupId\u003eorg.springframework.boot\u003c/groupId\u003e\\r\\n\\t\u003cartifactId\u003espring-boot-starter-parent\u003c/artifactId\u003e\\r\\n\\t\u003cversion\u003e3.2.4\u003c/version\u003e\\r\\n\u003c/parent\u003e\\r\\n\\r\\n\u003cdependencies\u003e\\r\\n\\t\u003cdependency\u003e\\r\\n\\t\\t\u003cgroupId\u003eorg.springframework.boot\u003c/groupId\u003e\\r\\n\\t\\t\u003cartifactId\u003espring-boot-starter-web\u003c/artifactId\u003e\\r\\n\\t\u003c/dependency\u003e\\r\\n\\t\u003cdependency\u003e\\r\\n\\t\\t\u003cgroupId\u003eorg.springframework.boot\u003c/groupId\u003e\\r\\n\\t\\t\u003cartifactId\u003espring-boot-starter-actuator\u003c/artifactId\u003e\\r\\n\\t\u003c/dependency\u003e\\r\\n\u003c/dependencies\u003e\\n\"}]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"1.2 Main class\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-java\",\"children\":\"@SpringBootApplication\\r\\npublic class MainApplication {\\r\\n\\r\\n    public static void main(String[] args) {\\r\\n        SpringApplication.run(MainApplication.class, args);\\r\\n    }\\r\\n}\\n\"}]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"1.3 Application 配置\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"application.yml\"}],\"：\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-yaml\",\"children\":\"management:\\r\\n    endpoints:\\r\\n        web:\\r\\n            exposure:\\r\\n                include: health,info,env,beans,loggers\\r\\n\\r\\n# 等目前既 HTTP requests 完成曬之後先會 shutdown，等候時間上限 60 秒\\r\\nserver:\\r\\n    shutdown: graceful\\r\\nspring:\\r\\n    lifecycle:\\r\\n        timeout-per-shutdown-phase: 60s\\n\"}]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h1\",null,{\"children\":\"2 Dockerfile\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"關於 OpenJDK 用 \",[\"$\",\"code\",null,{\"children\":\"jlink\"}],\" command 保留有需要既 modules，可以睇返呢篇：\",[\"$\",\"a\",null,{\"href\":\"/blog/custom-jre\",\"children\":\"客製化 JRE\"}],\"。\"]}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"2.1 只有 OpenJDK 既 Dockerfile\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-plaintext\",\"children\":\"$f\"}]}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"2.1.1 Build script\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"我地可以配合以下既 build script：\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-bash\",\"children\":\"CALL mvn clean package\\r\\n\\r\\nPUSHD target\\r\\nREN *.jar app.jar\\r\\nPOPD\\r\\n\\r\\ndocker image build -t spring-boot-3-docker-test -f Dockerfile-openjdk.txt .\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"註：將 Dockerfile 保存做 \",[\"$\",\"code\",null,{\"children\":\"Dockerfile-openjdk.txt\"}],\"。\"]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"2.2 行埋 Maven build 既 Dockerfile\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-plaintext\",\"children\":\"$10\"}]}],\"\\n\",[\"$\",\"h3\",null,{\"children\":\"2.2.1 Build script\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-bash\",\"children\":\"docker image build -t spring-boot-3-docker-test -f Dockerfile-maven-and-openjdk.txt .\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"註：將 Dockerfile 保存做 \",[\"$\",\"code\",null,{\"children\":\"Dockerfile-maven-and-openjdk.txt\"}],\"。\"]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"2.3 詳細解釋\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"我地需要用到 Docker 既 multi-stage build 功能黎完成一啲事前準備功夫。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"包括：\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"用 \",[\"$\",\"code\",null,{\"children\":\"jlink\"}],\" 客製化 OpenJDK，淨係保留對我地有用既 Java modules。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"用 \",[\"$\",\"code\",null,{\"children\":\"mvn\"}],\" 打包個 Spring Boot 項目既 JAR 檔。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"呢啲事前準備功夫可以用 intermediate stages 黎達成，而呢啲 stages 所產生出黎既 containers 同最後既 Docker image 冇關係。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"我地可以將 intermediate stages 裡面既 output 檔案抄去最終既 Docker image 度。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"真正既 base image 係 \",[\"$\",\"code\",null,{\"children\":\"ubuntu\"}],\"。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"VOLUME\"}],\" instruction 係用黎定義我地個 Docker image 可能有啲需要保存既用戶數據。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Docker Desktop 既 behavior 係會自動建立 anonymous volume(s)，但如果我地用 \",[\"$\",\"code\",null,{\"children\":\"docker container run\"}],\" 執行並且加左 \",[\"$\",\"code\",null,{\"children\":\"--rm\"}],\"，咁個 container 結束既時候，Docker 就會自動刪除相關既 anonymous volume(s)。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"如果喺 cloud 既 Kubernetes 上面運行，而 \",[\"$\",\"code\",null,{\"children\":\"readOnlyFilesystem\"}],\" 設置左係 \",[\"$\",\"code\",null,{\"children\":\"true\"}],\"，而 containerd 又設置左 \",[\"$\",\"code\",null,{\"children\":\"ignore_image_defined_volumes\"}],\" 係 \",[\"$\",\"code\",null,{\"children\":\"true\"}],\"，咁呢個 \",[\"$\",\"code\",null,{\"children\":\"VOLUME\"}],\" instruction 會被無視。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"喺個 Docker container 裡面執行 \",[\"$\",\"code\",null,{\"children\":\"mount\"}],\" command 可以睇到 \",[\"$\",\"code\",null,{\"children\":\"Dockerfile\"}],\" 既 \",[\"$\",\"code\",null,{\"children\":\"VOLUME\"}],\" instructions 有冇令 volume mounts 生效到。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"EXPOSE\"}],\" instruction 係用黎定義我地個 app 會行喺咩 port 上面。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"RUN\"}],\" instruction 係用黎執行任意既 Linux commands。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"為左減少 layers 既數量，我地要盡量將啲 commands 放到一個 \",[\"$\",\"code\",null,{\"children\":\"RUN\"}],\" instruction 裡面，用 \",[\"$\",\"code\",null,{\"children\":\"\u0026\u0026\"}],\" 黎串連多個 commands，咁 Docker 就只會為呢一個 \",[\"$\",\"code\",null,{\"children\":\"RUN\"}],\" instruction 增加一個 layer。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"mkdir -m \u003cpermission\u003e\"}],\" 係用黎創建目錄，同時改變埋目錄既權限。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"WORKDIR\"}],\" instruction 會改變 container 既 working directory，影響後續 \",[\"$\",\"code\",null,{\"children\":\"RUN\"}],\"、\",[\"$\",\"code\",null,{\"children\":\"CMD\"}],\"、\",[\"$\",\"code\",null,{\"children\":\"ENTRYPOINT\"}],\"、\",[\"$\",\"code\",null,{\"children\":\"COPY\"}],\" 以及 \",[\"$\",\"code\",null,{\"children\":\"ADD\"}],\" instructions 既 working directory。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"docker container exec\"}],\" 或者 \",[\"$\",\"code\",null,{\"children\":\"kubectl exec\"}],\" 入去個 container 之後最初既 working directory 會係 \",[\"$\",\"code\",null,{\"children\":\"WORKDIR\"}],\" instruction 定義既 path。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"用 \",[\"$\",\"code\",null,{\"children\":\"pwd\"}],\" command 可以顯示 working directory。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"正因為咁，所以最後一句 \",[\"$\",\"code\",null,{\"children\":\"COPY\"}],\" instruction 會將 \",[\"$\",\"code\",null,{\"children\":\"app.jar\"}],\" 抄到去個 \",[\"$\",\"code\",null,{\"children\":\"ubuntu\"}],\" base image 既 \",[\"$\",\"code\",null,{\"children\":\"/app\"}],\"（working directory）。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"addgroup\"}],\"、\",[\"$\",\"code\",null,{\"children\":\"adduser\"}],\" 係用黎新增 group、新增 user。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"加黎完全係為左安全需要。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"因為 Docker 默認會用 \",[\"$\",\"code\",null,{\"children\":\"root\"}],\" user 黎做曬所有野，我地唔希望個 Docker container 用一個有好大權限既 user。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"USER\"}],\" instruction 會切換 user，影響後續既 \",[\"$\",\"code\",null,{\"children\":\"RUN\"}],\" instructions，亦會影響 runtime 既時候執行 \",[\"$\",\"code\",null,{\"children\":\"CMD\"}],\" 或者 \",[\"$\",\"code\",null,{\"children\":\"ENTRYPOINT\"}],\" 既 user。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"基於安全考慮，user 唔應該用默認既 \",[\"$\",\"code\",null,{\"children\":\"root\"}],\"，否則就有好多權限。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"ENV\"}],\" instructions 係用黎設置 environment variable。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"我地要重新設置 \",[\"$\",\"code\",null,{\"children\":\"PATH\"}],\" environment variable 係因為我地只係 base 左 \",[\"$\",\"code\",null,{\"children\":\"ubuntu\"}],\" image，再將 OpenJDK 既 binaries 抄入去。如果唔設置 \",[\"$\",\"code\",null,{\"children\":\"PATH\"}],\" 既話，\",[\"$\",\"code\",null,{\"children\":\"ubuntu\"}],\" 就唔知道可以喺 \",[\"$\",\"code\",null,{\"children\":\"/app/jre/bin\"}],\" 度 lookup \",[\"$\",\"code\",null,{\"children\":\"java\"}],\" 執行檔。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"修改 \",[\"$\",\"code\",null,{\"children\":\"PATH\"}],\" 比較正路既做法係將要加入既 path 放喺左邊，然後用 \",[\"$\",\"code\",null,{\"children\":\":\"}],\" 同現時既 paths 分隔。放喺左邊既原因係如果有兩個或以上既 paths 存在相同既執行檔，咁 Linux 會用最左邊果個，亦即係話擺喺左邊既呢個方法喺呢個情況下會比較有效。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"COPY\"}],\" instruction 可以幫我地抄檔案或者目錄。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"--from\"}],\" 會幫我地由之前既 stage 既 file system 抄 \",[\"$\",\"code\",null,{\"children\":\"/javaruntime\"}],\" 裡面啲野去 \",[\"$\",\"code\",null,{\"children\":\"ubuntu\"}],\" 既 \",[\"$\",\"code\",null,{\"children\":\"/app/jre\"}],\" 裡面。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"如果冇 \",[\"$\",\"code\",null,{\"children\":\"--from\"}],\"，就會由本地既 working directory 抄入去。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"可以用 \",[\"$\",\"code\",null,{\"children\":\"--chown\"}],\" 順便做埋 \",[\"$\",\"code\",null,{\"children\":\"chown\"}],\"，將 owner、group 改做 \",[\"$\",\"code\",null,{\"children\":\"\u003cuser\u003e:\u003cgroup\u003e\"}],\"。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"可以用 \",[\"$\",\"code\",null,{\"children\":\"--chmod\"}],\" 順便做埋 \",[\"$\",\"code\",null,{\"children\":\"chmod\"}],\"，修改權限。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"例如將權限改做 \",[\"$\",\"code\",null,{\"children\":\"445\"}],\"，咁 owner、group 只可以 read，而 public（其他 users 或者 groups）只可以 read、execute。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"#\"}],\" 係用黎寫 comment，咁果句就唔會生效。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"我地可以用 \",[\"$\",\"code\",null,{\"children\":\"CMD\"}],\" 或者 \",[\"$\",\"code\",null,{\"children\":\"ENTRYPOINT\"}],\" instruction 黎話畀 Docker 知 Docker container 執行既時候應該行咩 commands。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"CMD\"}],\" 可以被覆蓋。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"ENTRYPOINT\"}],\" 唔可以被覆蓋，一定會執行。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"關於權限，我地既 OpenJDK、\",[\"$\",\"code\",null,{\"children\":\"app.jar\"}],\" 既 owner、group 都係 \",[\"$\",\"code\",null,{\"children\":\"root\"}],\"，但因為我地用左 \",[\"$\",\"code\",null,{\"children\":\"USER\"}],\" instruction 切換左做 \",[\"$\",\"code\",null,{\"children\":\"myuser\"}],\"，而呢個 user 屬於另一個叫 \",[\"$\",\"code\",null,{\"children\":\"mygroup\"}],\" 既 group，所以佢地需要開放權限畀 public，咁 \",[\"$\",\"code\",null,{\"children\":\"myuser\"}],\" 先可以用到佢地。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"myuser\"}],\" 需要 OpenJDK 既 read、execute 權限。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"myuser\"}],\" 需要 \",[\"$\",\"code\",null,{\"children\":\"app.jar\"}],\" 既 read 權限，唔需要 execute 權限係因為佢唔係直接執行 \",[\"$\",\"code\",null,{\"children\":\"app.jar\"}],\"，而係透過 OpenJDK 裡面既 \",[\"$\",\"code\",null,{\"children\":\"java\"}],\"。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h1\",null,{\"children\":\"3 執行\"}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"3.1 Docker Desktop\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-bash\",\"children\":\"docker container run --rm -p 8080:8080 spring-boot-3-docker-test\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Read-only file system 模式：\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-bash\",\"children\":\"docker container run --rm -p 8080:8080 --read-only spring-boot-3-docker-test\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"註：\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"用左 \",[\"$\",\"code\",null,{\"children\":\"--read-only\"}],\" 既話，一定要令到 \",[\"$\",\"code\",null,{\"children\":\"/tmp\"}],\" 有 volume mount，從而令 \",[\"$\",\"code\",null,{\"children\":\"/tmp\"}],\" 可以寫入。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"否則，如果 Spring Boot 既 embedded Tomcat 喺 runtime 既時候創建唔到目錄或者寫入唔到落 temp folder 既話，就會令成個 Spring Boot microservice 啟動失敗。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"用 Docker Desktop 既話可以利用 Dockerfile 既 \",[\"$\",\"code\",null,{\"children\":\"VOLUME /tmp\"}],\" instruction。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"3.2 Kubernetes\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"我地可以開啟 Docker Desktop 內置既 Kubernetes 功能，或者用某個 cloud provider 既 Kubernetes 服務。\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"關於 \",[\"$\",\"code\",null,{\"children\":\"kubectl\"}],\" CLI 既 commands 可以睇返呢篇：\",[\"$\",\"a\",null,{\"href\":\"/blog/kubectl-basics\",\"children\":\"kubectl 基本操作\"}],\"。\"]}],\"\\n\",[\"$\",\"h3\",null,{\"children\":[\"3.2.1 單獨 \",[\"$\",\"code\",null,{\"children\":\"Pod\"}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"k8s-pod.yml\"}],\"：\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-yaml\",\"children\":\"$11\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"保存左個檔案之後執行：\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-bash\",\"children\":\"kubectl apply -f k8s-pod.yml\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"之後 port-forward 個 K8s \",[\"$\",\"code\",null,{\"children\":\"Pod\"}],\"：\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-bash\",\"children\":\"kubectl port-forward spring-boot-3-docker-test 8080\\n\"}]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h3\",null,{\"children\":[\"3.2.2 \",[\"$\",\"code\",null,{\"children\":\"Deployment\"}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"k8s-deployment.yml\"}],\"：\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-yaml\",\"children\":\"$12\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"保存左個檔案之後執行：\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-bash\",\"children\":\"kubectl apply -f k8s-deployment.yml\\n\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"之後 port-forward 個 K8s \",[\"$\",\"code\",null,{\"children\":\"Deployment\"}],\"：\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-bash\",\"children\":\"kubectl port-forward deployment/spring-boot-3-docker-test-deployment 8080\\n\"}]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"3.3 測試\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"可以檢查下 Spring Boot Actuator 既 HTTP REST endpoints：\"}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-bash\",\"children\":\"curl http://localhost:8080/actuator/health\\r\\ncurl http://localhost:8080/actuator/health/liveness\\r\\ncurl http://localhost:8080/actuator/health/readiness\\r\\ncurl http://localhost:8080/actuator/info\\r\\ncurl http://localhost:8080/actuator/env\\r\\ncurl http://localhost:8080/actuator/beans\\r\\ncurl http://localhost:8080/actuator/loggers\\n\"}]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"3.4 詳細解釋\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Spring Boot 本身具備 cloud awareness。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"喺呢個測試項目裡面，我地用左 Spring Boot Actuator，而個 Spring Boot microservice 又喺 Kubernetes 上面運行。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Spring Boot 會 check 到有 \",[\"$\",\"code\",null,{\"children\":\"KUBERNETES_SERVICE_HOST\"}],\"、\",[\"$\",\"code\",null,{\"children\":\"KUBERNETES_SERVICE_PORT\"}],\" 呢兩個 environment variables。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"所以 Spring Boot 就知道佢而家喺 Kubernetes 上面行緊，就會自動 expose \",[\"$\",\"code\",null,{\"children\":\"/actuator/health/liveness\"}],\"、\",[\"$\",\"code\",null,{\"children\":\"/actuator/health/readiness\"}],\" 呢兩個 HTTP REST endpoints。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"我地配置 Kubernetes 既 \",[\"$\",\"code\",null,{\"children\":\"terminationGracePeriodSeconds\"}],\" 秒數唔應該少過我地配置既 Spring Boot graceful shutdown 既 \",[\"$\",\"code\",null,{\"children\":\"spring.lifecycle.timeout-per-shutdown-phase\"}],\" 配置時限。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Spring Boot 默認係會即時 shutdown，無視未完成既 HTTP requests。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"我地當然唔想有 HTTP requests 突然被中斷，所以我地要指示 Spring Boot 用 graceful shutdown 方式，並且將 shutdown timeout 設置到一個合理既數值。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"將 \",[\"$\",\"code\",null,{\"children\":\"server.shutdown\"}],\" 設置做 \",[\"$\",\"code\",null,{\"children\":\"graceful\"}],\"。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"spring.lifecycle.timeout-per-shutdown-phase\"}],\" 既默認值係 \",[\"$\",\"code\",null,{\"children\":\"30\"}],\" 秒。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"設置好之後，Spring Boot 會等到當時未完成既 HTTP requests 都完成曬或者到左 shutdown timeout 既時限先至 shutdown。\"}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Kubernetes 都有默認 \",[\"$\",\"code\",null,{\"children\":\"30\"}],\" 秒既 \",[\"$\",\"code\",null,{\"children\":\"terminationGracePeriodSeconds\"}],\" 配置。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"如果我地有配置到比 \",[\"$\",\"code\",null,{\"children\":\"30\"}],\" 秒長既 Spring Boot shutdown timeout，咁我地都要配置埋 Kubernetes 果個。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"例子／測試方法\",\"\\n\",[\"$\",\"ol\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"我地既 Spring Boot microservice 可以 expose 一個會 \",[\"$\",\"code\",null,{\"children\":\"Thread.sleep(100_000)\"}],\"（暫停 \",[\"$\",\"code\",null,{\"children\":\"100\"}],\" 秒）既 HTTP REST endpoint。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"然後設置 Spring Boot graceful shutdown、shutdown timeout 做 \",[\"$\",\"code\",null,{\"children\":\"120\"}],\" 秒。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"重新 build 個 Spring Boot Docker image。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"然後喺部署 Kubernetes 既 YAML 配置檔度設置 termination grace period 做 \",[\"$\",\"code\",null,{\"children\":\"120\"}],\" 秒。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"用 \",[\"$\",\"code\",null,{\"children\":\"kubectl apply\"}],\" 部署個 Spring Boot microservice 既 K8s \",[\"$\",\"code\",null,{\"children\":\"Deployment\"}],\"。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"我地 port-forward 其中一個 \",[\"$\",\"code\",null,{\"children\":\"Pod\"}],\"，然後用 Postman 或者 Bruno 去 call 個新 endpoint。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"我地即刻執行 \",[\"$\",\"code\",null,{\"children\":\"kubectl rollout restart deployment spring-boot-3-docker-test-deployment\"}],\"。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"我地會見到 Postman 或者 Bruno 可以執行個 HTTP request 長達 \",[\"$\",\"code\",null,{\"children\":\"120\"}],\" 秒，到成功返回 HTTP response 之後 Kubernetes 先會結束個 \",[\"$\",\"code\",null,{\"children\":\"Pod\"}],\"，然後用新既去取代佢。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Kubernetes 提供左唔同既 probes 配置去驗證個 \",[\"$\",\"code\",null,{\"children\":\"Pod\"}],\" 到底正唔正常。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"佢可以持續咁自動 call 個 \",[\"$\",\"code\",null,{\"children\":\"Pod\"}],\" 既一啲 HTTP endpoints。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"成功既定義係 HTTP response status code 要係 \",[\"$\",\"code\",null,{\"children\":\"200\"}],\" 至 \",[\"$\",\"code\",null,{\"children\":\"399\"}],\"。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Probes\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"如果 startup probe 既 HTTP endpoint fail 左，Kubernetes 就會回收個 \",[\"$\",\"code\",null,{\"children\":\"Pod\"}],\"。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"如果 liveness probe 既 HTTP endpoint fail 左，Kubernetes 就會回收個 \",[\"$\",\"code\",null,{\"children\":\"Pod\"}],\"。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"如果 readiness probe 既 HTTP endpoint fail 左，Kubernetes 就會唔畀 traffic 去呢個 \",[\"$\",\"code\",null,{\"children\":\"Pod\"}],\" 度。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"initialDelaySeconds\"}],\" 係初始化既時候，Kubernetes 應該等幾耐先開始驗證。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"periodSeconds\"}],\" 係初始化完成之後，Kubernetes 每隔幾耐需要驗證。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"failureThreshold\"}],\" 可以允許幾次失敗。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Spring Boot Actuator 提供左對應 Kubernetes liveness、readiness probes 既 HTTP REST endpoints。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"/actuator/health/liveness\"}],\" 可以用落 Kubernetes 既 liveness probe。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"children\":\"/actuator/health/readiness\"}],\" 可以用落 Kubernetes 既 readiness probe。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"呢個 endpoint 返回 HTTP response status code \",[\"$\",\"code\",null,{\"children\":\"200\"}],\" 既話，即係表示個 HTTP server 已經準備好接受 HTTP requests。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"Liveness endpoint 返回正面既結果，唔代表 readiness endpoint 會返回正面既結果，因為個 HTTP server 未必準備好接受 HTTP requests。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"如果 readiness endpoint 返回正面既結果，咁 liveness endpoint 都應該返回正面既結果。\"}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Spring Boot Actuator 冇提供對應 Kubernetes startup probe 既 startup endpoint。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"有兩個解決方法：\",\"\\n\",[\"$\",\"ol\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"我地可以用返 Spring Boot Actuator 既 liveness endpoint 作為 Kubernetes startup probe，然後配置一個好大既 \",[\"$\",\"code\",null,{\"children\":\"failureThreshold\"}],\"，例如 \",[\"$\",\"code\",null,{\"children\":\"30\"}],\" 次，配合短既 \",[\"$\",\"code\",null,{\"children\":\"periodSeconds\"}],\"，例如 \",[\"$\",\"code\",null,{\"children\":\"5\"}],\" 秒（即係最長 \",[\"$\",\"code\",null,{\"children\":\"2.5\"}],\" 分鐘）。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"呢個做法等於延續 Kubernetes liveness probe 既驗證時間。\"}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"我地可以為 Kubernetes liveness、readiness probes 配置一個好大既 \",[\"$\",\"code\",null,{\"children\":\"initialDelaySeconds\"}],\"，例如 \",[\"$\",\"code\",null,{\"children\":\"180\"}],\" 秒，但呢個時間係固定既，時間越長就越會增加 scaling 既成本。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"我地可以用 K8s \",[\"$\",\"code\",null,{\"children\":\"Deployment\"}],\" 既 \",[\"$\",\"code\",null,{\"children\":\"replicas\"}],\" 配置黎定義需要既 \",[\"$\",\"code\",null,{\"children\":\"Pod\"}],\" 數量。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"用呢個方法得到既 \",[\"$\",\"code\",null,{\"children\":\"Pod\"}],\" 數量係固定既，唔會因應 \",[\"$\",\"code\",null,{\"children\":\"Pod\"}],\" container 既 CPU、memory 情況而自動增加減少。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"比較好既做法係用 K8s \",[\"$\",\"code\",null,{\"children\":\"HorizontalPodAutoscaler\"}],\"。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Kubernetes 會幫我地管理 \",[\"$\",\"code\",null,{\"children\":\"Pod\"}],\"，盡可能保持我地要求既 \",[\"$\",\"code\",null,{\"children\":\"Pod\"}],\" 數量。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Kubernetes 會幫我地自動創建一個 K8s \",[\"$\",\"code\",null,{\"children\":\"ReplicaSet\"}],\"。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"3.5 注意事項\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"設置左 \",[\"$\",\"code\",null,{\"children\":\"readOnlyRootFilesystem\"}],\" 做 \",[\"$\",\"code\",null,{\"children\":\"true\"}],\" 既話，一定要令到 \",[\"$\",\"code\",null,{\"children\":\"/tmp\"}],\" 有 volume mount，從而令 \",[\"$\",\"code\",null,{\"children\":\"/tmp\"}],\" 可以寫入。\",\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"否則，如果 Spring Boot 既 embedded Tomcat 喺 runtime 既時候創建唔到目錄或者寫入唔到落 temp folder 既話，就會令成個 Spring Boot microservice 啟動失敗。\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"用 Docker Desktop 既 Kubernetes 既話，有兩個方法：\",\"\\n\",[\"$\",\"ol\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"用 Kubernetes 正路既 \",[\"$\",\"code\",null,{\"children\":\"emptyDir\"}],\" 方法。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Dockerfile 用 \",[\"$\",\"code\",null,{\"children\":\"VOLUME /tmp\"}],\" instruction。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"用 cloud 既 Kubernetes 既話，有兩個方法：\",\"\\n\",[\"$\",\"ol\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"用 Kubernetes 正路既 \",[\"$\",\"code\",null,{\"children\":\"emptyDir\"}],\" 方法。\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Dockerfile 用 \",[\"$\",\"code\",null,{\"children\":\"VOLUME /tmp\"}],\" instruction，但 containerd 既 \",[\"$\",\"code\",null,{\"children\":\"ignore_image_defined_volumes\"}],\" 一定要配合佢而設置做 \",[\"$\",\"code\",null,{\"children\":\"false\"}],\"。\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h1\",null,{\"children\":\"4 附錄\"}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"4.1 Snyk Java Dockerfile best practices\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"img\",null,{\"src\":\"/blog/2024-03/spring-boot-dockerfile/snyk-best-practices.png\",\"alt\":\"\"}]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h2\",null,{\"children\":\"4.2 Kubernetes pod lifecycle\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"$\",\"img\",null,{\"src\":\"/blog/2024-03/spring-boot-dockerfile/k8s-probes.jpg\",\"alt\":\"\"}]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h2\",null,{\"children\":[\"4.3 Read-only file system \",[\"$\",\"code\",null,{\"children\":\"/tmp\"}],\" 寫入問題\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"以下係如果我地冇整好 volume mount 落 \",[\"$\",\"code\",null,{\"children\":\"/tmp\"}],\" 會造成既 startup error：\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"language-plaintext\",\"children\":\"$13\"}]}],\"\\n\",[\"$\",\"hr\",null,{}],\"\\n\",[\"$\",\"h1\",null,{\"children\":\"5 參考資料\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://docs.docker.com/reference/dockerfile/\",\"children\":\"Docker 官網 - Dockerfile reference\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://docs.docker.com/build/building/multi-stage/\",\"children\":\"Docker 官網 - Multi-stage builds\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://snyk.io/blog/best-practices-to-build-java-containers-with-docker/\",\"children\":\"Snyk - 10 best practices to build a Java container with Docker\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://learn.microsoft.com/en-us/java/openjdk/containers#create-a-custom-java-runtime\",\"children\":\"Microsoft 官方文檔 - Container images for the Microsoft Build of OpenJDK - Create a custom Java runtime\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints.kubernetes-probes.lifecycle\",\"children\":\"Spring Boot 官方文檔 - Production-ready Features - 2.10.2. Application Lifecycle and Probe States\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://andrewlock.net/deploying-asp-net-core-applications-to-kubernetes-part-6-adding-health-checks-with-liveness-readiness-and-startup-probes/\",\"children\":\"Adding health checks with Liveness, Readiness, and Startup probes\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/\",\"children\":\"Kubernetes 官方文檔 - Configure Liveness, Readiness and Startup Probes\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://kubernetes.io/docs/concepts/storage/volumes/#emptydir\",\"children\":\"Kubernetes 官方文檔 - Volumes - emptyDir\"}]}],\"\\n\"]}]],null,[\"$\",\"$L14\",null,{\"children\":\"$L15\"}]]}],{},null,false]},null,false]},null,false]},null,false]},null,false],[\"$\",\"$1\",\"h\",{\"children\":[null,[\"$\",\"$1\",\"VS_L_4h4pnYjZgvozTU_8\",{\"children\":[[\"$\",\"$L16\",null,{\"children\":\"$L17\"}],[\"$\",\"$L18\",null,{\"children\":\"$L19\"}],null]}]]}],false]],\"m\":\"$undefined\",\"G\":[\"$1a\",\"$undefined\"],\"s\":false,\"S\":true}\n"])</script><script>self.__next_f.push([1,"19:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\n17:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"Michael Chung's e-Portfolio\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"Powered by Next.js and React\"}]]\n"])</script><script>self.__next_f.push([1,"15:null\n"])</script></body></html>